<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QFC Group Pvt Ltd - Group Seat Platform</title>
    <link rel="icon" type="image/png" href="QFClogo.png">	
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Add Papa Parse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
    /* ========== GLOBAL STYLES ========== */
    body { 
        background-color: #f8f9fa; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding-bottom: 50px;
    }
    
    /* ========== NAVBAR ========== */
    .navbar-brand { 
        font-weight: bold; 
        color: #0d6efd !important; 
        font-size: 1.3rem;
    }
    .navbar {
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 0.8rem 0;
    }
    
    /* ========== CARDS ========== */
    .card { 
        border-radius: 12px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        margin-bottom: 24px;
        border: 1px solid #e9ecef;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
        font-weight: 600;
    }
    
    /* ========== FORM ELEMENTS ========== */
    .form-control, .form-select { 
        border-radius: 8px; 
        padding: 10px 14px;
        border: 1px solid #ced4da;
        transition: all 0.2s;
    }
    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }
    .form-label {
        font-weight: 500;
        margin-bottom: 6px;
        color: #495057;
    }
    
    /* ========== BUTTONS ========== */
    .btn-primary { 
        background-color: #1a365d;
        border-color: #1a365d;
        padding: 10px 24px; 
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s;
    }
    .btn-primary:hover {
        background-color: #2d4a8c;
        border-color: #2d4a8c;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
    }
    .btn-outline-secondary {
        border: 2px solid #6c757d;
        font-weight: 500;
    }
    .btn-outline-warning {
        border: 2px solid #ffc107;
        font-weight: 500;
    }
    .btn-outline-success {
        border: 2px solid #198754;
        font-weight: 500;
        color: #198754;
    }
    .btn-outline-success:hover {
        background-color: #198754;
        color: white;
    }
    .btn-lg {
        padding: 12px 28px;
        font-size: 1.1rem;
    }
    
    /* ========== ACTION BUTTONS ========== */
    .btn-group-sm > .btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.85rem;
        border-radius: 6px;
    }
    .btn-outline-primary {
        border-color: #0d6efd;
        color: #0d6efd;
    }
    .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(13, 110, 253, 0.2);
    }
    .btn-outline-danger {
        border-color: #dc3545;
        color: #dc3545;
    }
    .btn-outline-danger:hover {
        background-color: #dc3545;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(220, 53, 69, 0.2);
    }
    
    /* ========== STATUS BADGES ========== */
    .status-badge { 
        padding: 5px 12px; 
        border-radius: 20px; 
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
        min-width: 80px;
        text-align: center;
    }
    .status-draft { 
        background-color: #fff3cd; 
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    .status-approved { 
        background-color: #d1e7dd; 
        color: #0f5132;
        border: 1px solid #badbcc;
    }
    .status-pending { 
        background-color: #cff4fc; 
        color: #055160;
        border: 1px solid #b6effb;
    }
    
    /* ========== TABLE STYLING ========== */
    .table {
        margin-bottom: 0;
    }
    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        padding: 1rem;
        white-space: nowrap;
    }
    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-top: 1px solid #e9ecef;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    .table-warning {
        background-color: rgba(255, 193, 7, 0.1) !important;
        border-left: 4px solid #ffc107;
    }
    
    /* ========== TABS ========== */
    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 0;
    }
    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 0.8rem 1.5rem;
        margin-bottom: -2px;
        border-radius: 8px 8px 0 0;
    }
    .nav-tabs .nav-link:hover {
        color: #0d6efd;
        background-color: #f8f9fa;
    }
    .nav-tabs .nav-link.active { 
        background-color: #fff; 
        border: 2px solid #dee2e6;
        border-bottom-color: #fff;
        color: #0d6efd;
        font-weight: 600;
    }
    .tab-content { 
        border: 2px solid #dee2e6; 
        border-top: none; 
        padding: 24px;
        background-color: white;
        border-radius: 0 0 8px 8px;
    }
    
    /* ========== DASHBOARD CARDS ========== */
    .dashboard-card {
        border-radius: 10px;
        color: white;
        padding: 1.5rem;
        height: 100%;
        transition: transform 0.3s;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
    }
    .dashboard-card i {
        font-size: 2rem;
        margin-bottom: 10px;
        opacity: 0.9;
    }
    .dashboard-card h5 {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 5px;
    }
    .dashboard-card h2 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0;
    }
    
    /* ========== BADGES ========== */
    .badge {
        padding: 0.35em 0.65em;
        font-weight: 500;
        border-radius: 10px;
    }
    .bg-success-light {
        background-color: rgba(25, 135, 84, 0.1);
        color: #198754;
    }
    .bg-secondary-light {
        background-color: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }
    
    /* ========== TOAST NOTIFICATIONS ========== */
    .toast {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: none;
    }
    .toast-header {
        border-radius: 8px 8px 0 0;
        font-weight: 600;
    }
    
    /* ========== FLIGHT SPECIFIC STYLES ========== */
    .flight-times {
        background-color: #f8f9fa;
        padding: 8px 12px;
        border-radius: 8px;
        border-left: 3px solid #1a365d;
        margin-bottom: 1rem;
    }
    .flight-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 1rem;
    }
    .flight-field {
        background: #f8f9fa;
        padding: 8px;
        border-radius: 6px;
    }
    .flight-field label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 3px;
    }
    .flight-field .value {
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    /* ========== UPLOAD MODAL STYLES ========== */
    .upload-area {
        border: 2px dashed #1a365d;
        border-radius: 10px;
        padding: 40px 20px;
        text-align: center;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
    }
    .upload-area:hover {
        background-color: #e9ecef;
        border-color: #2d4a8c;
    }
    .upload-area.dragover {
        background-color: #e7f1ff;
        border-color: #0d6efd;
    }
    .file-preview {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        background: white;
    }
    .preview-table {
        font-size: 0.85rem;
    }
    .preview-table th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
    }
    
    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .container {
            padding-left: 15px;
            padding-right: 15px;
        }
        .btn-lg {
            padding: 10px 20px;
            font-size: 1rem;
        }
        .nav-tabs .nav-link {
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
        }
        .table-responsive {
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .flight-info-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* ========== QFC BRANDING ========== */
    .qfc-brand {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-weight: 700;
        color: #1a365d;
    }
    .qfc-subtitle {
        font-size: 10px;
        color: #6c757d;
        letter-spacing: 0.5px;
        font-weight: 400;
    }
    .card-header.bg-light {
        border-left: 4px solid #1a365d;
    }
    .bg-primary { background-color: #1a365d !important; }
    .bg-success { background-color: #2e8b57 !important; }
    .bg-info { background-color: #17a2b8 !important; }
    .bg-warning { background-color: #ffc107 !important; }
    
    /* Required field indicator */
    .required::after {
        content: " *";
        color: #dc3545;
    }
    
    /* Loading spinner */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.2em;
    }
    
    /* Date format helper */
    .format-hint {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 3px;
    }
    
    /* Time input formatting */
    .time-format-example {
        font-size: 0.8rem;
        color: #28a745;
        font-family: monospace;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 5px;
    }
    
    /* Import/Export buttons */
    .import-export-buttons {
        position: absolute;
        right: 20px;
        top: 20px;
    }
    
    /* Import options */
    .import-options {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }
    
    /* Flight segments */
    .flight-segment {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border-left: 4px solid #1a365d;
    }
    .flight-segment h6 {
        color: #1a365d;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid #dee2e6;
    }
    .segment-toggle {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    .segment-toggle .btn {
        flex: 1;
    }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="QFClogo.png" alt="QFC Logo" height="30" class="me-2">
                <div class="d-inline-block">
                    <div class="qfc-brand">QFC Group Pvt Ltd</div>
                    <div class="qfc-subtitle">Group Seat Platform</div>
                </div>
            </a>
            
            <!-- Mobile toggle button -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Navigation Links -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html">
                            <i class="bi bi-house-door me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="groups.html">
                            <i class="bi bi-people me-1"></i>Flight Groups
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#acquireForm">
                            <i class="bi bi-plus-circle me-1"></i>Acquire Seats
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear me-1"></i>More
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="sell-seats.html">
                                <i class="bi bi-cart-plus me-2"></i>Sell Seats
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="reports.html">
                                <i class="bi bi-bar-chart me-2"></i>Reports
                            </a></li>
                            <li><a class="dropdown-item" href="#">
                                <i class="bi bi-person-circle me-2"></i>Agents
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-people-fill"></i> Total Seats</h5>
                        <h2 id="totalSeats">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-cash-stack"></i> Investment</h5>
                        <h2 id="totalRevenue">0.00</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-file-text"></i> Acquisitions</h5>
                        <h2 id="totalAcquisitions">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-clock-history"></i> Pending</h5>
                        <h2 id="pendingItems">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acquire Seats Form -->
        <div class="card" id="acquireForm">
            <div class="card-header bg-light position-relative">
                <h4 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Acquire Seats Form</h4>
                <div class="import-export-buttons">
                    <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#importModal">
                        <i class="bi bi-upload me-1"></i>Import Data
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm ms-2" onclick="exportTemplate()">
                        <i class="bi bi-download me-1"></i>Download Template
                    </button>
                </div>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="formTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">Basic Info</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="flight-tab" data-bs-toggle="tab" data-bs-target="#flight" type="button" role="tab">Flight Details</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial" type="button" role="tab">Financial</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="emd-tab" data-bs-toggle="tab" data-bs-target="#emd" type="button" role="tab">EMD Details</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ticketing-tab" data-bs-toggle="tab" data-bs-target="#ticketing" type="button" role="tab">Ticketing</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="formTabsContent">
                    <!-- Basic Info Tab -->
                    <div class="tab-pane fade show active" id="basic" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">SR Number</label>
                                    <input type="text" class="form-control" id="srNumber" readonly>
                                    <small class="text-muted">Auto-generated by system</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Original SR Number (If Imported)</label>
                                    <input type="text" class="form-control" id="originalSrNumber" placeholder="Original reference number from imported data">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Request Date</label>
                                    <input type="date" class="form-control" id="requestDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Investment Type</label>
                                    <select class="form-select" id="investmentType">
                                        <option value="Company Investment">Company Investment</option>
                                        <option value="Agent Investment">Agent Investment</option>
                                        <option value="block_space">Block Space</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">License/IATA</label>
                                    <select class="form-select" id="license">
                                        <option value="QFC">QFC</option>
                                        <option value="FCT">FCT</option>
                                        <option value="AG">AG</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Branch</label>
                                    <select class="form-select" id="branch">
                                        <option value="HO">HO</option>
                                        <option value="LHE">LHE</option>
                                        <option value="SKT">SKT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label required">Airline PNR</label>
                                    <input type="text" class="form-control" id="airlinePnr" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">GDS PNR</label>
                                    <input type="text" class="form-control" id="gdsPnr">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Segment</label>
                                    <select class="form-select" id="segment">
                                        <option value="Umrah">Umrah</option>
                                        <option value="Employment">Employment</option>
                                        <option value="Hajj">Hajj</option>
                                        <option value="Tours">Tours</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">Airline</label>
                                    <select class="form-select" id="airline" required>
                                        <option value="">Select Airline</option>
                                        <option value="SV">Saudi Airlines (SV)</option>
                                        <option value="PA">Airblue (PA)</option>
                                        <option value="PK">Pakistan Airlines (PK)</option>
                                        <option value="EK">Emirates (EK)</option>
                                        <option value="F3">Flyadeal (F3)</option>
                                        <option value="PF">Palestine Airlines (PF)</option>
                                        <option value="9P">PIA (9P)</option>
                                        <option value="J9">Jazeera Airways (J9)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">No. of Seats</label>
                                    <input type="number" class="form-control" id="noOfSeats" required min="1">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Sector</label>
                                    <input type="text" class="form-control" id="sector" placeholder="e.g., ISB-JED">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Flight Details Tab -->
                    <div class="tab-pane fade" id="flight" role="tabpanel">
                        <div class="segment-toggle">
                            <button type="button" class="btn btn-outline-primary active" id="twoSegmentBtn" onclick="toggleFlightSegments(2)">
                                <i class="bi bi-airplane me-2"></i>2 Segments (e.g., SV)
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="fourSegmentBtn" onclick="toggleFlightSegments(4)">
                                <i class="bi bi-airplane-engines me-2"></i>4 Segments (e.g., EK)
                            </button>
                        </div>
                        
                        <!-- 2 Segment Layout (Default) -->
                        <div id="twoSegmentLayout">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="flight-segment">
                                        <h6><i class="bi bi-airplane-takeoff me-2"></i>Outbound Flight</h6>
                                        <div class="flight-info-grid">
                                            <div class="flight-field">
                                                <label class="form-label">Flight Date</label>
                                                <input type="date" class="form-control segment-field" id="outboundDate">
                                                <div class="format-hint">Will be stored as: 01-MAR-26</div>
                                            </div>
                                            <div class="flight-field">
                                                <label class="form-label">Flight Number</label>
                                                <input type="text" class="form-control segment-field" id="outboundFlight" 
                                                       placeholder="e.g., SV723">
                                            </div>
                                            <div class="flight-field" style="grid-column: span 2;">
                                                <label class="form-label">Departure & Arrival Times</label>
                                                <input type="text" class="form-control segment-field" id="outboundTimes" 
                                                       placeholder="e.g., ISB 0700 JED 1100">
                                                <div class="format-hint">Format: [Departure Airport] [Time] [Arrival Airport] [Time]</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="flight-segment">
                                        <h6><i class="bi bi-airplane-landing me-2"></i>Inbound Flight</h6>
                                        <div class="flight-info-grid">
                                            <div class="flight-field">
                                                <label class="form-label">Flight Date</label>
                                                <input type="date" class="form-control segment-field" id="inboundDate">
                                                <div class="format-hint">Will be stored as: 15-MAR-26</div>
                                            </div>
                                            <div class="flight-field">
                                                <label class="form-label">Flight Number</label>
                                                <input type="text" class="form-control segment-field" id="inboundFlight" 
                                                       placeholder="e.g., SV724">
                                            </div>
                                            <div class="flight-field" style="grid-column: span 2;">
                                                <label class="form-label">Departure & Arrival Times</label>
                                                <input type="text" class="form-control segment-field" id="inboundTimes" 
                                                       placeholder="e.g., JED 0200 ISB 0500">
                                                <div class="format-hint">Format: [Departure Airport] [Time] [Arrival Airport] [Time]</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 4 Segment Layout (Hidden by default) -->
                        <div id="fourSegmentLayout" style="display: none;">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="flight-segment">
                                        <h6><i class="bi bi-airplane-takeoff me-2"></i>Outbound Segment 1</h6>
                                        <div class="flight-info-grid">
                                            <div class="flight-field">
                                                <label class="form-label">Flight Date</label>
                                                <input type="date" class="form-control segment-field" id="outbound1Date">
                                                <div class="format-hint">Will be stored as: 01-MAR-26</div>
                                            </div>
                                            <div class="flight-field">
                                                <label class="form-label">Flight Number</label>
                                                <input type="text" class="form-control segment-field" id="outbound1Flight" 
                                                       placeholder="e.g., EK615">
                                            </div>
                                            <div class="flight-field" style="grid-column: span 2;">
                                                <label class="form-label">Departure & Arrival Times</label>
                                                <input type="text" class="form-control segment-field" id="outbound1Times" 
                                                       placeholder="e.g., ISB 0800 DXB 1100">
                                                <div class="format-hint">Format: [Departure Airport] [Time] [Arrival Airport] [Time]</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="flight-segment">
                                        <h6><i class="bi bi-airplane me-2"></i>Outbound Segment 2</h6>
                                        <div class="flight-info-grid">
                                            <div class="flight-field">
                                                <label class="form-label">Flight Date</label>
                                                <input type="date" class="form-control segment-field" id="outbound2Date">
                                                <div class="format-hint">Will be stored as: 01-MAR-26</div>
                                            </div>
                                            <div class="flight-field">
                                                <label class="form-label">Flight Number</label>
                                                <input type="text" class="form-control segment-field" id="outbound2Flight" 
                                                       placeholder="e.g., EK815">
                                            </div>
                                            <div class="flight-field" style="grid-column: span 2;">
                                                <label class="form-label">Departure & Arrival Times</label>
                                                <input type="text" class="form-control segment-field" id="outbound2Times" 
                                                       placeholder="e.g., DXB 1300 JED 1500">
                                                <div class="format-hint">Format: [Departure Airport] [Time] [Arrival Airport] [Time]</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="flight-segment">
                                        <h6><i class="bi bi-airplane me-2"></i>Inbound Segment 1</h6>
                                        <div class="flight-info-grid">
                                            <div class="flight-field">
                                                <label class="form-label">Flight Date</label>
                                                <input type="date" class="form-control segment-field" id="inbound1Date">
                                                <div class="format-hint">Will be stored as: 15-MAR-26</div>
                                            </div>
                                            <div class="flight-field">
                                                <label class="form-label">Flight Number</label>
                                                <input type="text" class="form-control segment-field" id="inbound1Flight" 
                                                       placeholder="e.g., EK816">
                                            </div>
                                            <div class="flight-field" style="grid-column: span 2;">
                                                <label class="form-label">Departure & Arrival Times</label>
                                                <input type="text" class="form-control segment-field" id="inbound1Times" 
                                                       placeholder="e.g., JED 0200 DXB 0500">
                                                <div class="format-hint">Format: [Departure Airport] [Time] [Arrival Airport] [Time]</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="flight-segment">
                                        <h6><i class="bi bi-airplane-landing me-2"></i>Inbound Segment 2</h6>
                                        <div class="flight-info-grid">
                                            <div class="flight-field">
                                                <label class="form-label">Flight Date</label>
                                                <input type="date" class="form-control segment-field" id="inbound2Date">
                                                <div class="format-hint">Will be stored as: 15-MAR-26</div>
                                            </div>
                                            <div class="flight-field">
                                                <label class="form-label">Flight Number</label>
                                                <input type="text" class="form-control segment-field" id="inbound2Flight" 
                                                       placeholder="e.g., EK614">
                                            </div>
                                            <div class="flight-field" style="grid-column: span 2;">
                                                <label class="form-label">Departure & Arrival Times</label>
                                                <input type="text" class="form-control segment-field" id="inbound2Times" 
                                                       placeholder="e.g., DXB 0700 ISB 1000">
                                                <div class="format-hint">Format: [Departure Airport] [Time] [Arrival Airport] [Time]</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Note:</strong> 
                            <ul class="mb-0 mt-2">
                                <li>Use <strong>2 Segments</strong> for direct flights (e.g., SV, PA, PK)</li>
                                <li>Use <strong>4 Segments</strong> for flights with connections (e.g., EK via DXB)</li>
                                <li>Dates will be automatically stored as 01-MAR-26 format</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Financial Tab -->
                    <div class="tab-pane fade" id="financial" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label required">Fare</label>
                                    <input type="number" class="form-control" id="fare" step="0.01" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Taxes</label>
                                    <input type="number" class="form-control" id="taxes" step="0.01">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Payable Amount</label>
                                    <input type="number" class="form-control" id="payableAmount" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">PNR Amount</label>
                                    <input type="number" class="form-control" id="pnrAmount" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Issuance Date</label>
                                    <input type="date" class="form-control" id="issuanceDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">Time Limit</label>
                                    <input type="date" class="form-control" id="timeLimit" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Payment %</label>
                                    <input type="number" class="form-control" id="paymentPercentage" value="100" min="0" max="100">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- EMD Details Tab -->
                    <div class="tab-pane fade" id="emd" role="tabpanel">
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5>1st EMD Details</h5>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Number</label>
                                    <input type="text" class="form-control" id="emd1Number">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Amount</label>
                                    <input type="number" class="form-control" id="emd1Amount" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="emd1Status">
                                        <option value="">Select</option>
                                        <option value="paid">Paid</option>
                                        <option value="pending">Pending</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Time Limit</label>
                                    <input type="date" class="form-control" id="emd1TimeLimit">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Issuance Date</label>
                                    <input type="date" class="form-control" id="emd1IssuanceDate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Payment %</label>
                                    <input type="number" class="form-control" id="emd1PaymentPercent" min="0" max="100">
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <h5>2nd EMD Details</h5>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Number</label>
                                    <input type="text" class="form-control" id="emd2Number">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Amount</label>
                                    <input type="number" class="form-control" id="emd2Amount" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Time Limit</label>
                                    <input type="date" class="form-control" id="emd2TimeLimit">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <h5>3rd EMD Details</h5>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Number</label>
                                    <input type="text" class="form-control" id="emd3Number">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Amount</label>
                                    <input type="number" class="form-control" id="emd3Amount" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Time Limit</label>
                                    <input type="date" class="form-control" id="emd3TimeLimit">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ticketing Tab -->
                    <div class="tab-pane fade" id="ticketing" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">EMD Refund Date</label>
                                    <input type="date" class="form-control" id="emdRefundDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Ticketing Status</label>
                                    <select class="form-select" id="ticketingStatus">
                                        <option value="pending">Pending</option>
                                        <option value="partial">Partial</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">No. of Tickets Issued</label>
                                    <input type="number" class="form-control" id="ticketsIssued" min="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Balance Tickets</label>
                                    <input type="number" class="form-control" id="balanceTickets" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Last Ticket Date</label>
                                    <input type="date" class="form-control" id="lastTicketDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="overallStatus">
                                        <option value="draft">Draft</option>
                                        <option value="submitted">Submitted</option>
                                        <option value="approved">Approved</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="mt-4">
                    <button type="button" class="btn btn-primary btn-lg" id="saveButton">
                        <i class="bi bi-save me-2"></i>Save Acquisition
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2" id="resetButton">
                        <i class="bi bi-arrow-clockwise me-2"></i>Reset Form
                    </button>
                    <button type="button" class="btn btn-outline-warning ms-2" id="cancelEditBtn" style="display: none;">
                        <i class="bi bi-x-circle me-2"></i>Cancel Edit
                    </button>
                </div>
            </div>
        </div>

        <!-- Recent Acquisitions Table -->
        <div class="card mt-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-table me-2"></i>Recent Acquisitions</h4>
                <span class="badge bg-primary" id="tableCount">0 records</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="15%">SR #</th>
                                <th width="15%">Airline PNR</th>
                                <th width="10%">Seats</th>
                                <th width="12%">Fare</th>
                                <th width="12%">Status</th>
                                <th width="15%">Date</th>
                                <th width="21%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="acquisitionsTable">
                            <!-- Data loaded by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="importModalLabel">
                        <i class="bi bi-upload me-2"></i>Import Previous Data
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note about SR Numbers:</strong> System will auto-generate new SR numbers for imported records. 
                        Original SR numbers from your file will be saved as reference in "Original SR Number" field.
                        <a href="#" onclick="exportTemplate()">Download template</a> for correct format.
                    </div>
                    
                    <div class="upload-area" id="dropArea">
                        <i class="bi bi-cloud-upload display-4 text-primary mb-3"></i>
                        <h5>Drag & Drop Files Here</h5>
                        <p class="text-muted">or click to browse</p>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                        <button type="button" class="btn btn-outline-primary mt-2" onclick="document.getElementById('fileInput').click()">
                            <i class="bi bi-folder2-open me-2"></i>Browse Files
                        </button>
                        <p class="text-muted mt-2 mb-0">Supports: CSV, Excel (.xlsx, .xls)</p>
                    </div>
                    
                    <div id="filePreview" class="file-preview" style="display: none;">
                        <h6>Preview (First 5 rows):</h6>
                        <div class="table-responsive">
                            <table class="table table-sm preview-table">
                                <thead id="previewHeader"></thead>
                                <tbody id="previewBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="import-options mt-3">
                        <h6>Import Options:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="autoFillForm" checked>
                                    <label class="form-check-label" for="autoFillForm">
                                        Auto-fill form with first record
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="saveToDatabase" checked>
                                    <label class="form-check-label" for="saveToDatabase">
                                        Save all records to database
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="srNumberOption" id="autoGenerateSR" checked>
                                    <label class="form-check-label" for="autoGenerateSR">
                                        Auto-generate new SR numbers
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="srNumberOption" id="keepOriginalSR">
                                    <label class="form-check-label" for="keepOriginalSR">
                                        Use original SR numbers from file
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="processImportBtn" disabled onclick="processImport()">
                        <i class="bi bi-play-circle me-2"></i>Process Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successMessage"></div>
        </div>
        <div id="errorToast" class="toast" role="alert">
            <div class="toast-header bg-danger text-white">
                <strong class="me-auto">Error!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="errorMessage"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <!-- JavaScript Code -->
    <script>
        // ========== GLOBAL VARIABLES ==========
        let importData = [];
        let currentFile = null;
        let acquisitions = [];
        let editingId = null;
        let supabaseClient = null;
        let currentSegments = 2;
        
        // ========== FLIGHT SEGMENT TOGGLE FUNCTION ==========
        function toggleFlightSegments(segments) {
            try {
                currentSegments = segments;
                const twoSegmentLayout = document.getElementById('twoSegmentLayout');
                const fourSegmentLayout = document.getElementById('fourSegmentLayout');
                const twoSegmentBtn = document.getElementById('twoSegmentBtn');
                const fourSegmentBtn = document.getElementById('fourSegmentBtn');
                
                if (!twoSegmentLayout || !fourSegmentLayout || !twoSegmentBtn || !fourSegmentBtn) return;
                
                if (segments === 2) {
                    twoSegmentLayout.style.display = 'block';
                    fourSegmentLayout.style.display = 'none';
                    twoSegmentBtn.classList.add('active');
                    fourSegmentBtn.classList.remove('active');
                } else {
                    twoSegmentLayout.style.display = 'none';
                    fourSegmentLayout.style.display = 'block';
                    twoSegmentBtn.classList.remove('active');
                    fourSegmentBtn.classList.add('active');
                }
            } catch (error) {
                console.error('Error in toggleFlightSegments:', error);
            }
        }
        
        // ========== HELPER FUNCTIONS ==========
        
        function convertDateToDisplayFormat(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                const day = String(date.getDate()).padStart(2, '0');
                const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                const month = monthNames[date.getMonth()];
                const year = String(date.getFullYear()).slice(-2);
                return `${day}-${month}-${year}`;
            } catch (error) {
                console.error('Error converting date:', error);
                return dateString;
            }
        }
        
        function convertDisplayToDateInput(dateString) {
            if (!dateString) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
            try {
                const parts = dateString.split('-');
                if (parts.length !== 3) return dateString;
                const day = parts[0];
                const monthStr = parts[1].toUpperCase();
                const year = parts[2];
                const fullYear = year.length === 2 ? '20' + year : year;
                const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                const monthIndex = monthNames.indexOf(monthStr);
                if (monthIndex === -1) return dateString;
                const month = String(monthIndex + 1).padStart(2, '0');
                return `${fullYear}-${month}-${day}`;
            } catch (error) {
                console.error('Error converting date for input:', error);
                return dateString;
            }
        }
        
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            try {
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
                if (/^\d{2}-[A-Z]{3}-\d{2}$/.test(dateString)) return convertDisplayToDateInput(dateString);
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) return date.toISOString().split('T')[0];
            } catch (error) {
                console.error('Error formatting date:', error);
            }
            return dateString;
        }
        
        function showSuccess(message) {
            const successToast = document.getElementById('successToast');
            const successMessage = document.getElementById('successMessage');
            if (successMessage) successMessage.textContent = message;
            if (successToast) new bootstrap.Toast(successToast).show();
        }
        
        function showError(message) {
            const errorToast = document.getElementById('errorToast');
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) errorMessage.textContent = message;
            if (errorToast) new bootstrap.Toast(errorToast).show();
        }
        
        function calculateAmounts() {
            try {
                const fareEl = document.getElementById('fare');
                const taxesEl = document.getElementById('taxes');
                const paymentEl = document.getElementById('paymentPercentage');
                const seatsEl = document.getElementById('noOfSeats');
                const pnrEl = document.getElementById('pnrAmount');
                const payableEl = document.getElementById('payableAmount');
                
                if (!fareEl || !taxesEl || !paymentEl || !seatsEl || !pnrEl || !payableEl) return;
                
                const fare = parseFloat(fareEl.value) || 0;
                const taxes = parseFloat(taxesEl.value) || 0;
                const percentage = parseFloat(paymentEl.value) || 100;
                const seats = parseInt(seatsEl.value) || 1;
                const totalPerSeat = fare + taxes;
                const totalPnrAmount = totalPerSeat * seats;
                const payable = totalPnrAmount * (percentage / 100);
                
                pnrEl.value = totalPnrAmount.toFixed(2);
                payableEl.value = payable.toFixed(2);
            } catch (error) {
                console.error('Error in calculateAmounts:', error);
            }
        }
        
        function calculateBalanceTickets() {
            try {
                const seatsEl = document.getElementById('noOfSeats');
                const issuedEl = document.getElementById('ticketsIssued');
                const balanceEl = document.getElementById('balanceTickets');
                
                if (!seatsEl || !issuedEl || !balanceEl) return;
                
                const totalSeats = parseInt(seatsEl.value) || 0;
                const issued = parseInt(issuedEl.value) || 0;
                const balance = totalSeats - issued;
                balanceEl.value = balance > 0 ? balance : 0;
            } catch (error) {
                console.error('Error in calculateBalanceTickets:', error);
            }
        }
        
        function generateSRNumber() {
            if (editingId) return;
            const srField = document.getElementById('srNumber');
            if (!srField) return;
            const date = new Date();
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            srField.value = `SR${year}${month}${day}${random}`;
        }
        
        function generateSRNumberFromData(record, index) {
            const date = new Date();
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `SR${year}${month}${day}${random}-IMP${index + 1}`;
        }
        
        // ========== FORM CONTROL FUNCTIONS ==========
        
        function cancelEdit() {
            resetForm();
        }
        
        function resetForm() {
            try {
                editingId = null;
                currentSegments = 2;
                generateSRNumber();
                
                const twoSegmentBtn = document.getElementById('twoSegmentBtn');
                const fourSegmentBtn = document.getElementById('fourSegmentBtn');
                if (twoSegmentBtn && fourSegmentBtn) {
                    toggleFlightSegments(2);
                    twoSegmentBtn.classList.add('active');
                    fourSegmentBtn.classList.remove('active');
                }
                
                const fieldsToClear = [
                    'originalSrNumber', 'airlinePnr', 'gdsPnr', 'noOfSeats', 
                    'outboundDate', 'inboundDate', 'outboundFlight', 'inboundFlight', 
                    'outboundTimes', 'inboundTimes', 'outbound1Date', 'outbound2Date',
                    'inbound1Date', 'inbound2Date', 'outbound1Flight', 'outbound2Flight',
                    'inbound1Flight', 'inbound2Flight', 'outbound1Times', 'outbound2Times',
                    'inbound1Times', 'inbound2Times', 'sector', 'fare', 'taxes', 
                    'issuanceDate', 'emdRefundDate', 'emd1Number', 'emd1Amount', 
                    'emd1TimeLimit', 'emd1IssuanceDate', 'emd1PaymentPercent',
                    'emd2Number', 'emd2Amount', 'emd2TimeLimit', 'emd3Number', 
                    'emd3Amount', 'emd3TimeLimit', 'ticketsIssued', 'lastTicketDate', 
                    'notes'
                ];
                
                fieldsToClear.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.value = '';
                });
                
                const investmentType = document.getElementById('investmentType');
                const license = document.getElementById('license');
                const branch = document.getElementById('branch');
                const segment = document.getElementById('segment');
                const airline = document.getElementById('airline');
                const emd1Status = document.getElementById('emd1Status');
                const ticketingStatus = document.getElementById('ticketingStatus');
                const overallStatus = document.getElementById('overallStatus');
                const paymentPercentage = document.getElementById('paymentPercentage');
                
                if (investmentType) investmentType.value = 'Company Investment';
                if (license) license.value = 'QFC';
                if (branch) branch.value = 'HO';
                if (segment) segment.value = 'Umrah';
                if (airline) airline.value = '';
                if (emd1Status) emd1Status.value = '';
                if (ticketingStatus) ticketingStatus.value = 'pending';
                if (overallStatus) overallStatus.value = 'draft';
                if (paymentPercentage) paymentPercentage.value = '100';
                
                const today = new Date().toISOString().split('T')[0];
                const requestDate = document.getElementById('requestDate');
                const timeLimit = document.getElementById('timeLimit');
                
                if (requestDate) requestDate.value = today;
                if (timeLimit) {
                    const nextWeek = new Date();
                    nextWeek.setDate(nextWeek.getDate() + 7);
                    timeLimit.value = nextWeek.toISOString().split('T')[0];
                }
                
                calculateAmounts();
                calculateBalanceTickets();
                
                const saveButton = document.getElementById('saveButton');
                const cancelEditBtn = document.getElementById('cancelEditBtn');
                
                if (saveButton) {
                    saveButton.innerHTML = '<i class="bi bi-save me-2"></i>Save Acquisition';
                    saveButton.className = 'btn btn-primary btn-lg';
                }
                if (cancelEditBtn) cancelEditBtn.style.display = 'none';
                
                updateTable();
                showSuccess('Form reset successfully');
            } catch (error) {
                console.error('Error in resetForm:', error);
                showError('Failed to reset form: ' + error.message);
            }
        }
        
        // ========== EVENT LISTENERS SETUP ==========
        
        function setupEventListeners() {
            try {
                const saveButton = document.getElementById('saveButton');
                const resetButton = document.getElementById('resetButton');
                const cancelButton = document.getElementById('cancelEditBtn');
                
                if (saveButton) saveButton.addEventListener('click', saveAcquisition);
                if (resetButton) resetButton.addEventListener('click', resetForm);
                if (cancelButton) cancelButton.addEventListener('click', cancelEdit);
                
                const fareEl = document.getElementById('fare');
                const taxesEl = document.getElementById('taxes');
                const paymentEl = document.getElementById('paymentPercentage');
                const seatsEl = document.getElementById('noOfSeats');
                const ticketsEl = document.getElementById('ticketsIssued');
                
                if (fareEl) fareEl.addEventListener('input', calculateAmounts);
                if (taxesEl) taxesEl.addEventListener('input', calculateAmounts);
                if (paymentEl) paymentEl.addEventListener('input', calculateAmounts);
                if (seatsEl) seatsEl.addEventListener('input', calculateBalanceTickets);
                if (ticketsEl) ticketsEl.addEventListener('input', calculateBalanceTickets);
                
                setupAirlineSegmentToggle();
            } catch (error) {
                console.error('Error in setupEventListeners:', error);
            }
        }
        
        function setupAirlineSegmentToggle() {
            try {
                const airlineSelect = document.getElementById('airline');
                if (airlineSelect) {
                    airlineSelect.addEventListener('change', function() {
                        const airline = this.value;
                        const fourSegmentAirlines = ['EK', 'QR', 'EY', 'TK'];
                        const twoSegmentAirlines = ['SV', 'PA', 'PK', 'F3', 'PF', '9P', 'J9'];
                        
                        const twoSegmentBtn = document.getElementById('twoSegmentBtn');
                        const fourSegmentBtn = document.getElementById('fourSegmentBtn');
                        
                        if (fourSegmentAirlines.includes(airline)) {
                            toggleFlightSegments(4);
                            if (twoSegmentBtn) twoSegmentBtn.classList.remove('active');
                            if (fourSegmentBtn) fourSegmentBtn.classList.add('active');
                        } else if (twoSegmentAirlines.includes(airline)) {
                            toggleFlightSegments(2);
                            if (twoSegmentBtn) twoSegmentBtn.classList.add('active');
                            if (fourSegmentBtn) fourSegmentBtn.classList.remove('active');
                        }
                    });
                }
            } catch (error) {
                console.error('Error in setupAirlineSegmentToggle:', error);
            }
        }
        
        function setupInputFormatting() {
            try {
                const timeInputs = document.querySelectorAll('input[placeholder*="ISB 0700"], input[placeholder*="DXB"]');
                timeInputs.forEach(input => {
                    input.addEventListener('input', function(e) {
                        let value = e.target.value.toUpperCase();
                        value = value.replace(/[^A-Z0-9\s]/g, '');
                        if (value.length === 3 && !value.endsWith(' ')) value = value + ' ';
                        if (value.length === 8 && value.charAt(7) !== ' ') value = value.substring(0, 7) + ' ' + value.charAt(7);
                        if (value.length === 12 && value.charAt(11) !== ' ') value = value.substring(0, 11) + ' ' + value.charAt(11);
                        if (value.length > 17) value = value.substring(0, 17);
                        e.target.value = value;
                    });
                });
            } catch (error) {
                console.error('Error in setupInputFormatting:', error);
            }
        }
        
        function initializeForm() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const requestDate = document.getElementById('requestDate');
                const timeLimit = document.getElementById('timeLimit');
                
                if (requestDate) requestDate.value = today;
                if (timeLimit) {
                    const nextWeek = new Date();
                    nextWeek.setDate(nextWeek.getDate() + 7);
                    timeLimit.value = nextWeek.toISOString().split('T')[0];
                }
                
                generateSRNumber();
                setupInputFormatting();
            } catch (error) {
                console.error('Error in initializeForm:', error);
            }
        }
        
        // ========== SUPABASE INITIALIZATION ==========
        
        async function initializeSupabase() {
            try {
                // ====== IMPORTANT: REPLACE THESE WITH YOUR ACTUAL CREDENTIALS ======
                const SUPABASE_URL = 'https://your-project-id.supabase.co'; //  CHANGE THIS
                const SUPABASE_ANON_KEY = 'your-anon-key-here'; //  CHANGE THIS
                // ===================================================================
                
                console.log('Initializing Supabase...');
                
                // Always try to initialize if credentials are provided
                if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                    
                    // Create Supabase client
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('Supabase client created');
                    
                    // Test connection
                    try {
                        const { data, error } = await supabaseClient
                            .from('seat_acquisitions')
                            .select('*')
                            .limit(1);
                            
                        if (error) {
                            console.warn('Supabase connection test failed:', error.message);
                            supabaseClient = null;
                            console.warn('Using localStorage instead');
                        } else {
                            console.log(' Supabase connection successful');
                        }
                    } catch (testError) {
                        console.warn('Supabase test error:', testError.message);
                        supabaseClient = null;
                        console.warn('Using localStorage instead');
                    }
                } else {
                    console.warn('Supabase credentials not configured. Using localStorage.');
                    supabaseClient = null;
                }
            } catch (error) {
                console.error('Error initializing Supabase:', error);
                supabaseClient = null;
                console.warn('Using localStorage instead');
            }
        }
        
        // ========== IMPORT/EXPORT FUNCTIONS ==========
        
        function setupImportEventListeners() {
            try {
                const fileInput = document.getElementById('fileInput');
                const dropArea = document.getElementById('dropArea');
                const processBtn = document.getElementById('processImportBtn');
                
                if (fileInput) fileInput.addEventListener('change', handleFileSelect);
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    if (dropArea) dropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    if (dropArea) dropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    if (dropArea) dropArea.addEventListener(eventName, unhighlight, false);
                });
                
                if (dropArea) dropArea.addEventListener('drop', handleDrop, false);
                if (processBtn) processBtn.addEventListener('click', processImport);
            } catch (error) {
                console.error('Error in setupImportEventListeners:', error);
            }
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight() {
            const dropArea = document.getElementById('dropArea');
            if (dropArea) dropArea.classList.add('dragover');
        }
        
        function unhighlight() {
            const dropArea = document.getElementById('dropArea');
            if (dropArea) dropArea.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) handleFiles(files[0]);
        }
        
        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) handleFiles(files[0]);
        }
        
        function handleFiles(file) {
            try {
                currentFile = file;
                const dropArea = document.getElementById('dropArea');
                if (!dropArea) return;
                
                const originalHTML = dropArea.innerHTML;
                dropArea.innerHTML = `
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Processing ${file.name}...</p>
                `;
                
                const fileType = file.name.split('.').pop().toLowerCase();
                if (fileType === 'csv') parseCSV(file);
                else if (fileType === 'xlsx' || fileType === 'xls') parseExcel(file);
                else {
                    showError('Unsupported file type. Please upload CSV or Excel file.');
                    dropArea.innerHTML = originalHTML;
                }
            } catch (error) {
                console.error('Error in handleFiles:', error);
            }
        }
        
        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showError('Error parsing CSV: ' + results.errors[0].message);
                        const dropArea = document.getElementById('dropArea');
                        if (dropArea) dropArea.innerHTML = originalHTML;
                        return;
                    }
                    importData = results.data;
                    showPreview();
                },
                error: function(error) {
                    showError('Error reading CSV file: ' + error.message);
                    const dropArea = document.getElementById('dropArea');
                    if (dropArea) dropArea.innerHTML = originalHTML;
                }
            });
        }
        
        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    const headers = jsonData[0];
                    importData = jsonData.slice(1).map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            if (header && row[index] !== undefined) obj[header] = row[index];
                        });
                        return obj;
                    });
                    showPreview();
                } catch (error) {
                    showError('Error parsing Excel file: ' + error.message);
                    const dropArea = document.getElementById('dropArea');
                    if (dropArea) dropArea.innerHTML = originalHTML;
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function showPreview() {
            try {
                const previewHeader = document.getElementById('previewHeader');
                const previewBody = document.getElementById('previewBody');
                const filePreview = document.getElementById('filePreview');
                const processBtn = document.getElementById('processImportBtn');
                
                if (!previewHeader || !previewBody || !filePreview || !processBtn) return;
                
                if (importData.length === 0) {
                    showError('No data found in file');
                    return;
                }
                
                filePreview.style.display = 'block';
                const headers = Object.keys(importData[0]);
                let headerHTML = '<tr>';
                headers.forEach(header => headerHTML += `<th>${header}</th>`);
                headerHTML += '</tr>';
                previewHeader.innerHTML = headerHTML;
                
                let bodyHTML = '';
                const previewRows = Math.min(5, importData.length);
                for (let i = 0; i < previewRows; i++) {
                    bodyHTML += '<tr>';
                    headers.forEach(header => bodyHTML += `<td>${importData[i][header] || ''}</td>`);
                    bodyHTML += '</tr>';
                }
                previewBody.innerHTML = bodyHTML;
                processBtn.disabled = false;
                
                const dropArea = document.getElementById('dropArea');
                if (dropArea) {
                    dropArea.innerHTML = `
                        <i class="bi bi-check-circle display-4 text-success mb-3"></i>
                        <h5>File Ready: ${currentFile.name}</h5>
                        <p class="text-success">${importData.length} records found</p>
                        <button type="button" class="btn btn-outline-primary mt-2" onclick="document.getElementById('fileInput').click()">
                            <i class="bi bi-arrow-repeat me-2"></i>Choose Different File
                        </button>
                    `;
                }
            } catch (error) {
                console.error('Error in showPreview:', error);
            }
        }
        
        async function processImport() {
            const processBtn = document.getElementById('processImportBtn');
            if (!processBtn) return;
            
            const originalText = processBtn.innerHTML;
            const autoFill = document.getElementById('autoFillForm')?.checked || false;
            const saveToDB = document.getElementById('saveToDatabase')?.checked || false;
            const keepOriginalSR = document.getElementById('keepOriginalSR')?.checked || false;
            
            processBtn.disabled = true;
            processBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                if (saveToDB && supabaseClient) {
                    for (let i = 0; i < importData.length; i++) {
                        try {
                            const record = importData[i];
                            const mappedData = mapImportToForm(record, keepOriginalSR, i);
                            const { error } = await supabaseClient
                                .from('seat_acquisitions')
                                .insert([mappedData]);
                            if (error) throw error;
                            successCount++;
                        } catch (error) {
                            console.error(`Error saving record ${i}:`, error);
                            errorCount++;
                        }
                    }
                    await loadAcquisitions();
                }
                
                if (autoFill && importData.length > 0) {
                    fillFormWithData(importData[0], keepOriginalSR);
                }
                
                const modalEl = document.getElementById('importModal');
                if (modalEl) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                }
                
                resetImport();
                
                let message = `Imported ${importData.length} records. `;
                if (saveToDB) {
                    message += `${successCount} saved successfully.`;
                    if (errorCount > 0) message += ` ${errorCount} failed.`;
                }
                if (autoFill) message += ' Form filled with first record.';
                showSuccess(message);
                
            } catch (error) {
                console.error('Import error:', error);
                showError('Error during import: ' + error.message);
            } finally {
                processBtn.disabled = false;
                processBtn.innerHTML = originalText;
            }
        }
        
        function mapImportToForm(record, keepOriginalSR, index) {
            const mapping = {
                'SR Number': 'sr_number',
                'Original SR Number': 'sr_number',
                'Request Date': 'request_date',
                'Airline PNR': 'airline_pnr',
                'GDS PNR': 'gds_pnr',
                'Segment': 'segment',
                'Airline': 'airline',
                'No of Seats': 'no_of_seats',
                'Sector': 'sector',
                'Investment Type': 'investment_type',
                'License': 'license',
                'Branch': 'branch',
                'Outbound Date': 'outbound_date',
                'Outbound Flight': 'outbound_flight',
                'Outbound Times': 'outbound_times',
                'Inbound Date': 'inbound_date',
                'Inbound Flight': 'inbound_flight',
                'Inbound Times': 'inbound_times',
                'Fare': 'fare',
                'Taxes': 'taxes',
                'Issuance Date': 'issuance_date',
                'Time Limit': 'time_limit',
                'Payment Percentage': 'payment_percentage',
                'EMD 1 Number': 'first_emd_number',
                'EMD 1 Amount': 'first_emd_amount',
                'EMD 1 Status': 'first_emd_status',
                'EMD 1 Time Limit': 'first_emd_time_limit',
                'EMD 1 Issuance Date': 'first_emd_issuance_date',
                'EMD 1 Payment %': 'first_emd_payment_percentage',
                'EMD 2 Number': 'second_emd_number',
                'EMD 2 Amount': 'second_emd_amount',
                'EMD 2 Time Limit': 'second_emd_time_limit',
                'EMD 3 Number': 'third_emd_number',
                'EMD 3 Amount': 'third_emd_amount',
                'EMD 3 Time Limit': 'third_emd_time_limit',
                'EMD Refund Date': 'emd_refund_date',
                'Ticketing Status': 'ticketing_status',
                'Tickets Issued': 'no_of_tickets_issued',
                'Last Ticket Date': 'last_ticket_date',
                'Status': 'status',
                'Notes': 'notes'
            };
            
            const mappedData = {};
            Object.keys(mapping).forEach(csvKey => {
                if (record[csvKey] !== undefined && record[csvKey] !== null && record[csvKey] !== '') {
                    mappedData[mapping[csvKey]] = record[csvKey];
                }
            });
            
            if (keepOriginalSR && record['SR Number']) {
                mappedData.sr_number = record['SR Number'];
            } else {
                mappedData.sr_number = generateSRNumberFromData(record, index);
            }
            
            mappedData.created_at = new Date().toISOString();
            mappedData.updated_at = new Date().toISOString();
            return mappedData;
        }
        
        function fillFormWithData(record, keepOriginalSR) {
            try {
                const originalSR = record['SR Number'] || record['sr_number'];
                if (keepOriginalSR && originalSR) {
                    const srNumber = document.getElementById('srNumber');
                    if (srNumber) srNumber.value = originalSR;
                } else {
                    generateSRNumber();
                }
                
                const originalSrNumber = document.getElementById('originalSrNumber');
                if (originalSrNumber && originalSR) originalSrNumber.value = originalSR;
                
                const airline = record['Airline'] || record['airline'];
                const airlineSelect = document.getElementById('airline');
                if (airlineSelect && airline) {
                    airlineSelect.value = airline;
                    const fourSegmentAirlines = ['EK', 'QR', 'EY', 'TK'];
                    if (fourSegmentAirlines.includes(airline)) toggleFlightSegments(4);
                    else toggleFlightSegments(2);
                }
                
                // Fill other fields
                const fieldMapping = {
                    'requestDate': formatDateForInput(record['Request Date'] || record['request_date']),
                    'airlinePnr': record['Airline PNR'] || record['airline_pnr'],
                    'gdsPnr': record['GDS PNR'] || record['gds_pnr'],
                    'segment': record['Segment'] || record['segment'],
                    'noOfSeats': record['No of Seats'] || record['no_of_seats'],
                    'sector': record['Sector'] || record['sector'],
                    'investmentType': record['Investment Type'] || record['investment_type'],
                    'license': record['License'] || record['license'],
                    'branch': record['Branch'] || record['branch'],
                    'fare': record['Fare'] || record['fare'],
                    'taxes': record['Taxes'] || record['taxes'],
                    'issuanceDate': formatDateForInput(record['Issuance Date'] || record['issuance_date']),
                    'timeLimit': formatDateForInput(record['Time Limit'] || record['time_limit']),
                    'paymentPercentage': record['Payment Percentage'] || record['payment_percentage'],
                    'emd1Number': record['EMD 1 Number'] || record['first_emd_number'],
                    'emd1Amount': record['EMD 1 Amount'] || record['first_emd_amount'],
                    'emd1Status': record['EMD 1 Status'] || record['first_emd_status'],
                    'emd1TimeLimit': formatDateForInput(record['EMD 1 Time Limit'] || record['first_emd_time_limit']),
                    'emd1IssuanceDate': formatDateForInput(record['EMD 1 Issuance Date'] || record['first_emd_issuance_date']),
                    'emd1PaymentPercent': record['EMD 1 Payment %'] || record['first_emd_payment_percentage'],
                    'emd2Number': record['EMD 2 Number'] || record['second_emd_number'],
                    'emd2Amount': record['EMD 2 Amount'] || record['second_emd_amount'],
                    'emd2TimeLimit': formatDateForInput(record['EMD 2 Time Limit'] || record['second_emd_time_limit']),
                    'emd3Number': record['EMD 3 Number'] || record['third_emd_number'],
                    'emd3Amount': record['EMD 3 Amount'] || record['third_emd_amount'],
                    'emd3TimeLimit': formatDateForInput(record['EMD 3 Time Limit'] || record['third_emd_time_limit']),
                    'emdRefundDate': formatDateForInput(record['EMD Refund Date'] || record['emd_refund_date']),
                    'ticketingStatus': record['Ticketing Status'] || record['ticketing_status'],
                    'ticketsIssued': record['Tickets Issued'] || record['no_of_tickets_issued'],
                    'lastTicketDate': formatDateForInput(record['Last Ticket Date'] || record['last_ticket_date']),
                    'overallStatus': record['Status'] || record['status'],
                    'notes': record['Notes'] || record['notes']
                };
                
                // Flight data - use 2-segment fields or first segments for 4-segment
                if (currentSegments === 2) {
                    fieldMapping['outboundDate'] = formatDateForInput(record['Outbound Date'] || record['outbound_date']);
                    fieldMapping['inboundDate'] = formatDateForInput(record['Inbound Date'] || record['inbound_date']);
                    fieldMapping['outboundFlight'] = record['Outbound Flight'] || record['outbound_flight'];
                    fieldMapping['inboundFlight'] = record['Inbound Flight'] || record['inbound_flight'];
                    fieldMapping['outboundTimes'] = record['Outbound Times'] || record['outbound_times'];
                    fieldMapping['inboundTimes'] = record['Inbound Times'] || record['inbound_times'];
                } else {
                    // For 4 segments, use first segments
                    fieldMapping['outboundDate'] = formatDateForInput(record['Outbound 1 Date'] || record['outbound_date']);
                    fieldMapping['inboundDate'] = formatDateForInput(record['Inbound 1 Date'] || record['inbound_date']);
                    fieldMapping['outboundFlight'] = record['Outbound 1 Flight'] || record['outbound_flight'];
                    fieldMapping['inboundFlight'] = record['Inbound 1 Flight'] || record['inbound_flight'];
                    fieldMapping['outboundTimes'] = record['Outbound 1 Times'] || record['outbound_times'];
                    fieldMapping['inboundTimes'] = record['Inbound 1 Times'] || record['inbound_times'];
                }
                
                Object.keys(fieldMapping).forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element && fieldMapping[fieldId] !== undefined && fieldMapping[fieldId] !== null) {
                        element.value = fieldMapping[fieldId];
                    }
                });
                
                calculateAmounts();
                calculateBalanceTickets();
                showSuccess('Form filled with imported data');
            } catch (error) {
                console.error('Error in fillFormWithData:', error);
            }
        }
        
        function resetImport() {
            try {
                importData = [];
                currentFile = null;
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.value = '';
                
                const dropArea = document.getElementById('dropArea');
                if (dropArea) {
                    dropArea.innerHTML = `
                        <i class="bi bi-cloud-upload display-4 text-primary mb-3"></i>
                        <h5>Drag & Drop Files Here</h5>
                        <p class="text-muted">or click to browse</p>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                        <button type="button" class="btn btn-outline-primary mt-2" onclick="document.getElementById('fileInput').click()">
                            <i class="bi bi-folder2-open me-2"></i>Browse Files
                        </button>
                        <p class="text-muted mt-2 mb-0">Supports: CSV, Excel (.xlsx, .xls)</p>
                    `;
                }
                
                const filePreview = document.getElementById('filePreview');
                const previewHeader = document.getElementById('previewHeader');
                const previewBody = document.getElementById('previewBody');
                const processBtn = document.getElementById('processImportBtn');
                
                if (filePreview) filePreview.style.display = 'none';
                if (previewHeader) previewHeader.innerHTML = '';
                if (previewBody) previewBody.innerHTML = '';
                if (processBtn) processBtn.disabled = true;
                
                const autoGenerateSR = document.getElementById('autoGenerateSR');
                const keepOriginalSR = document.getElementById('keepOriginalSR');
                if (autoGenerateSR) autoGenerateSR.checked = true;
                if (keepOriginalSR) keepOriginalSR.checked = false;
                
                setupImportEventListeners();
            } catch (error) {
                console.error('Error in resetImport:', error);
            }
        }
        
        function exportTemplate() {
            const templateData = [
                {
                    'SR Number': 'OLD12345',
                    'Request Date': '2025-01-01',
                    'Airline PNR': 'ABC123',
                    'GDS PNR': 'XYZ789',
                    'Segment': 'Umrah',
                    'Airline': 'SV',
                    'No of Seats': '10',
                    'Sector': 'ISB-JED',
                    'Investment Type': 'Company Investment',
                    'License': 'QFC',
                    'Branch': 'HO',
                    'Outbound Date': '2025-03-01',
                    'Outbound Flight': 'SV723',
                    'Outbound Times': 'ISB 0700 JED 1100',
                    'Inbound Date': '2025-03-15',
                    'Inbound Flight': 'SV724',
                    'Inbound Times': 'JED 0200 ISB 0500',
                    'Fare': '500.00',
                    'Taxes': '50.00',
                    'Issuance Date': '2025-01-02',
                    'Time Limit': '2025-01-08',
                    'Payment Percentage': '100',
                    'EMD 1 Number': 'EMD12345',
                    'EMD 1 Amount': '550.00',
                    'EMD 1 Status': 'paid',
                    'EMD 1 Time Limit': '2025-01-10',
                    'EMD 1 Issuance Date': '2025-01-02',
                    'EMD 1 Payment %': '100',
                    'EMD 2 Number': '',
                    'EMD 2 Amount': '',
                    'EMD 2 Time Limit': '',
                    'EMD 3 Number': '',
                    'EMD 3 Amount': '',
                    'EMD 3 Time Limit': '',
                    'EMD Refund Date': '',
                    'Ticketing Status': 'pending',
                    'Tickets Issued': '0',
                    'Last Ticket Date': '',
                    'Status': 'draft',
                    'Notes': 'Sample data for template - Use 2 segments for SV'
                }
            ];
            
            const headers = Object.keys(templateData[0]);
            const csvRows = [];
            csvRows.push(headers.join(','));
            templateData.forEach(row => {
                const values = headers.map(header => {
                    const escaped = ('' + row[header]).replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            });
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'QFC_Import_Template.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showSuccess('Template downloaded successfully');
        }
        
        // ========== MAIN SAVE FUNCTION ==========
        
        async function saveAcquisition() {
            const airlinePnr = document.getElementById('airlinePnr')?.value;
            const noOfSeats = document.getElementById('noOfSeats')?.value;
            const fare = document.getElementById('fare')?.value;
            const timeLimit = document.getElementById('timeLimit')?.value;
            const airline = document.getElementById('airline')?.value;
            
            if (!airlinePnr || !noOfSeats || !fare || !timeLimit || !airline) {
                showError('Please fill in all required fields (*)');
                return;
            }
            
            let timeValidationPassed = true;
            let timeError = '';
            const timePattern = /^[A-Z]{3}\s+\d{4}\s+[A-Z]{3}\s+\d{4}$/;
            
            if (currentSegments === 2) {
                const outboundTimes = document.getElementById('outboundTimes')?.value;
                const inboundTimes = document.getElementById('inboundTimes')?.value;
                if (outboundTimes && !timePattern.test(outboundTimes.toUpperCase())) {
                    timeValidationPassed = false;
                    timeError = 'Please enter Outbound Times in correct format: ISB 0700 JED 1100';
                }
                if (inboundTimes && !timePattern.test(inboundTimes.toUpperCase())) {
                    timeValidationPassed = false;
                    timeError = timeError || 'Please enter Inbound Times in correct format: JED 0200 ISB 0500';
                }
            } else {
                const segments = [
                    { id: 'outbound1Times', name: 'Outbound Segment 1' },
                    { id: 'outbound2Times', name: 'Outbound Segment 2' },
                    { id: 'inbound1Times', name: 'Inbound Segment 1' },
                    { id: 'inbound2Times', name: 'Inbound Segment 2' }
                ];
                for (const segment of segments) {
                    const timeValue = document.getElementById(segment.id)?.value;
                    if (timeValue && !timePattern.test(timeValue.toUpperCase())) {
                        timeValidationPassed = false;
                        timeError = `Please enter ${segment.name} Times in correct format: ISB 0800 DXB 1100`;
                        break;
                    }
                }
            }
            
            if (!timeValidationPassed) {
                showError(timeError);
                return;
            }
            
            const saveButton = document.getElementById('saveButton');
            if (!saveButton) return;
            
            const originalText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Saving...';
            
            try {
                const formData = {
                    sr_number: document.getElementById('srNumber')?.value || '',
                    request_date: document.getElementById('requestDate')?.value || new Date().toISOString().split('T')[0],
                    airline_pnr: airlinePnr,
                    no_of_seats: parseInt(noOfSeats) || 0,
                    fare: parseFloat(fare) || 0,
                    time_limit: timeLimit,
                    investment_type: document.getElementById('investmentType')?.value || 'Company Investment',
                    license: document.getElementById('license')?.value || 'QFC',
                    branch: document.getElementById('branch')?.value || 'HO',
                    gds_pnr: document.getElementById('gdsPnr')?.value || null,
                    segment: document.getElementById('segment')?.value || 'Umrah',
                    airline: airline,
                    sector: document.getElementById('sector')?.value || '',
                    taxes: parseFloat(document.getElementById('taxes')?.value) || 0,
                    payable_amount: parseFloat(document.getElementById('payableAmount')?.value) || 0,
                    pnr_amount: parseFloat(document.getElementById('pnrAmount')?.value) || 0,
                    issuance_date: document.getElementById('issuanceDate')?.value || null,
                    payment_percentage: parseFloat(document.getElementById('paymentPercentage')?.value) || 100,
                    emd_refund_date: document.getElementById('emdRefundDate')?.value || null,
                    first_emd_number: document.getElementById('emd1Number')?.value || null,
                    first_emd_amount: document.getElementById('emd1Amount')?.value ? parseFloat(document.getElementById('emd1Amount').value) : null,
                    first_emd_status: document.getElementById('emd1Status')?.value || null,
                    first_emd_time_limit: document.getElementById('emd1TimeLimit')?.value || null,
                    first_emd_issuance_date: document.getElementById('emd1IssuanceDate')?.value || null,
                    first_emd_payment_percentage: document.getElementById('emd1PaymentPercent')?.value ? parseFloat(document.getElementById('emd1PaymentPercent').value) : null,
                    second_emd_number: document.getElementById('emd2Number')?.value || null,
                    second_emd_amount: document.getElementById('emd2Amount')?.value ? parseFloat(document.getElementById('emd2Amount').value) : null,
                    second_emd_time_limit: document.getElementById('emd2TimeLimit')?.value || null,
                    third_emd_number: document.getElementById('emd3Number')?.value || null,
                    third_emd_amount: document.getElementById('emd3Amount')?.value ? parseFloat(document.getElementById('emd3Amount').value) : null,
                    third_emd_time_limit: document.getElementById('emd3TimeLimit')?.value || null,
                    ticketing_status: document.getElementById('ticketingStatus')?.value || 'pending',
                    no_of_tickets_issued: parseInt(document.getElementById('ticketsIssued')?.value) || 0,
                    balance_tickets: parseInt(document.getElementById('balanceTickets')?.value) || 0,
                    last_ticket_date: document.getElementById('lastTicketDate')?.value || null,
                    status: document.getElementById('overallStatus')?.value || 'draft',
                    notes: document.getElementById('notes')?.value || null,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                // Flight data based on segments
                if (currentSegments === 2) {
                    formData.outbound_date = document.getElementById('outboundDate')?.value || null;
                    formData.inbound_date = document.getElementById('inboundDate')?.value || null;
                    formData.outbound_flight = document.getElementById('outboundFlight')?.value || null;
                    formData.inbound_flight = document.getElementById('inboundFlight')?.value || null;
                    formData.outbound_times = document.getElementById('outboundTimes')?.value || null;
                    formData.inbound_times = document.getElementById('inboundTimes')?.value || null;
                } else {
                    // For 4 segments, use first segments
                    formData.outbound_date = document.getElementById('outbound1Date')?.value || null;
                    formData.inbound_date = document.getElementById('inbound1Date')?.value || null;
                    formData.outbound_flight = document.getElementById('outbound1Flight')?.value || null;
                    formData.inbound_flight = document.getElementById('inbound1Flight')?.value || null;
                    formData.outbound_times = document.getElementById('outbound1Times')?.value || null;
                    formData.inbound_times = document.getElementById('inbound1Times')?.value || null;
                }
                
                console.log('Saving data to:', supabaseClient ? 'Supabase' : 'localStorage');
                console.log('Form data:', formData);
                
                if (editingId) {
                    if (supabaseClient) {
                        const { error } = await supabaseClient
                            .from('seat_acquisitions')
                            .update(formData)
                            .eq('id', editingId);
                        
                        if (error) throw error;
                        showSuccess(' Updated successfully! SR#: ' + formData.sr_number);
                    } else {
                        // Save to localStorage
                        const index = acquisitions.findIndex(a => a.id === editingId);
                        if (index !== -1) {
                            acquisitions[index] = { ...acquisitions[index], ...formData, id: editingId };
                            localStorage.setItem('qfc_acquisitions', JSON.stringify(acquisitions));
                        }
                        showSuccess(' Updated locally! SR#: ' + formData.sr_number);
                    }
                    editingId = null;
                } else {
                    if (supabaseClient) {
                        const { error } = await supabaseClient
                            .from('seat_acquisitions')
                            .insert([formData]);
                        
                        if (error) throw error;
                        showSuccess(' Saved to Supabase! SR#: ' + formData.sr_number);
                    } else {
                        // Save to localStorage
                        const newId = 'local_' + Date.now();
                        const newItem = { ...formData, id: newId };
                        acquisitions.unshift(newItem);
                        localStorage.setItem('qfc_acquisitions', JSON.stringify(acquisitions));
                        showSuccess(' Saved locally! SR#: ' + formData.sr_number);
                    }
                }
                
                resetForm();
                await loadAcquisitions();
                
            } catch (error) {
                console.error('Save error:', error);
                showError(' Error saving: ' + (error.message || 'Please check console for details'));
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = originalText;
            }
        }
        
        // ========== DATA LOADING FUNCTIONS ==========
        
        async function loadAcquisitions() {
            try {
                if (!supabaseClient) {
                    const savedData = localStorage.getItem('qfc_acquisitions');
                    acquisitions = savedData ? JSON.parse(savedData) : [];
                    updateTable();
                    updateDashboard();
                    return;
                }
                
                const { data, error } = await supabaseClient
                    .from('seat_acquisitions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                acquisitions = data || [];
                updateTable();
                updateDashboard();
                localStorage.setItem('qfc_acquisitions', JSON.stringify(acquisitions));
                
            } catch (error) {
                console.error('Load error:', error);
                const savedData = localStorage.getItem('qfc_acquisitions');
                acquisitions = savedData ? JSON.parse(savedData) : [];
                updateTable();
                updateDashboard();
                showError('Using offline data. Please check internet connection.');
            }
        }
        
        function updateTable() {
            const tableBody = document.getElementById('acquisitionsTable');
            const tableCount = document.getElementById('tableCount');
            
            if (!tableBody || !tableCount) return;
            
            if (!acquisitions || acquisitions.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="text-muted">
                                <i class="bi bi-inbox display-6"></i>
                                <p class="mt-2">No acquisitions yet</p>
                                <small>Save your first acquisition above</small>
                            </div>
                        </td>
                    </tr>
                `;
                tableCount.textContent = '0 records';
                return;
            }
            
            let html = '';
            acquisitions.forEach(item => {
                const id = item.id || '';
                const isEditing = editingId === id;
                const rowClass = isEditing ? 'table-warning' : '';
                let statusClass = 'status-draft';
                if (item.status === 'approved') statusClass = 'status-approved';
                if (item.status === 'submitted') statusClass = 'status-pending';
                const srNumber = item.sr_number || '';
                
                html += `
                    <tr class="${rowClass}">
                        <td>
                            <strong>${srNumber}</strong>
                        </td>
                        <td>${item.airline_pnr || ''}</td>
                        <td>${item.no_of_seats || 0}</td>
                        <td>${item.fare ? parseFloat(item.fare).toFixed(2) : '0.00'}</td>
                        <td><span class="status-badge ${statusClass}">${item.status || 'draft'}</span></td>
                        <td>${item.created_at ? new Date(item.created_at).toLocaleDateString() : ''}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editItem('${id}')" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteItem('${id}', '${item.sr_number}')" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            tableCount.textContent = `${acquisitions.length} records`;
        }
        
        function updateDashboard() {
            if (!acquisitions || acquisitions.length === 0) {
                const totalSeats = document.getElementById('totalSeats');
                const totalRevenue = document.getElementById('totalRevenue');
                const totalAcquisitions = document.getElementById('totalAcquisitions');
                const pendingItems = document.getElementById('pendingItems');
                
                if (totalSeats) totalSeats.textContent = '0';
                if (totalRevenue) totalRevenue.textContent = '0.00';
                if (totalAcquisitions) totalAcquisitions.textContent = '0';
                if (pendingItems) pendingItems.textContent = '0';
                return;
            }
            
            const totalSeats = acquisitions.reduce((sum, item) => sum + (item.no_of_seats || 0), 0);
            const totalRevenue = acquisitions.reduce((sum, item) => sum + (item.pnr_amount || 0), 0);
            const pendingCount = acquisitions.filter(item => item.status === 'draft' || item.status === 'submitted').length;
            const totalAcquisitionsCount = acquisitions.length;
            
            const totalSeatsEl = document.getElementById('totalSeats');
            const totalRevenueEl = document.getElementById('totalRevenue');
            const totalAcquisitionsEl = document.getElementById('totalAcquisitions');
            const pendingItemsEl = document.getElementById('pendingItems');
            
            if (totalSeatsEl) totalSeatsEl.textContent = totalSeats;
            if (totalRevenueEl) totalRevenueEl.textContent = totalRevenue.toFixed(2);
            if (totalAcquisitionsEl) totalAcquisitionsEl.textContent = totalAcquisitionsCount;
            if (pendingItemsEl) pendingItemsEl.textContent = pendingCount;
        }
        
        // ========== EDIT AND DELETE FUNCTIONS ==========
        
        async function editItem(id) {
            try {
                let item;
                
                if (supabaseClient) {
                    const { data, error } = await supabaseClient
                        .from('seat_acquisitions')
                        .select('*')
                        .eq('id', id)
                        .single();
                    
                    if (error) throw error;
                    item = data;
                } else {
                    item = acquisitions.find(a => a.id === id);
                }
                
                if (!item) {
                    showError('Item not found');
                    return;
                }
                
                editingId = id;
                
                // Fill form with item data
                const fields = {
                    'srNumber': item.sr_number || '',
                    'requestDate': formatDateForInput(item.request_date),
                    'airlinePnr': item.airline_pnr || '',
                    'gdsPnr': item.gds_pnr || '',
                    'segment': item.segment || 'Umrah',
                    'airline': item.airline || '',
                    'noOfSeats': item.no_of_seats || '',
                    'sector': item.sector || '',
                    'investmentType': item.investment_type || 'Company Investment',
                    'license': item.license || 'QFC',
                    'branch': item.branch || 'HO',
                    'fare': item.fare || '',
                    'taxes': item.taxes || '',
                    'issuanceDate': formatDateForInput(item.issuance_date),
                    'timeLimit': formatDateForInput(item.time_limit),
                    'paymentPercentage': item.payment_percentage || '100',
                    'emdRefundDate': formatDateForInput(item.emd_refund_date),
                    'emd1Number': item.first_emd_number || '',
                    'emd1Amount': item.first_emd_amount || '',
                    'emd1Status': item.first_emd_status || '',
                    'emd1TimeLimit': formatDateForInput(item.first_emd_time_limit),
                    'emd1IssuanceDate': formatDateForInput(item.first_emd_issuance_date),
                    'emd1PaymentPercent': item.first_emd_payment_percentage || '',
                    'emd2Number': item.second_emd_number || '',
                    'emd2Amount': item.second_emd_amount || '',
                    'emd2TimeLimit': formatDateForInput(item.second_emd_time_limit),
                    'emd3Number': item.third_emd_number || '',
                    'emd3Amount': item.third_emd_amount || '',
                    'emd3TimeLimit': formatDateForInput(item.third_emd_time_limit),
                    'ticketingStatus': item.ticketing_status || 'pending',
                    'ticketsIssued': item.no_of_tickets_issued || '',
                    'lastTicketDate': formatDateForInput(item.last_ticket_date),
                    'overallStatus': item.status || 'draft',
                    'notes': item.notes || ''
                };
                
                // Flight data
                if (item.outbound_date || item.inbound_date) {
                    // Assume 2 segments if we have outbound/inbound data
                    fields['outboundDate'] = formatDateForInput(item.outbound_date);
                    fields['inboundDate'] = formatDateForInput(item.inbound_date);
                    fields['outboundFlight'] = item.outbound_flight || '';
                    fields['inboundFlight'] = item.inbound_flight || '';
                    fields['outboundTimes'] = item.outbound_times || '';
                    fields['inboundTimes'] = item.inbound_times || '';
                    toggleFlightSegments(2);
                }
                
                Object.keys(fields).forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) element.value = fields[fieldId];
                });
                
                calculateAmounts();
                calculateBalanceTickets();
                
                // Update button
                const saveButton = document.getElementById('saveButton');
                const cancelEditBtn = document.getElementById('cancelEditBtn');
                
                if (saveButton) {
                    saveButton.innerHTML = '<i class="bi bi-save me-2"></i>Update Acquisition';
                    saveButton.className = 'btn btn-warning btn-lg';
                }
                if (cancelEditBtn) cancelEditBtn.style.display = 'inline-block';
                
                // Scroll to form
                document.getElementById('acquireForm').scrollIntoView({ behavior: 'smooth' });
                
                showSuccess('Editing acquisition: ' + item.sr_number);
                
            } catch (error) {
                console.error('Error editing item:', error);
                showError('Error loading item for editing: ' + error.message);
            }
        }
        
        async function deleteItem(id, srNumber) {
            if (!confirm(`Are you sure you want to delete acquisition ${srNumber}? This action cannot be undone.`)) {
                return;
            }
            
            try {
                if (supabaseClient) {
                    const { error } = await supabaseClient
                        .from('seat_acquisitions')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    showSuccess(`Acquisition ${srNumber} deleted from Supabase`);
                } else {
                    showSuccess(`Acquisition ${srNumber} deleted from localStorage`);
                }
                
                // Remove from local array
                acquisitions = acquisitions.filter(item => item.id !== id);
                
                // Update localStorage
                localStorage.setItem('qfc_acquisitions', JSON.stringify(acquisitions));
                
                // Update UI
                updateTable();
                updateDashboard();
                
            } catch (error) {
                console.error('Error deleting item:', error);
                showError('Error deleting item: ' + error.message);
            }
        }
        
        // ========== INITIALIZATION ==========
        
        // Make toggleFlightSegments globally accessible
        window.toggleFlightSegments = toggleFlightSegments;
        
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing application...');
                
                // Initialize Supabase
                await initializeSupabase();
                
                // Initialize form
                initializeForm();
                
                // Setup event listeners
                setupEventListeners();
                
                // Setup import event listeners
                setupImportEventListeners();
                
                // Load existing data
                await loadAcquisitions();
                
                // Initialize segment toggle
                toggleFlightSegments(2);
                
                console.log('Application initialized successfully');
                
            } catch (error) {
                console.error('Error during initialization:', error);
                showError('Application initialization failed. Please refresh the page.');
            }
        });
    </script>
</body>
</html>
