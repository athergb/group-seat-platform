<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QFC Group Pvt Ltd - Group Seat Platform</title>
    <link rel="icon" type="image/png" href="QFClogo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
    /* ========== GLOBAL STYLES ========== */
    body { 
        background-color: #f8f9fa; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding-bottom: 50px;
    }
    
    /* ========== NAVBAR ========== */
    .navbar-brand { 
        font-weight: bold; 
        color: #0d6efd !important; 
        font-size: 1.3rem;
    }
    .navbar {
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 0.8rem 0;
    }
    
    /* ========== CARDS ========== */
    .card { 
        border-radius: 12px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        margin-bottom: 24px;
        border: 1px solid #e9ecef;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
        font-weight: 600;
    }
    
    /* ========== FORM ELEMENTS ========== */
    .form-control, .form-select { 
        border-radius: 8px; 
        padding: 10px 14px;
        border: 1px solid #ced4da;
        transition: all 0.2s;
    }
    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }
    .form-label {
        font-weight: 500;
        margin-bottom: 6px;
        color: #495057;
    }
    
    /* ========== BUTTONS ========== */
    .btn-primary { 
        background-color: #1a365d;
        border-color: #1a365d;
        padding: 10px 24px; 
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s;
    }
    .btn-primary:hover {
        background-color: #2d4a8c;
        border-color: #2d4a8c;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
    }
    .btn-outline-secondary {
        border: 2px solid #6c757d;
        font-weight: 500;
    }
    .btn-outline-warning {
        border: 2px solid #ffc107;
        font-weight: 500;
    }
    .btn-lg {
        padding: 12px 28px;
        font-size: 1.1rem;
    }
    
    /* ========== ACTION BUTTONS ========== */
    .btn-group-sm > .btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.85rem;
        border-radius: 6px;
    }
    .btn-outline-primary {
        border-color: #0d6efd;
        color: #0d6efd;
    }
    .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(13, 110, 253, 0.2);
    }
    .btn-outline-danger {
        border-color: #dc3545;
        color: #dc3545;
    }
    .btn-outline-danger:hover {
        background-color: #dc3545;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(220, 53, 69, 0.2);
    }
    
    /* ========== STATUS BADGES ========== */
    .status-badge { 
        padding: 5px 12px; 
        border-radius: 20px; 
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
        min-width: 80px;
        text-align: center;
    }
    .status-draft { 
        background-color: #fff3cd; 
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    .status-approved { 
        background-color: #d1e7dd; 
        color: #0f5132;
        border: 1px solid #badbcc;
    }
    .status-pending { 
        background-color: #cff4fc; 
        color: #055160;
        border: 1px solid #b6effb;
    }
    
    /* ========== TABLE STYLING ========== */
    .table {
        margin-bottom: 0;
    }
    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        padding: 1rem;
        white-space: nowrap;
    }
    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-top: 1px solid #e9ecef;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    .table-warning {
        background-color: rgba(255, 193, 7, 0.1) !important;
        border-left: 4px solid #ffc107;
    }
    
    /* ========== TABS ========== */
    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 0;
    }
    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 0.8rem 1.5rem;
        margin-bottom: -2px;
        border-radius: 8px 8px 0 0;
    }
    .nav-tabs .nav-link:hover {
        color: #0d6efd;
        background-color: #f8f9fa;
    }
    .nav-tabs .nav-link.active { 
        background-color: #fff; 
        border: 2px solid #dee2e6;
        border-bottom-color: #fff;
        color: #0d6efd;
        font-weight: 600;
    }
    .tab-content { 
        border: 2px solid #dee2e6; 
        border-top: none; 
        padding: 24px;
        background-color: white;
        border-radius: 0 0 8px 8px;
    }
    
    /* ========== DASHBOARD CARDS ========== */
    .dashboard-card {
        border-radius: 10px;
        color: white;
        padding: 1.5rem;
        height: 100%;
        transition: transform 0.3s;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
    }
    .dashboard-card i {
        font-size: 2rem;
        margin-bottom: 10px;
        opacity: 0.9;
    }
    .dashboard-card h5 {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 5px;
    }
    .dashboard-card h2 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0;
    }
    
    /* ========== BADGES ========== */
    .badge {
        padding: 0.35em 0.65em;
        font-weight: 500;
        border-radius: 10px;
    }
    .bg-success-light {
        background-color: rgba(25, 135, 84, 0.1);
        color: #198754;
    }
    .bg-secondary-light {
        background-color: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }
    
    /* ========== TOAST NOTIFICATIONS ========== */
    .toast {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: none;
    }
    .toast-header {
        border-radius: 8px 8px 0 0;
        font-weight: 600;
    }
    
    /* ========== FLIGHT SPECIFIC STYLES ========== */
    .flight-times {
        background-color: #f8f9fa;
        padding: 8px 12px;
        border-radius: 8px;
        border-left: 3px solid #1a365d;
        margin-bottom: 1rem;
    }
    .flight-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 1rem;
    }
    .flight-field {
        background: #f8f9fa;
        padding: 8px;
        border-radius: 6px;
    }
    .flight-field label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 3px;
    }
    .flight-field .value {
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    /* ========== FLIGHT SEGMENTS ========== */
    .flight-segment-section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
    
    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .container {
            padding-left: 15px;
            padding-right: 15px;
        }
        .btn-lg {
            padding: 10px 20px;
            font-size: 1rem;
        }
        .nav-tabs .nav-link {
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
        }
        .table-responsive {
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .flight-info-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* ========== QFC BRANDING ========== */
    .qfc-brand {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-weight: 700;
        color: #1a365d;
    }
    .qfc-subtitle {
        font-size: 10px;
        color: #6c757d;
        letter-spacing: 0.5px;
        font-weight: 400;
    }
    .card-header.bg-light {
        border-left: 4px solid #1a365d;
    }
    .bg-primary { background-color: #1a365d !important; }
    .bg-success { background-color: #2e8b57 !important; }
    .bg-info { background-color: #17a2b8 !important; }
    .bg-warning { background-color: #ffc107 !important; }
    
    /* Required field indicator */
    .required::after {
        content: " *";
        color: #dc3545;
    }
    
    /* Loading spinner */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.2em;
    }
    
    /* Date format helper */
    .format-hint {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 3px;
    }
    
    /* Time input formatting */
    .time-format-example {
        font-size: 0.8rem;
        color: #28a745;
        font-family: monospace;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 5px;
    }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <img src="QFClogo.png" alt="QFC Logo" height="30" class="me-2">
            <div class="d-inline-block">
                <div class="qfc-brand">QFC Group Pvt Ltd</div>
                <div class="qfc-subtitle">Group Seat Platform</div>
            </div>
        </a>
        
        <!-- Mobile toggle button -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <!-- Navigation Links -->
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="index.html">
                        <i class="bi bi-house-door me-1"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="groups.html">
                        <i class="bi bi-people me-1"></i>Flight Groups
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#acquireForm">
                        <i class="bi bi-plus-circle me-1"></i>Acquire Seats
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-gear me-1"></i>More
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="sell-seats.html">
                            <i class="bi bi-cart-plus me-2"></i>Sell Seats
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="reports.html">
                            <i class="bi bi-bar-chart me-2"></i>Reports
                        </a></li>
                        <li><a class="dropdown-item" href="#">
                            <i class="bi bi-person-circle me-2"></i>Agents
                        </a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-people-fill"></i> Total Seats</h5>
                        <h2 id="totalSeats">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-cash-stack"></i> Investment</h5>
                        <h2 id="totalRevenue">0.00</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-file-text"></i> Acquisitions</h5>
                        <h2 id="totalAcquisitions">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-clock-history"></i> Pending</h5>
                        <h2 id="pendingItems">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acquire Seats Form -->
        <div class="card" id="acquireForm">
            <div class="card-header bg-light">
                <h4 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Acquire Seats Form</h4>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="formTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">Basic Info</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="flight-tab" data-bs-toggle="tab" data-bs-target="#flight" type="button" role="tab">Flight Details</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial" type="button" role="tab">Financial</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="emd-tab" data-bs-toggle="tab" data-bs-target="#emd" type="button" role="tab">EMD Details</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ticketing-tab" data-bs-toggle="tab" data-bs-target="#ticketing" type="button" role="tab">Ticketing</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="formTabsContent">
                    <!-- Basic Info Tab -->
                    <div class="tab-pane fade show active" id="basic" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">SR Number</label>
                                    <input type="text" class="form-control" id="srNumber" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Request Date</label>
                                    <input type="date" class="form-control" id="requestDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Investment Type</label>
                                    <select class="form-select" id="investmentType">
                                        <option value="Company Investment">Company Investment</option>
                                        <option value="Agent Investment">Agent Investment</option>
                                        <option value="block_space">Block Space</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">License/IATA</label>
                                    <select class="form-select" id="license">
                                        <option value="QTB">QTB</option>
                                        <option value="FCT">FCT</option>
                                        <option value="AG">AG</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Branch</label>
                                    <select class="form-select" id="branch">
                                        <option value="HO">HO</option>
                                        <option value="LHE">LHE</option>
                                        <option value="SKT">SKT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label required">Airline PNR</label>
                                    <input type="text" class="form-control" id="airlinePnr" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">GDS PNR</label>
                                    <input type="text" class="form-control" id="gdsPnr">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Segment</label>
                                    <select class="form-select" id="segment">
                                        <option value="Umrah">Umrah</option>
                                        <option value="Employment">Employment</option>
                                        <option value="Hajj">Hajj</option>
                                        <option value="Tours">Tours</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">Airline</label>
                                    <select class="form-select" id="airline" required>
                                        <option value="">Select Airline</option>
                                        <option value="SV">Saudi Airlines (SV)</option>
                                        <option value="PA">Airblue (PA)</option>
                                        <option value="PK">Pakistan Airlines (PK)</option>
                                        <option value="EK">Emirates (EK)</option>
                                        <option value="F3">Flyadeal (F3)</option>
                                        <option value="PF">Palestine Airlines (PF)</option>
                                        <option value="9P">PIA (9P)</option>
                                        <option value="J9">Jazeera Airways (J9)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">No. of Seats</label>
                                    <input type="number" class="form-control" id="noOfSeats" required min="1">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Sector</label>
                                    <input type="text" class="form-control" id="sector" placeholder="e.g., ISB-JED">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Flight Details Tab -->
                    <div class="tab-pane fade" id="flight" role="tabpanel">
                        <div class="row mb-4">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Flight Segments</label>
                <select class="form-select" id="flightSegments" onchange="toggleFlightSegments()">
                    <option value="2">Direct Flight (2 segments)</option>
                    <option value="4">Connecting Flight (4 segments)</option>
                </select>
                <div class="format-hint">Select 4 segments for flights with connections (e.g., Emirates, Qatar)</div>
            </div>
        </div>
    </div>
    
    <!-- OUTBOUND FLIGHTS -->
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="mb-3" style="color: #1a365d;">
                <i class="bi bi-airplane-engines me-2"></i>Outbound Journey
            </h5>
        </div>
        
        <!-- Direct Flight (2 segments) - Default Visible -->
        <div id="directOutbound" class="flight-segment-section">
            <div class="row">
                <div class="col-md-6">
                    <div class="flight-info-grid">
                        <div class="flight-field">
                            <label class="form-label">Flight Date</label>
                            <input type="date" class="form-control" id="outboundDate">
                            <div class="format-hint">e.g., 01-MAR-26</div>
                        </div>
                        <div class="flight-field">
                            <label class="form-label">Flight Number</label>
                            <input type="text" class="form-control" id="outboundFlight" 
                                   placeholder="e.g., SV723">
                        </div>
                        <div class="flight-field" style="grid-column: span 2;">
                            <label class="form-label">Departure & Arrival Times</label>
                            <input type="text" class="form-control" id="outboundTimes" 
                                   placeholder="e.g., ISB 0700 JED 1100">
                            <div class="format-hint">Format: [Departure Airport] [Time] [Arrival Airport] [Time]</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Connecting Flight (4 segments) - Hidden by Default -->
        <div id="connectingOutbound" class="flight-segment-section" style="display: none;">
            <div class="row">
                <!-- First Segment -->
                <div class="col-md-6">
                    <h6>First Segment (e.g., ISB → DXB)</h6>
                    <div class="flight-info-grid">
                        <div class="flight-field">
                            <label class="form-label">Flight Date</label>
                            <input type="date" class="form-control" id="outbound1Date">
                        </div>
                        <div class="flight-field">
                            <label class="form-label">Flight Number</label>
                            <input type="text" class="form-control" id="outbound1Flight" 
                                   placeholder="e.g., EK613">
                        </div>
                        <div class="flight-field" style="grid-column: span 2;">
                            <label class="form-label">Departure & Arrival Times</label>
                            <input type="text" class="form-control" id="outbound1Times" 
                                   placeholder="e.g., ISB 2200 DXB 0100">
                        </div>
                    </div>
                </div>
                
                <!-- Second Segment -->
                <div class="col-md-6">
                    <h6>Second Segment (e.g., DXB → JED)</h6>
                    <div class="flight-info-grid">
                        <div class="flight-field">
                            <label class="form-label">Flight Date</label>
                            <input type="date" class="form-control" id="outbound2Date">
                        </div>
                        <div class="flight-field">
                            <label class="form-label">Flight Number</label>
                            <input type="text" class="form-control" id="outbound2Flight" 
                                   placeholder="e.g., EK817">
                        </div>
                        <div class="flight-field" style="grid-column: span 2;">
                            <label class="form-label">Departure & Arrival Times</label>
                            <input type="text" class="form-control" id="outbound2Times" 
                                   placeholder="e.g., DXB 0800 JED 1100">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- INBOUND FLIGHTS -->
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="mb-3" style="color: #1a365d;">
                <i class="bi bi-airplane-engines me-2"></i>Inbound Journey
            </h5>
        </div>
        
        <!-- Direct Flight (2 segments) - Default Visible -->
        <div id="directInbound" class="flight-segment-section">
            <div class="row">
                <div class="col-md-6">
                    <div class="flight-info-grid">
                        <div class="flight-field">
                            <label class="form-label">Flight Date</label>
                            <input type="date" class="form-control" id="inboundDate">
                            <div class="format-hint">e.g., 15-MAR-26</div>
                        </div>
                        <div class="flight-field">
                            <label class="form-label">Flight Number</label>
                            <input type="text" class="form-control" id="inboundFlight" 
                                   placeholder="e.g., SV724">
                        </div>
                        <div class="flight-field" style="grid-column: span 2;">
                            <label class="form-label">Departure & Arrival Times</label>
                            <input type="text" class="form-control" id="inboundTimes" 
                                   placeholder="e.g., JED 0200 ISB 0500">
                            <div class="format-hint">Format: [Departure Airport] [Time] [Arrival Airport] [Time]</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Connecting Flight (4 segments) - Hidden by Default -->
        <div id="connectingInbound" class="flight-segment-section" style="display: none;">
            <div class="row">
                <!-- First Segment -->
                <div class="col-md-6">
                    <h6>First Segment (e.g., JED → DXB)</h6>
                    <div class="flight-info-grid">
                        <div class="flight-field">
                            <label class="form-label">Flight Date</label>
                            <input type="date" class="form-control" id="inbound1Date">
                        </div>
                        <div class="flight-field">
                            <label class="form-label">Flight Number</label>
                            <input type="text" class="form-control" id="inbound1Flight" 
                                   placeholder="e.g., EK818">
                        </div>
                        <div class="flight-field" style="grid-column: span 2;">
                            <label class="form-label">Departure & Arrival Times</label>
                            <input type="text" class="form-control" id="inbound1Times" 
                                   placeholder="e.g., JED 1300 DXB 1600">
                        </div>
                    </div>
                </div>
                
                <!-- Second Segment -->
                <div class="col-md-6">
                    <h6>Second Segment (e.g., DXB → ISB)</h6>
                    <div class="flight-info-grid">
                        <div class="flight-field">
                            <label class="form-label">Flight Date</label>
                            <input type="date" class="form-control" id="inbound2Date">
                        </div>
                        <div class="flight-field">
                            <label class="form-label">Flight Number</label>
                            <input type="text" class="form-control" id="inbound2Flight" 
                                   placeholder="e.g., EK614">
                        </div>
                        <div class="flight-field" style="grid-column: span 2;">
                            <label class="form-label">Departure & Arrival Times</label>
                            <input type="text" class="form-control" id="inbound2Times" 
                                   placeholder="e.g., DXB 2200 ISB 0200">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Informational Alert -->
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Note:</strong> For connecting flights (Emirates, Qatar, Etihad), select "4 segments". For direct flights (Saudia, PIA, Airblue), keep "2 segments".
    </div>
</div>

                    <!-- Financial Tab -->
                    <div class="tab-pane fade" id="financial" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label required">Fare</label>
                                    <input type="number" class="form-control" id="fare" step="0.01" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Taxes</label>
                                    <input type="number" class="form-control" id="taxes" step="0.01">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Payable Amount</label>
                                    <input type="number" class="form-control" id="payableAmount" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">PNR Amount</label>
                                    <input type="number" class="form-control" id="pnrAmount" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Issuance Date</label>
                                    <input type="date" class="form-control" id="issuanceDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">Time Limit</label>
                                    <input type="date" class="form-control" id="timeLimit" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Payment %</label>
                                    <input type="number" class="form-control" id="paymentPercentage" value="100" min="0" max="100">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- EMD Details Tab -->
                    <div class="tab-pane fade" id="emd" role="tabpanel">
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5>1st EMD Details</h5>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Number</label>
                                    <input type="text" class="form-control" id="emd1Number">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Amount</label>
                                    <input type="number" class="form-control" id="emd1Amount" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="emd1Status">
                                        <option value="">Select</option>
                                        <option value="paid">Paid</option>
                                        <option value="pending">Pending</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Time Limit</label>
                                    <input type="date" class="form-control" id="emd1TimeLimit">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Issuance Date</label>
                                    <input type="date" class="form-control" id="emd1IssuanceDate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Payment %</label>
                                    <input type="number" class="form-control" id="emd1PaymentPercent" min="0" max="100">
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <h5>2nd EMD Details</h5>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Number</label>
                                    <input type="text" class="form-control" id="emd2Number">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Amount</label>
                                    <input type="number" class="form-control" id="emd2Amount" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Time Limit</label>
                                    <input type="date" class="form-control" id="emd2TimeLimit">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <h5>3rd EMD Details</h5>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Number</label>
                                    <input type="text" class="form-control" id="emd3Number">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Amount</label>
                                    <input type="number" class="form-control" id="emd3Amount" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Time Limit</label>
                                    <input type="date" class="form-control" id="emd3TimeLimit">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ticketing Tab -->
                    <div class="tab-pane fade" id="ticketing" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">EMD Refund Date</label>
                                    <input type="date" class="form-control" id="emdRefundDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Ticketing Status</label>
                                    <select class="form-select" id="ticketingStatus">
                                        <option value="pending">Pending</option>
                                        <option value="partial">Partial</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">No. of Tickets Issued</label>
                                    <input type="number" class="form-control" id="ticketsIssued" min="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Balance Tickets</label>
                                    <input type="number" class="form-control" id="balanceTickets" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Last Ticket Date</label>
                                    <input type="date" class="form-control" id="lastTicketDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="overallStatus">
                                        <option value="draft">Draft</option>
                                        <option value="submitted">Submitted</option>
                                        <option value="approved">Approved</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="mt-4">
                    <button type="button" class="btn btn-primary btn-lg" id="saveButton">
                        <i class="bi bi-save me-2"></i>Save Acquisition
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2" id="resetButton">
                        <i class="bi bi-arrow-clockwise me-2"></i>Reset Form
                    </button>
                    <button type="button" class="btn btn-outline-warning ms-2" id="cancelEditBtn" style="display: none;">
                        <i class="bi bi-x-circle me-2"></i>Cancel Edit
                    </button>
                </div>
            </div>
        </div>

        <!-- Recent Acquisitions Table -->
        <div class="card mt-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-table me-2"></i>Recent Acquisitions</h4>
                <span class="badge bg-primary" id="tableCount">0 records</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="15%">SR #</th>
                                <th width="15%">Airline PNR</th>
                                <th width="10%">Seats</th>
                                <th width="12%">Fare</th>
                                <th width="12%">Status</th>
                                <th width="15%">Date</th>
                                <th width="21%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="acquisitionsTable">
                            <!-- Data loaded by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successMessage"></div>
        </div>
        <div id="errorToast" class="toast" role="alert">
            <div class="toast-header bg-danger text-white">
                <strong class="me-auto">Error!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="errorMessage"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- JavaScript Code -->
<script>
    // ========== GLOBAL VARIABLES ==========
    let acquisitions = [];
    let editingId = null;
    let supabaseClient = null;
    
    // ========== FLIGHT SEGMENTS TOGGLE FUNCTION ==========
    function toggleFlightSegments() {
        const segments = document.getElementById('flightSegments').value;
        const isDirect = segments === '2';
        
        // Toggle outbound sections
        const directOutbound = document.getElementById('directOutbound');
        const connectingOutbound = document.getElementById('connectingOutbound');
        const directInbound = document.getElementById('directInbound');
        const connectingInbound = document.getElementById('connectingInbound');
        
        if (directOutbound) directOutbound.style.display = isDirect ? 'block' : 'none';
        if (connectingOutbound) connectingOutbound.style.display = isDirect ? 'none' : 'block';
        if (directInbound) directInbound.style.display = isDirect ? 'block' : 'none';
        if (connectingInbound) connectingInbound.style.display = isDirect ? 'none' : 'block';
        
        // Clear fields when switching
        if (isDirect) {
            // Clear connecting flight fields
            ['outbound1', 'outbound2', 'inbound1', 'inbound2'].forEach(prefix => {
                ['Date', 'Flight', 'Times'].forEach(suffix => {
                    const elem = document.getElementById(prefix + suffix);
                    if (elem) elem.value = '';
                });
            });
        } else {
            // Clear direct flight fields
            ['outbound', 'inbound'].forEach(prefix => {
                ['Date', 'Flight', 'Times'].forEach(suffix => {
                    const elem = document.getElementById(prefix + suffix);
                    if (elem) elem.value = '';
                });
            });
        }
    }
    
    // ========== DATE FORMATTING FUNCTIONS ==========
    function convertDateToDisplayFormat(dateString) {
        if (!dateString) return '';
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            const day = String(date.getDate()).padStart(2, '0');
            const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                               'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const month = monthNames[date.getMonth()];
            const year = String(date.getFullYear()).slice(-2);
            
            return `${day}-${month}-${year}`;
        } catch (error) {
            console.error('Error converting date:', error);
            return dateString;
        }
    }
    
    function convertDisplayToDateInput(dateString) {
        if (!dateString) return '';
        
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
            return dateString;
        }
        
        try {
            const parts = dateString.split('-');
            if (parts.length !== 3) return dateString;
            
            const day = parts[0];
            const monthStr = parts[1].toUpperCase();
            const year = parts[2];
            
            const fullYear = year.length === 2 ? '20' + year : year;
            
            const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                               'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const monthIndex = monthNames.indexOf(monthStr);
            
            if (monthIndex === -1) return dateString;
            
            const month = String(monthIndex + 1).padStart(2, '0');
            return `${fullYear}-${month}-${day}`;
        } catch (error) {
            console.error('Error converting date for input:', error);
            return dateString;
        }
    }
    
    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
        console.log('QFC Group Platform - Initializing...');
        
        try {
            // Initialize Supabase
            const supabaseUrl = 'https://ojlxkzkialguthdeiley.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qbHhremtpYWxndXRoZGVpbGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTE0MjQsImV4cCI6MjA4NTMyNzQyNH0.CYH4hRn4w87vvvskkHOQMyKONyDWnvF7_m5IOfgPR94';
            
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                console.log('Supabase initialized successfully');
            } else {
                console.error('Supabase library not loaded');
            }
            
            // Set default dates
            initializeForm();
            
            // Initialize flight segments
            toggleFlightSegments();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize calculations
            calculateAmounts();
            calculateBalanceTickets();
            
            // Load existing data
            loadAcquisitions();
            
            console.log('App initialized successfully!');
            
        } catch (error) {
            console.error('Initialization error:', error);
            showError('Failed to initialize application: ' + error.message);
        }
    });
    
    function initializeForm() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('requestDate').value = today;
        
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        document.getElementById('timeLimit').value = nextWeek.toISOString().split('T')[0];
        
        // Generate initial SR number
        generateSRNumber();
        
        // Add input formatting for time fields
        setupInputFormatting();
    }
    
    function setupInputFormatting() {
        const timeInputs = document.querySelectorAll('input[placeholder*="ISB 0700"]');
        timeInputs.forEach(input => {
            input.addEventListener('input', function(e) {
                let value = e.target.value.toUpperCase();
                value = value.replace(/[^A-Z0-9\s]/g, '');
                
                if (value.length === 3 && !value.endsWith(' ')) {
                    value = value + ' ';
                }
                if (value.length === 8 && value.charAt(7) !== ' ') {
                    value = value.substring(0, 7) + ' ' + value.charAt(7);
                }
                if (value.length === 12 && value.charAt(11) !== ' ') {
                    value = value.substring(0, 11) + ' ' + value.charAt(11);
                }
                
                if (value.length > 17) {
                    value = value.substring(0, 17);
                }
                
                e.target.value = value;
            });
        });
    }
    
    // ========== EVENT LISTENERS SETUP ==========
    function setupEventListeners() {
        // Save button
        const saveButton = document.getElementById('saveButton');
        if (saveButton) {
            saveButton.addEventListener('click', saveAcquisition);
        }
        
        // Reset button
        const resetButton = document.getElementById('resetButton');
        if (resetButton) {
            resetButton.addEventListener('click', resetForm);
        }
        
        // Cancel edit button
        const cancelButton = document.getElementById('cancelEditBtn');
        if (cancelButton) {
            cancelButton.addEventListener('click', cancelEdit);
        }
        
        // Auto-calculation events
        document.getElementById('fare')?.addEventListener('input', calculateAmounts);
        document.getElementById('taxes')?.addEventListener('input', calculateAmounts);
        document.getElementById('paymentPercentage')?.addEventListener('input', calculateAmounts);
        document.getElementById('noOfSeats')?.addEventListener('input', calculateBalanceTickets);
        document.getElementById('ticketsIssued')?.addEventListener('input', calculateBalanceTickets);
    }
    
    // ========== HELPER FUNCTIONS ==========
    function generateSRNumber() {
        if (editingId) return;
        
        const srField = document.getElementById('srNumber');
        if (!srField) return;
        
        const date = new Date();
        const year = date.getFullYear().toString().slice(-2);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        srField.value = `SR${year}${month}${random}`;
    }
    
    function calculateAmounts() {
        try {
            const fare = parseFloat(document.getElementById('fare')?.value) || 0;
            const taxes = parseFloat(document.getElementById('taxes')?.value) || 0;
            const percentage = parseFloat(document.getElementById('paymentPercentage')?.value) || 100;
            const seats = parseInt(document.getElementById('noOfSeats')?.value) || 1;
            
            const totalPerSeat = fare + taxes;
            const totalPnrAmount = totalPerSeat * seats;
            const payable = totalPnrAmount * (percentage / 100);
            
            const pnrField = document.getElementById('pnrAmount');
            const payableField = document.getElementById('payableAmount');
            
            if (pnrField) pnrField.value = totalPnrAmount.toFixed(2);
            if (payableField) payableField.value = payable.toFixed(2);
        } catch (error) {
            console.error('Error in calculateAmounts:', error);
        }
    }
    
    function calculateBalanceTickets() {
        try {
            const totalSeats = parseInt(document.getElementById('noOfSeats')?.value) || 0;
            const issued = parseInt(document.getElementById('ticketsIssued')?.value) || 0;
            const balance = totalSeats - issued;
            
            const balanceField = document.getElementById('balanceTickets');
            if (balanceField) balanceField.value = balance > 0 ? balance : 0;
        } catch (error) {
            console.error('Error in calculateBalanceTickets:', error);
        }
    }
    
    // ========== FORM VALIDATION ==========
    function validateForm() {
        const errors = [];
        
        // Airline PNR validation
        const airlinePnr = document.getElementById('airlinePnr').value.trim();
        if (!airlinePnr || airlinePnr.length < 5) {
            errors.push('Airline PNR must be at least 5 characters');
        }
        
        // Number of seats validation
        const seats = parseInt(document.getElementById('noOfSeats').value);
        if (seats < 1 || seats > 1000) {
            errors.push('Number of seats must be between 1 and 1000');
        }
        
        // Date validation
        const timeLimit = document.getElementById('timeLimit').value;
        if (new Date(timeLimit) < new Date()) {
            errors.push('Time Limit must be in the future');
        }
        
        // Flight date validation
        const segments = document.getElementById('flightSegments').value;
        
        if (segments === '2') {
            const outboundDate = document.getElementById('outboundDate').value;
            const inboundDate = document.getElementById('inboundDate').value;
            
            if (outboundDate && inboundDate) {
                if (new Date(inboundDate) <= new Date(outboundDate)) {
                    errors.push('Inbound date must be after outbound date');
                }
            }
        } else {
            const outbound1Date = document.getElementById('outbound1Date').value;
            const inbound2Date = document.getElementById('inbound2Date').value;
            
            if (outbound1Date && inbound2Date) {
                if (new Date(inbound2Date) <= new Date(outbound1Date)) {
                    errors.push('Return date must be after departure date');
                }
            }
        }
        
        // Fare validation - REMOVED THE 100,000 LIMIT
        const fare = parseFloat(document.getElementById('fare').value);
        if (fare <= 0) {
            errors.push('Fare must be greater than 0');
        }
        // Removed: if (fare > 100000) check
        
        // Time format validation
        const segmentsValue = document.getElementById('flightSegments').value;
        
        if (segmentsValue === '2') {
            const outboundTimes = document.getElementById('outboundTimes')?.value;
            const inboundTimes = document.getElementById('inboundTimes')?.value;
            
            const timePattern = /^[A-Z]{3}\s+\d{4}\s+[A-Z]{3}\s+\d{4}$/;
            
            if (outboundTimes && !timePattern.test(outboundTimes.toUpperCase())) {
                errors.push('Outbound Times format: e.g., ISB 0700 JED 1100');
            }
            
            if (inboundTimes && !timePattern.test(inboundTimes.toUpperCase())) {
                errors.push('Inbound Times format: e.g., JED 0200 ISB 0500');
            }
        } else {
            const outbound1Times = document.getElementById('outbound1Times')?.value;
            const inbound2Times = document.getElementById('inbound2Times')?.value;
            
            const timePattern = /^[A-Z]{3}\s+\d{4}\s+[A-Z]{3}\s+\d{4}$/;
            
            if (outbound1Times && !timePattern.test(outbound1Times.toUpperCase())) {
                errors.push('First Outbound Segment Times format: e.g., ISB 2200 DXB 0100');
            }
            
            if (inbound2Times && !timePattern.test(inbound2Times.toUpperCase())) {
                errors.push('Last Inbound Segment Times format: e.g., DXB 2200 ISB 0200');
            }
        }
        
        return errors;
    }
    
    // ========== MAIN SAVE FUNCTION ==========
    async function saveAcquisition() {
        console.log('Saving acquisition...');
        
        // Validate form
        const validationErrors = validateForm();
        if (validationErrors.length > 0) {
            showError(validationErrors.join('<br>'));
            return;
        }
        
        // Disable save button and show loading
        const saveButton = document.getElementById('saveButton');
        const originalText = saveButton?.innerHTML;
        if (saveButton) {
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Saving...';
        }
        
        try {
            // Get flight segment type
            const segments = document.getElementById('flightSegments').value;
            const isDirect = segments === '2';
            
            // Prepare flight data based on segment type
            let outboundDate, inboundDate;
            let outbound1Date, inbound1Date, outbound1Flight, inbound1Flight, outbound1Times, inbound1Times;
            let outbound2Date, inbound2Date, outbound2Flight, inbound2Flight, outbound2Times, inbound2Times;
            
            if (isDirect) {
                // Direct flight data
                outboundDate = document.getElementById('outboundDate')?.value;
                inboundDate = document.getElementById('inboundDate')?.value;
                
                // For direct flights, use inbound1_flight and outbound1_flight columns
                outbound1Flight = document.getElementById('outboundFlight')?.value;
                inbound1Flight = document.getElementById('inboundFlight')?.value;
                outbound1Times = document.getElementById('outboundTimes')?.value;
                inbound1Times = document.getElementById('inboundTimes')?.value;
                
                // Clear connecting flight fields
                outbound2Date = null;
                inbound2Date = null;
                outbound2Flight = null;
                inbound2Flight = null;
                outbound2Times = null;
                inbound2Times = null;
                
                // Convert dates to DD-MMM-YY format
                outboundDate = outboundDate ? convertDateToDisplayFormat(outboundDate) : null;
                inboundDate = inboundDate ? convertDateToDisplayFormat(inboundDate) : null;
            } else {
                // Connecting flight data
                outbound1Date = document.getElementById('outbound1Date')?.value;
                outbound2Date = document.getElementById('outbound2Date')?.value;
                inbound1Date = document.getElementById('inbound1Date')?.value;
                inbound2Date = document.getElementById('inbound2Date')?.value;
                
                outbound1Flight = document.getElementById('outbound1Flight')?.value;
                outbound2Flight = document.getElementById('outbound2Flight')?.value;
                inbound1Flight = document.getElementById('inbound1Flight')?.value;
                inbound2Flight = document.getElementById('inbound2Flight')?.value;
                
                outbound1Times = document.getElementById('outbound1Times')?.value;
                outbound2Times = document.getElementById('outbound2Times')?.value;
                inbound1Times = document.getElementById('inbound1Times')?.value;
                inbound2Times = document.getElementById('inbound2Times')?.value;
                
                // Clear direct flight dates
                outboundDate = null;
                inboundDate = null;
                
                // Convert dates to DD-MMM-YY format
                outbound1Date = outbound1Date ? convertDateToDisplayFormat(outbound1Date) : null;
                outbound2Date = outbound2Date ? convertDateToDisplayFormat(outbound2Date) : null;
                inbound1Date = inbound1Date ? convertDateToDisplayFormat(inbound1Date) : null;
                inbound2Date = inbound2Date ? convertDateToDisplayFormat(inbound2Date) : null;
            }
            
            // Get form data - MATCHING YOUR DATABASE COLUMN NAMES EXACTLY
            const formData = {
                // Basic Info
                sr_number: document.getElementById('srNumber')?.value || '',
                request_date: document.getElementById('requestDate')?.value || new Date().toISOString().split('T')[0],
                investment_type: document.getElementById('investmentType')?.value || 'Company Investment',
                license: document.getElementById('license')?.value || 'QFC',
                branch: document.getElementById('branch')?.value || 'HO',
                airline_pnr: document.getElementById('airlinePnr')?.value || '',
                gds_pnr: document.getElementById('gdsPnr')?.value || null,
                segment: document.getElementById('segment')?.value || 'Umrah',
                airline: document.getElementById('airline')?.value || '',
                no_of_seats: parseInt(document.getElementById('noOfSeats')?.value) || 0,
                
                // Flight Details - Using your actual database column names
                flight_segments: segments,
                
                // Direct flight dates
                outbound_date: outboundDate,
                inbound_date: inboundDate,
                
                // Connecting flight dates
                outbound1_date: outbound1Date,
                outbound2_date: outbound2Date,
                inbound1_date: inbound1Date,
                inbound2_date: inbound2Date,
                
                // Flight numbers - Using your actual database column names
                outbound1_flight: outbound1Flight,
                outbound2_flight: outbound2Flight,
                inbound1_flight: inbound1Flight,
                inbound2_flight: inbound2Flight,
                
                // Flight times - Using your actual database column names
                outbound1_times: outbound1Times ? outbound1Times.toUpperCase() : null,
                outbound2_times: outbound2Times ? outbound2Times.toUpperCase() : null,
                inbound1_times: inbound1Times ? inbound1Times.toUpperCase() : null,
                inbound2_times: inbound2Times ? inbound2Times.toUpperCase() : null,
                
                sector: document.getElementById('sector')?.value || '',
                
                // Financial - FARES CAN NOW EXCEED 100,000
                fare: parseFloat(document.getElementById('fare')?.value) || 0,
                taxes: parseFloat(document.getElementById('taxes')?.value) || 0,
                payable_amount: parseFloat(document.getElementById('payableAmount')?.value) || 0,
                pnr_amount: parseFloat(document.getElementById('pnrAmount')?.value) || 0,
                issuance_date: document.getElementById('issuanceDate')?.value || null,
                time_limit: document.getElementById('timeLimit')?.value || '',
                payment_percentage: parseFloat(document.getElementById('paymentPercentage')?.value) || 100,
                
                // EMD Details
                emd_refund_date: document.getElementById('emdRefundDate')?.value || null,
                first_emd_number: document.getElementById('emd1Number')?.value || null,
                first_emd_amount: document.getElementById('emd1Amount')?.value ? parseFloat(document.getElementById('emd1Amount').value) : null,
                first_emd_status: document.getElementById('emd1Status')?.value || null,
                first_emd_time_limit: document.getElementById('emd1TimeLimit')?.value || null,
                first_emd_issuance_date: document.getElementById('emd1IssuanceDate')?.value || null,
                first_emd_payment_percentage: document.getElementById('emd1PaymentPercent')?.value ? parseFloat(document.getElementById('emd1PaymentPercent').value) : null,
                second_emd_number: document.getElementById('emd2Number')?.value || null,
                second_emd_amount: document.getElementById('emd2Amount')?.value ? parseFloat(document.getElementById('emd2Amount').value) : null,
                second_emd_time_limit: document.getElementById('emd2TimeLimit')?.value || null,
                third_emd_number: document.getElementById('emd3Number')?.value || null,
                third_emd_amount: document.getElementById('emd3Amount')?.value ? parseFloat(document.getElementById('emd3Amount').value) : null,
                third_emd_time_limit: document.getElementById('emd3TimeLimit')?.value || null,
                
                // Ticketing
                ticketing_status: document.getElementById('ticketingStatus')?.value || 'pending',
                no_of_tickets_issued: parseInt(document.getElementById('ticketsIssued')?.value) || 0,
                balance_tickets: parseInt(document.getElementById('balanceTickets')?.value) || 0,
                last_ticket_date: document.getElementById('lastTicketDate')?.value || null,
                status: document.getElementById('overallStatus')?.value || 'draft',
                notes: document.getElementById('notes')?.value || null,
                updated_at: new Date().toISOString()
            };
            
            console.log('Saving data with correct column names:', formData);
            
            if (editingId) {
                // Update existing record
                const { data, error } = await supabaseClient
                    .from('seat_acquisitions')
                    .update(formData)
                    .eq('id', editingId)
                    .select();
                
                if (error) throw error;
                
                showSuccess('✅ Updated successfully! SR#: ' + formData.sr_number);
                editingId = null;
            } else {
                // Insert new record
                const { data, error } = await supabaseClient
                    .from('seat_acquisitions')
                    .insert([formData])
                    .select();
                
                if (error) throw error;
                
                showSuccess('✅ Saved successfully! SR#: ' + formData.sr_number);
            }
            
            // Reset form and reload data
            resetForm();
            await loadAcquisitions();
            
        } catch (error) {
            console.error('Save error:', error);
            showError('❌ Error saving: ' + (error.message || 'Please check console for details'));
        } finally {
            // Re-enable save button
            if (saveButton) {
                saveButton.disabled = false;
                saveButton.innerHTML = originalText;
            }
        }
    }
    
    // ========== OTHER FUNCTIONS ==========
    async function loadAcquisitions() {
        try {
            if (!supabaseClient) {
                console.log('Supabase not initialized, using localStorage');
                const savedData = localStorage.getItem('qfc_acquisitions');
                acquisitions = savedData ? JSON.parse(savedData) : [];
                updateTable();
                updateDashboard();
                return;
            }
            
            const { data, error } = await supabaseClient
                .from('seat_acquisitions')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(20);
            
            if (error) throw error;
            
            acquisitions = data || [];
            updateTable();
            updateDashboard();
            
            localStorage.setItem('qfc_acquisitions', JSON.stringify(acquisitions));
            
        } catch (error) {
            console.error('Load error:', error);
            const savedData = localStorage.getItem('qfc_acquisitions');
            acquisitions = savedData ? JSON.parse(savedData) : [];
            updateTable();
            updateDashboard();
            showError('Using offline data. Please check internet connection.');
        }
    }
    
    function updateTable() {
        const tableBody = document.getElementById('acquisitionsTable');
        const tableCount = document.getElementById('tableCount');
        
        if (!acquisitions || acquisitions.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <div class="text-muted">
                            <i class="bi bi-inbox display-6"></i>
                            <p class="mt-2">No acquisitions yet</p>
                            <small>Save your first acquisition above</small>
                        </div>
                    </td>
                </tr>
            `;
            if (tableCount) tableCount.textContent = '0 records';
            return;
        }
        
        let html = '';
        acquisitions.forEach(item => {
            const id = item.id || '';
            const isEditing = editingId === id;
            const rowClass = isEditing ? 'table-warning' : '';
            
            let statusClass = 'status-draft';
            if (item.status === 'approved') statusClass = 'status-approved';
            if (item.status === 'submitted') statusClass = 'status-pending';
            
            html += `
                <tr class="${rowClass}">
                    <td><strong>${item.sr_number || ''}</strong></td>
                    <td>${item.airline_pnr || ''}</td>
                    <td>${item.no_of_seats || 0}</td>
                    <td>${item.fare ? parseFloat(item.fare).toFixed(2) : '0.00'}</td>
                    <td><span class="status-badge ${statusClass}">${item.status || 'draft'}</span></td>
                    <td>${item.created_at ? new Date(item.created_at).toLocaleDateString() : ''}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editItem('${id}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteItem('${id}', '${item.sr_number}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
        if (tableCount) tableCount.textContent = `${acquisitions.length} records`;
    }
    
    function updateDashboard() {
        if (!acquisitions || acquisitions.length === 0) {
            document.getElementById('totalSeats').textContent = '0';
            document.getElementById('totalRevenue').textContent = '0.00';
            document.getElementById('totalAcquisitions').textContent = '0';
            document.getElementById('pendingItems').textContent = '0';
            return;
        }
        
        const totalSeats = acquisitions.reduce((sum, item) => sum + (item.no_of_seats || 0), 0);
        const totalRevenue = acquisitions.reduce((sum, item) => sum + (item.pnr_amount || 0), 0);
        const pendingCount = acquisitions.filter(item => item.status === 'draft' || item.status === 'submitted').length;
        
        document.getElementById('totalSeats').textContent = totalSeats;
        document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2);
        document.getElementById('totalAcquisitions').textContent = acquisitions.length;
        document.getElementById('pendingItems').textContent = pendingCount;
    }
    
    function resetForm() {
        editingId = null;
        
        // Reset flight segments to default
        document.getElementById('flightSegments').value = '2';
        toggleFlightSegments();
        
        // Generate new SR number
        generateSRNumber();
        
        // Clear form fields
        const fieldsToClear = [
            'airlinePnr', 'gdsPnr', 'noOfSeats', 'outboundDate', 'inboundDate',
            'outboundFlight', 'inboundFlight', 'outboundTimes', 'inboundTimes',
            'outbound1Date', 'outbound2Date', 'inbound1Date', 'inbound2Date',
            'outbound1Flight', 'outbound2Flight', 'inbound1Flight', 'inbound2Flight',
            'outbound1Times', 'outbound2Times', 'inbound1Times', 'inbound2Times',
            'sector', 'fare', 'taxes', 'issuanceDate', 'emdRefundDate',
            'emd1Number', 'emd1Amount', 'emd1TimeLimit', 'emd1IssuanceDate', 'emd1PaymentPercent',
            'emd2Number', 'emd2Amount', 'emd2TimeLimit', 'emd3Number', 'emd3Amount', 'emd3TimeLimit',
            'ticketsIssued', 'lastTicketDate', 'notes'
        ];
        
        fieldsToClear.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = '';
        });
        
        // Reset select fields to defaults
        document.getElementById('investmentType').value = 'Company Investment';
        document.getElementById('license').value = 'QFC';
        document.getElementById('branch').value = 'HO';
        document.getElementById('segment').value = 'Umrah';
        document.getElementById('airline').value = '';
        document.getElementById('emd1Status').value = '';
        document.getElementById('ticketingStatus').value = 'pending';
        document.getElementById('overallStatus').value = 'draft';
        document.getElementById('paymentPercentage').value = '100';
        
        // Set default dates
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('requestDate').value = today;
        
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        document.getElementById('timeLimit').value = nextWeek.toISOString().split('T')[0];
        
        // Recalculate
        calculateAmounts();
        calculateBalanceTickets();
        
        // Update UI buttons
        document.getElementById('saveButton').innerHTML = '<i class="bi bi-save me-2"></i>Save Acquisition';
        document.getElementById('saveButton').className = 'btn btn-primary btn-lg';
        document.getElementById('cancelEditBtn').style.display = 'none';
        
        // Switch to first tab
        const firstTab = document.querySelector('#basic-tab');
        if (firstTab) firstTab.click();
        
        // Update table
        updateTable();
        
        showSuccess('Form reset successfully');
    }
    
    function cancelEdit() {
        resetForm();
    }
    
    async function editItem(id) {
        try {
            // Find item in local array first
            const item = acquisitions.find(item => item.id == id);
            if (!item) {
                showError('Item not found');
                return;
            }
            
            editingId = id;
            
            // Set flight segments
            const segments = item.flight_segments || '2';
            document.getElementById('flightSegments').value = segments;
            toggleFlightSegments();
            
            // Convert dates from DD-MMM-YY to YYYY-MM-DD for calendar input
            const outboundDateForInput = item.outbound_date ? convertDisplayToDateInput(item.outbound_date) : '';
            const inboundDateForInput = item.inbound_date ? convertDisplayToDateInput(item.inbound_date) : '';
            const outbound1DateForInput = item.outbound1_date ? convertDisplayToDateInput(item.outbound1_date) : '';
            const outbound2DateForInput = item.outbound2_date ? convertDisplayToDateInput(item.outbound2_date) : '';
            const inbound1DateForInput = item.inbound1_date ? convertDisplayToDateInput(item.inbound1_date) : '';
            const inbound2DateForInput = item.inbound2_date ? convertDisplayToDateInput(item.inbound2_date) : '';
            
            // Fill form with item data - USING CORRECT DATABASE COLUMN NAMES
            const fields = [
                { id: 'srNumber', value: item.sr_number },
                { id: 'requestDate', value: item.request_date },
                { id: 'investmentType', value: item.investment_type },
                { id: 'license', value: item.license },
                { id: 'branch', value: item.branch },
                { id: 'airlinePnr', value: item.airline_pnr },
                { id: 'gdsPnr', value: item.gds_pnr },
                { id: 'segment', value: item.segment },
                { id: 'airline', value: item.airline },
                { id: 'noOfSeats', value: item.no_of_seats },
                { id: 'outboundDate', value: outboundDateForInput },
                { id: 'inboundDate', value: inboundDateForInput },
                { id: 'outboundFlight', value: item.outbound1_flight },
                { id: 'inboundFlight', value: item.inbound1_flight },
                { id: 'outboundTimes', value: item.outbound1_times },
                { id: 'inboundTimes', value: item.inbound1_times },
                { id: 'outbound1Date', value: outbound1DateForInput },
                { id: 'outbound2Date', value: outbound2DateForInput },
                { id: 'inbound1Date', value: inbound1DateForInput },
                { id: 'inbound2Date', value: inbound2DateForInput },
                { id: 'outbound1Flight', value: item.outbound1_flight },
                { id: 'outbound2Flight', value: item.outbound2_flight },
                { id: 'inbound1Flight', value: item.inbound1_flight },
                { id: 'inbound2Flight', value: item.inbound2_flight },
                { id: 'outbound1Times', value: item.outbound1_times },
                { id: 'outbound2Times', value: item.outbound2_times },
                { id: 'inbound1Times', value: item.inbound1_times },
                { id: 'inbound2Times', value: item.inbound2_times },
                { id: 'sector', value: item.sector },
                { id: 'fare', value: item.fare },
                { id: 'taxes', value: item.taxes },
                { id: 'paymentPercentage', value: item.payment_percentage },
                { id: 'issuanceDate', value: item.issuance_date },
                { id: 'timeLimit', value: item.time_limit },
                { id: 'emdRefundDate', value: item.emd_refund_date },
                { id: 'emd1Number', value: item.first_emd_number },
                { id: 'emd1Amount', value: item.first_emd_amount },
                { id: 'emd1Status', value: item.first_emd_status },
                { id: 'emd1TimeLimit', value: item.first_emd_time_limit },
                { id: 'emd1IssuanceDate', value: item.first_emd_issuance_date },
                { id: 'emd1PaymentPercent', value: item.first_emd_payment_percentage },
                { id: 'emd2Number', value: item.second_emd_number },
                { id: 'emd2Amount', value: item.second_emd_amount },
                { id: 'emd2TimeLimit', value: item.second_emd_time_limit },
                { id: 'emd3Number', value: item.third_emd_number },
                { id: 'emd3Amount', value: item.third_emd_amount },
                { id: 'emd3TimeLimit', value: item.third_emd_time_limit },
                { id: 'ticketingStatus', value: item.ticketing_status },
                { id: 'ticketsIssued', value: item.no_of_tickets_issued },
                { id: 'lastTicketDate', value: item.last_ticket_date },
                { id: 'overallStatus', value: item.status },
                { id: 'notes', value: item.notes }
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element && field.value !== null && field.value !== undefined) {
                    element.value = field.value;
                }
            });
            
            // Recalculate
            calculateAmounts();
            calculateBalanceTickets();
            
            // Update UI
            document.getElementById('saveButton').innerHTML = '<i class="bi bi-pencil-square me-2"></i>Update';
            document.getElementById('saveButton').className = 'btn btn-warning btn-lg';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            
            // Switch to flight tab to show the dates
            const flightTab = document.querySelector('#flight-tab');
            if (flightTab) flightTab.click();
            
            // Scroll to form
            document.getElementById('acquireForm').scrollIntoView({ behavior: 'smooth' });
            
            showSuccess('Editing: ' + item.sr_number);
            
        } catch (error) {
            console.error('Edit error:', error);
            showError('Failed to load for editing');
        }
    }
    
    async function deleteItem(id, srNumber) {
        if (!confirm(`Are you sure you want to delete ${srNumber}? This action cannot be undone.`)) return;
        
        try {
            if (supabaseClient) {
                const { error } = await supabaseClient
                    .from('seat_acquisitions')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
            }
            
            // Remove from local array
            acquisitions = acquisitions.filter(item => item.id != id);
            
            // Update localStorage
            localStorage.setItem('qfc_acquisitions', JSON.stringify(acquisitions));
            
            // If we were editing this item, cancel edit
            if (editingId == id) {
                resetForm();
            }
            
            // Update UI
            updateTable();
            updateDashboard();
            
            showSuccess('Deleted: ' + srNumber);
            
        } catch (error) {
            console.error('Delete error:', error);
            showError('Failed to delete');
        }
    }
    
    // ========== NOTIFICATION FUNCTIONS ==========
    function showSuccess(message) {
        const successToast = document.getElementById('successToast');
        const successMessage = document.getElementById('successMessage');
        
        if (successMessage) successMessage.textContent = message;
        if (successToast) {
            const toast = new bootstrap.Toast(successToast);
            toast.show();
        }
    }
    
    function showError(message) {
        const errorToast = document.getElementById('errorToast');
        const errorMessage = document.getElementById('errorMessage');
        
        if (errorMessage) errorMessage.innerHTML = message;
        if (errorToast) {
            const toast = new bootstrap.Toast(errorToast);
            toast.show();
        }
    }
    
    // ========== CSV EXPORT FUNCTION ==========
    function exportToCSV() {
        if (acquisitions.length === 0) {
            showError('No data to export');
            return;
        }
        
        const headers = ['SR#', 'Airline PNR', 'Seats', 'Fare', 'Status', 'Date', 'Airline', 'Sector'];
        
        const csvRows = [
            headers.join(','),
            ...acquisitions.map(item => [
                `"${item.sr_number || ''}"`,
                `"${item.airline_pnr || ''}"`,
                item.no_of_seats || 0,
                item.fare || 0,
                `"${item.status || ''}"`,
                `"${item.created_at ? new Date(item.created_at).toLocaleDateString() : ''}"`,
                `"${item.airline || ''}"`,
                `"${item.sector || ''}"`
            ].join(','))
        ];
        
        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `qfc-acquisitions-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        showSuccess(`Exported ${acquisitions.length} records`);
    }
    
    // ========== GLOBAL FUNCTION EXPORTS ==========
    window.saveAcquisition = saveAcquisition;
    window.resetForm = resetForm;
    window.cancelEdit = cancelEdit;
    window.editItem = editItem;
    window.deleteItem = deleteItem;
    window.toggleFlightSegments = toggleFlightSegments;
    window.exportToCSV = exportToCSV;
</script>
</body>
</html>
