<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QFC Group Pvt Ltd - Group Seat Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
    /* ========== GLOBAL STYLES ========== */
    body { 
        background-color: #f8f9fa; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding-bottom: 50px;
    }
    
    /* ========== NAVBAR ========== */
    .navbar-brand { 
        font-weight: bold; 
        color: #0d6efd !important; 
        font-size: 1.3rem;
    }
    .navbar {
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 0.8rem 0;
    }
    
    /* ========== CARDS ========== */
    .card { 
        border-radius: 12px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        margin-bottom: 24px;
        border: 1px solid #e9ecef;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
        font-weight: 600;
    }
    
    /* ========== FORM ELEMENTS ========== */
    .form-control, .form-select { 
        border-radius: 8px; 
        padding: 10px 14px;
        border: 1px solid #ced4da;
        transition: all 0.2s;
    }
    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }
    .form-label {
        font-weight: 500;
        margin-bottom: 6px;
        color: #495057;
    }
    
    /* ========== BUTTONS ========== */
    .btn-primary { 
        background-color: #1a365d;
        border-color: #1a365d;
        padding: 10px 24px; 
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s;
    }
    .btn-primary:hover {
        background-color: #2d4a8c;
        border-color: #2d4a8c;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
    }
    .btn-outline-secondary {
        border: 2px solid #6c757d;
        font-weight: 500;
    }
    .btn-outline-warning {
        border: 2px solid #ffc107;
        font-weight: 500;
    }
    .btn-lg {
        padding: 12px 28px;
        font-size: 1.1rem;
    }
    
    /* ========== ACTION BUTTONS ========== */
    .btn-group-sm > .btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.85rem;
        border-radius: 6px;
    }
    .btn-outline-primary {
        border-color: #0d6efd;
        color: #0d6efd;
    }
    .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(13, 110, 253, 0.2);
    }
    .btn-outline-danger {
        border-color: #dc3545;
        color: #dc3545;
    }
    .btn-outline-danger:hover {
        background-color: #dc3545;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(220, 53, 69, 0.2);
    }
    
    /* ========== STATUS BADGES ========== */
    .status-badge { 
        padding: 5px 12px; 
        border-radius: 20px; 
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
        min-width: 80px;
        text-align: center;
    }
    .status-draft { 
        background-color: #fff3cd; 
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    .status-approved { 
        background-color: #d1e7dd; 
        color: #0f5132;
        border: 1px solid #badbcc;
    }
    .status-pending { 
        background-color: #cff4fc; 
        color: #055160;
        border: 1px solid #b6effb;
    }
    
    /* ========== TABLE STYLING ========== */
    .table {
        margin-bottom: 0;
    }
    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        padding: 1rem;
        white-space: nowrap;
    }
    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-top: 1px solid #e9ecef;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    .table-warning {
        background-color: rgba(255, 193, 7, 0.1) !important;
        border-left: 4px solid #ffc107;
    }
    
    /* ========== TABS ========== */
    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 0;
    }
    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 0.8rem 1.5rem;
        margin-bottom: -2px;
        border-radius: 8px 8px 0 0;
    }
    .nav-tabs .nav-link:hover {
        color: #0d6efd;
        background-color: #f8f9fa;
    }
    .nav-tabs .nav-link.active { 
        background-color: #fff; 
        border: 2px solid #dee2e6;
        border-bottom-color: #fff;
        color: #0d6efd;
        font-weight: 600;
    }
    .tab-content { 
        border: 2px solid #dee2e6; 
        border-top: none; 
        padding: 24px;
        background-color: white;
        border-radius: 0 0 8px 8px;
    }
    
    /* ========== DASHBOARD CARDS ========== */
    .dashboard-card {
        border-radius: 10px;
        color: white;
        padding: 1.5rem;
        height: 100%;
        transition: transform 0.3s;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
    }
    .dashboard-card i {
        font-size: 2rem;
        margin-bottom: 10px;
        opacity: 0.9;
    }
    .dashboard-card h5 {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 5px;
    }
    .dashboard-card h2 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0;
    }
    
    /* ========== BADGES ========== */
    .badge {
        padding: 0.35em 0.65em;
        font-weight: 500;
        border-radius: 10px;
    }
    .bg-success-light {
        background-color: rgba(25, 135, 84, 0.1);
        color: #198754;
    }
    .bg-secondary-light {
        background-color: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }
    
    /* ========== TOAST NOTIFICATIONS ========== */
    .toast {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: none;
    }
    .toast-header {
        border-radius: 8px 8px 0 0;
        font-weight: 600;
    }
    
    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .container {
            padding-left: 15px;
            padding-right: 15px;
        }
        .btn-lg {
            padding: 10px 20px;
            font-size: 1rem;
        }
        .nav-tabs .nav-link {
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
        }
        .table-responsive {
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
    }
    
    /* ========== QFC BRANDING ========== */
    .qfc-brand {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-weight: 700;
        color: #1a365d;
    }
    .qfc-subtitle {
        font-size: 10px;
        color: #6c757d;
        letter-spacing: 0.5px;
        font-weight: 400;
    }
    .card-header.bg-light {
        border-left: 4px solid #1a365d;
    }
    .bg-primary { background-color: #1a365d !important; }
    .bg-success { background-color: #2e8b57 !important; }
    .bg-info { background-color: #17a2b8 !important; }
    .bg-warning { background-color: #ffc107 !important; }
    
    /* Required field indicator */
    .required::after {
        content: " *";
        color: #dc3545;
    }
    
    /* Loading spinner */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.2em;
    }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="QFClogo.png" alt="QFC Logo" height="30" class="me-2">
                <div class="d-inline-block">
                    <div class="qfc-brand">QFC Group Pvt Ltd</div>
                    <div class="qfc-subtitle">Group Seat Platform</div>
                </div>
            </a>
            <div class="navbar-nav">
                <a class="nav-link active" href="#"><i class="bi bi-house-door me-1"></i>Dashboard</a>
                <a class="nav-link" href="#acquireForm"><i class="bi bi-plus-circle me-1"></i>Acquire Seats</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-people-fill"></i> Total Seats</h5>
                        <h2 id="totalSeats">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-cash-stack"></i> Revenue</h5>
                        <h2 id="totalRevenue">0.00</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-file-text"></i> Acquisitions</h5>
                        <h2 id="totalAcquisitions">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-clock-history"></i> Pending</h5>
                        <h2 id="pendingItems">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acquire Seats Form -->
        <div class="card" id="acquireForm">
            <div class="card-header bg-light">
                <h4 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Acquire Seats Form</h4>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="formTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">Basic Info</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial" type="button" role="tab">Financial</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="emd-tab" data-bs-toggle="tab" data-bs-target="#emd" type="button" role="tab">EMD Details</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ticketing-tab" data-bs-toggle="tab" data-bs-target="#ticketing" type="button" role="tab">Ticketing</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="formTabsContent">
                    <!-- Basic Info Tab -->
                    <div class="tab-pane fade show active" id="basic" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">SR Number</label>
                                    <input type="text" class="form-control" id="srNumber" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Request Date</label>
                                    <input type="date" class="form-control" id="requestDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Investment Type</label>
                                    <select class="form-select" id="investmentType">
                                        <option value="Company Investment">Company Investment</option>
                                        <option value="Agent Investment">Agent Investment</option>
                                        <option value="block_space">Block Space</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">License/IATA</label>
                                    <select class="form-select" id="license">
                                        <option value="QFC">QFC</option>
                                        <option value="FCT">FCT</option>
                                        <option value="AG">AG</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Branch</label>
                                    <select class="form-select" id="branch">
                                        <option value="HO">HO</option>
                                        <option value="LHE">LHE</option>
                                        <option value="SKT">SKT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label required">Airline PNR</label>
                                    <input type="text" class="form-control" id="airlinePnr" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">GDS PNR</label>
                                    <input type="text" class="form-control" id="gdsPnr">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Segment</label>
                                    <select class="form-select" id="segment">
                                        <option value="Umrah">Umrah</option>
                                        <option value="Employment">Employment</option>
                                        <option value="Hajj">Hajj</option>
                                        <option value="Tours">Tours</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">Airline</label>
                                    <select class="form-select" id="airline" required>
                                        <option value="">Select Airline</option>
                                        <option value="SV">SV</option>
                                        <option value="PA">PA</option>
                                        <option value="PF">PF</option>
                                        <option value="9P">9P</option>
                                        <option value="J9">J9</option>
                                        <option value="PK">PK</option>
                                        <option value="EK">EK</option>
                                        <option value="F3">F3</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">No. of Seats</label>
                                    <input type="number" class="form-control" id="noOfSeats" required min="1">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Outbound Date</label>
                                    <input type="date" class="form-control" id="outboundDate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Inbound Date</label>
                                    <input type="date" class="form-control" id="inboundDate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Sector</label>
                                    <input type="text" class="form-control" id="sector" placeholder="e.g., JFK-LAX">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Tab -->
                    <div class="tab-pane fade" id="financial" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label required">Fare</label>
                                    <input type="number" class="form-control" id="fare" step="0.01" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Taxes</label>
                                    <input type="number" class="form-control" id="taxes" step="0.01">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Payable Amount</label>
                                    <input type="number" class="form-control" id="payableAmount" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">PNR Amount</label>
                                    <input type="number" class="form-control" id="pnrAmount" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Issuance Date</label>
                                    <input type="date" class="form-control" id="issuanceDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">Time Limit</label>
                                    <input type="date" class="form-control" id="timeLimit" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Payment %</label>
                                    <input type="number" class="form-control" id="paymentPercentage" value="100" min="0" max="100">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- EMD Details Tab -->
                    <div class="tab-pane fade" id="emd" role="tabpanel">
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5>1st EMD Details</h5>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Number</label>
                                    <input type="text" class="form-control" id="emd1Number">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Amount</label>
                                    <input type="number" class="form-control" id="emd1Amount" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="emd1Status">
                                        <option value="">Select</option>
                                        <option value="paid">Paid</option>
                                        <option value="pending">Pending</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Time Limit</label>
                                    <input type="date" class="form-control" id="emd1TimeLimit">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Issuance Date</label>
                                    <input type="date" class="form-control" id="emd1IssuanceDate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Payment %</label>
                                    <input type="number" class="form-control" id="emd1PaymentPercent" min="0" max="100">
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <h5>2nd EMD Details</h5>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Number</label>
                                    <input type="text" class="form-control" id="emd2Number">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Amount</label>
                                    <input type="number" class="form-control" id="emd2Amount" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Time Limit</label>
                                    <input type="date" class="form-control" id="emd2TimeLimit">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <h5>3rd EMD Details</h5>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Number</label>
                                    <input type="text" class="form-control" id="emd3Number">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">EMD Amount</label>
                                    <input type="number" class="form-control" id="emd3Amount" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Time Limit</label>
                                    <input type="date" class="form-control" id="emd3TimeLimit">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ticketing Tab -->
                    <div class="tab-pane fade" id="ticketing" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">EMD Refund Date</label>
                                    <input type="date" class="form-control" id="emdRefundDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Ticketing Status</label>
                                    <select class="form-select" id="ticketingStatus">
                                        <option value="pending">Pending</option>
                                        <option value="partial">Partial</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">No. of Tickets Issued</label>
                                    <input type="number" class="form-control" id="ticketsIssued" min="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Balance Tickets</label>
                                    <input type="number" class="form-control" id="balanceTickets" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Last Ticket Date</label>
                                    <input type="date" class="form-control" id="lastTicketDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="overallStatus">
                                        <option value="draft">Draft</option>
                                        <option value="submitted">Submitted</option>
                                        <option value="approved">Approved</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="mt-4">
                    <button type="button" class="btn btn-primary btn-lg" id="saveButton">
                        <i class="bi bi-save me-2"></i>Save Acquisition
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2" id="resetButton">
                        <i class="bi bi-arrow-clockwise me-2"></i>Reset Form
                    </button>
                    <button type="button" class="btn btn-outline-warning ms-2" id="cancelEditBtn" style="display: none;">
                        <i class="bi bi-x-circle me-2"></i>Cancel Edit
                    </button>
                </div>
            </div>
        </div>

        <!-- Recent Acquisitions Table -->
        <div class="card mt-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-table me-2"></i>Recent Acquisitions</h4>
                <span class="badge bg-primary" id="tableCount">0 records</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="15%">SR #</th>
                                <th width="15%">Airline PNR</th>
                                <th width="10%">Seats</th>
                                <th width="12%">Fare</th>
                                <th width="12%">Status</th>
                                <th width="15%">Date</th>
                                <th width="21%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="acquisitionsTable">
                            <!-- Data loaded by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successMessage"></div>
        </div>
        <div id="errorToast" class="toast" role="alert">
            <div class="toast-header bg-danger text-white">
                <strong class="me-auto">Error!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="errorMessage"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- ALL JAVASCRIPT CODE INLINE (to avoid loading issues) -->
    <script>
        // ========== GLOBAL VARIABLES ==========
        let acquisitions = [];
        let editingId = null;
        let supabaseClient = null;
        
        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('QFC Group Platform - Initializing...');
            
            try {
                // Initialize Supabase
                const supabaseUrl = 'https://ojlxkzkialguthdeiley.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qbHhremtpYWxndXRoZGVpbGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTE0MjQsImV4cCI6MjA4NTMyNzQyNH0.CYH4hRn4w87vvvskkHOQMyKONyDWnvF7_m5IOfgPR94';
                
                if (window.supabase) {
                    supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('Supabase initialized successfully');
                } else {
                    console.error('Supabase library not loaded');
                }
                
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('requestDate').value = today;
                
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                document.getElementById('timeLimit').value = nextWeek.toISOString().split('T')[0];
                
                // Generate initial SR number
                generateSRNumber();
                
                // Setup event listeners
                setupEventListeners();
                
		document.getElementById('noOfSeats')?.addEventListener('input', calculateAmounts);

                // Initialize calculations
                calculateAmounts();
                calculateBalanceTickets();
                
                // Load existing data
                loadAcquisitions();
                
                // Make functions globally available
                window.saveAcquisition = saveAcquisition;
                window.resetForm = resetForm;
                window.cancelEdit = cancelEdit;
                
                console.log('App initialized successfully!');
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize application: ' + error.message);
            }
        });
        
        // ========== EVENT LISTENERS SETUP ==========
        function setupEventListeners() {
            // Save button
            const saveButton = document.getElementById('saveButton');
            if (saveButton) {
                saveButton.addEventListener('click', saveAcquisition);
            }
            
            // Reset button
            const resetButton = document.getElementById('resetButton');
            if (resetButton) {
                resetButton.addEventListener('click', resetForm);
            }
            
            // Cancel edit button
            const cancelButton = document.getElementById('cancelEditBtn');
            if (cancelButton) {
                cancelButton.addEventListener('click', cancelEdit);
            }
            
            // Auto-calculation events
            document.getElementById('fare')?.addEventListener('input', calculateAmounts);
            document.getElementById('taxes')?.addEventListener('input', calculateAmounts);
            document.getElementById('paymentPercentage')?.addEventListener('input', calculateAmounts);
            document.getElementById('noOfSeats')?.addEventListener('input', calculateBalanceTickets);
            document.getElementById('ticketsIssued')?.addEventListener('input', calculateBalanceTickets);
        }
        
        // ========== FORM FUNCTIONS ==========
        function generateSRNumber() {
            if (editingId) return;
            
            const srField = document.getElementById('srNumber');
            if (!srField) return;
            
            const date = new Date();
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            srField.value = `SR${year}${month}${random}`;
        }
        
        function calculateAmounts() {
    try {
        const fare = parseFloat(document.getElementById('fare')?.value) || 0;
        const taxes = parseFloat(document.getElementById('taxes')?.value) || 0;
        const percentage = parseFloat(document.getElementById('paymentPercentage')?.value) || 100;
        const seats = parseInt(document.getElementById('noOfSeats')?.value) || 1;
        
        // Calculate total per seat
        const totalPerSeat = fare + taxes;
        
        // Calculate total PNR amount (fare + taxes) × number of seats
        const totalPnrAmount = totalPerSeat * seats;
        
        // Calculate payable amount based on percentage
        const payable = totalPnrAmount * (percentage / 100);
        
        const pnrField = document.getElementById('pnrAmount');
        const payableField = document.getElementById('payableAmount');
        
        if (pnrField) pnrField.value = totalPnrAmount.toFixed(2);
        if (payableField) payableField.value = payable.toFixed(2);
    } catch (error) {
        console.error('Error in calculateAmounts:', error);
    }
}
        
        function calculateBalanceTickets() {
            try {
                const totalSeats = parseInt(document.getElementById('noOfSeats')?.value) || 0;
                const issued = parseInt(document.getElementById('ticketsIssued')?.value) || 0;
                const balance = totalSeats - issued;
                
                const balanceField = document.getElementById('balanceTickets');
                if (balanceField) balanceField.value = balance > 0 ? balance : 0;
            } catch (error) {
                console.error('Error in calculateBalanceTickets:', error);
            }
        }
        
        // ========== MAIN SAVE FUNCTION ==========
        async function saveAcquisition() {
            console.log('Saving acquisition...');
            
            // Validate required fields
            const airlinePnr = document.getElementById('airlinePnr')?.value;
            const noOfSeats = document.getElementById('noOfSeats')?.value;
            const fare = document.getElementById('fare')?.value;
            const timeLimit = document.getElementById('timeLimit')?.value;
            const airline = document.getElementById('airline')?.value;
            
            if (!airlinePnr || !noOfSeats || !fare || !timeLimit || !airline) {
                showError('Please fill in all required fields (*)');
                return;
            }
            
            // Disable save button and show loading
            const saveButton = document.getElementById('saveButton');
            const originalText = saveButton?.innerHTML;
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Saving...';
            }
            
            try {
                // Get form data
                const formData = {
                    sr_number: document.getElementById('srNumber')?.value || '',
                    request_date: document.getElementById('requestDate')?.value || new Date().toISOString().split('T')[0],
                    airline_pnr: airlinePnr,
                    no_of_seats: parseInt(noOfSeats) || 0,
                    fare: parseFloat(fare) || 0,
                    time_limit: timeLimit,
                    investment_type: document.getElementById('investmentType')?.value || 'Company Investment',
                    license_number: document.getElementById('license')?.value || 'QFC',
                    branch: document.getElementById('branch')?.value || 'HO',
                    gds_pnr: document.getElementById('gdsPnr')?.value || null,
                    segment: document.getElementById('segment')?.value || 'Umrah',
                    airline: airline,
                    outbound_date: document.getElementById('outboundDate')?.value || null,
                    inbound_date: document.getElementById('inboundDate')?.value || null,
                    sector: document.getElementById('sector')?.value || '',
                    taxes: parseFloat(document.getElementById('taxes')?.value) || 0,
                    payable_amount: parseFloat(document.getElementById('payableAmount')?.value) || 0,
                    pnr_amount: parseFloat(document.getElementById('pnrAmount')?.value) || 0,
                    issuance_date: document.getElementById('issuanceDate')?.value || null,
                    payment_percentage: parseFloat(document.getElementById('paymentPercentage')?.value) || 100,
                    emd_refund_date: document.getElementById('emdRefundDate')?.value || null,
                    first_emd_number: document.getElementById('emd1Number')?.value || null,
                    first_emd_amount: document.getElementById('emd1Amount')?.value ? parseFloat(document.getElementById('emd1Amount').value) : null,
                    first_emd_status: document.getElementById('emd1Status')?.value || null,
                    first_emd_time_limit: document.getElementById('emd1TimeLimit')?.value || null,
                    first_emd_issuance_date: document.getElementById('emd1IssuanceDate')?.value || null,
                    first_emd_payment_percentage: document.getElementById('emd1PaymentPercent')?.value ? parseFloat(document.getElementById('emd1PaymentPercent').value) : null,
                    second_emd_number: document.getElementById('emd2Number')?.value || null,
                    second_emd_amount: document.getElementById('emd2Amount')?.value ? parseFloat(document.getElementById('emd2Amount').value) : null,
                    second_emd_time_limit: document.getElementById('emd2TimeLimit')?.value || null,
                    third_emd_number: document.getElementById('emd3Number')?.value || null,
                    third_emd_amount: document.getElementById('emd3Amount')?.value ? parseFloat(document.getElementById('emd3Amount').value) : null,
                    third_emd_time_limit: document.getElementById('emd3TimeLimit')?.value || null,
                    ticketing_status: document.getElementById('ticketingStatus')?.value || 'pending',
                    no_of_tickets_issued: parseInt(document.getElementById('ticketsIssued')?.value) || 0,
                    balance_tickets: parseInt(document.getElementById('balanceTickets')?.value) || 0,
                    last_ticket_date: document.getElementById('lastTicketDate')?.value || null,
                    status: document.getElementById('overallStatus')?.value || 'draft',
                    notes: document.getElementById('notes')?.value || null,
                    created_at: new Date().toISOString()
                };
                
                console.log('Saving data:', formData);
                
                if (editingId) {
                    // Update existing record
                    const { data, error } = await supabaseClient
                        .from('seat_acquisitions')
                        .update(formData)
                        .eq('id', editingId)
                        .select();
                    
                    if (error) throw error;
                    
                    showSuccess('✅ Updated successfully! SR#: ' + formData.sr_number);
                    editingId = null;
                } else {
                    // Insert new record
                    const { data, error } = await supabaseClient
                        .from('seat_acquisitions')
                        .insert([formData])
                        .select();
                    
                    if (error) throw error;
                    
                    showSuccess('✅ Saved successfully! SR#: ' + formData.sr_number);
                }
                
                // Reset form and reload data
                resetForm();
                await loadAcquisitions();
                
            } catch (error) {
                console.error('Save error:', error);
                showError('❌ Error saving: ' + (error.message || 'Please check console for details'));
            } finally {
                // Re-enable save button
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalText;
                }
            }
        }
        
        // ========== OTHER FUNCTIONS ==========
        async function loadAcquisitions() {
            try {
                if (!supabaseClient) {
                    console.log('Supabase not initialized, using localStorage');
                    // Fallback to localStorage
                    const savedData = localStorage.getItem('qfc_acquisitions');
                    acquisitions = savedData ? JSON.parse(savedData) : [];
                    updateTable();
                    updateDashboard();
                    return;
                }
                
                const { data, error } = await supabaseClient
                    .from('seat_acquisitions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                acquisitions = data || [];
                updateTable();
                updateDashboard();
                
                // Also save to localStorage as backup
                localStorage.setItem('qfc_acquisitions', JSON.stringify(acquisitions));
                
            } catch (error) {
                console.error('Load error:', error);
                // Fallback to localStorage
                const savedData = localStorage.getItem('qfc_acquisitions');
                acquisitions = savedData ? JSON.parse(savedData) : [];
                updateTable();
                updateDashboard();
                showError('Using offline data. Please check internet connection.');
            }
        }
        
        function updateTable() {
            const tableBody = document.getElementById('acquisitionsTable');
            const tableCount = document.getElementById('tableCount');
            
            if (!acquisitions || acquisitions.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="text-muted">
                                <i class="bi bi-inbox display-6"></i>
                                <p class="mt-2">No acquisitions yet</p>
                                <small>Save your first acquisition above</small>
                            </div>
                        </td>
                    </tr>
                `;
                if (tableCount) tableCount.textContent = '0 records';
                return;
            }
            
            let html = '';
            acquisitions.forEach(item => {
                const id = item.id || '';
                const isEditing = editingId === id;
                const rowClass = isEditing ? 'table-warning' : '';
                
                let statusClass = 'status-draft';
                if (item.status === 'approved') statusClass = 'status-approved';
                if (item.status === 'submitted') statusClass = 'status-pending';
                
                html += `
                    <tr class="${rowClass}">
                        <td><strong>${item.sr_number || ''}</strong></td>
                        <td>${item.airline_pnr || ''}</td>
                        <td>${item.no_of_seats || 0}</td>
                        <td>${item.fare ? parseFloat(item.fare).toFixed(2) : '0.00'}</td>
                        <td><span class="status-badge ${statusClass}">${item.status || 'draft'}</span></td>
                        <td>${item.created_at ? new Date(item.created_at).toLocaleDateString() : ''}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editItem('${id}')" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteItem('${id}', '${item.sr_number}')" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            if (tableCount) tableCount.textContent = `${acquisitions.length} records`;
            
            // Make edit/delete functions available
            window.editItem = editItem;
            window.deleteItem = deleteItem;
        }
        
        function updateDashboard() {
            if (!acquisitions || acquisitions.length === 0) {
                document.getElementById('totalSeats').textContent = '0';
                document.getElementById('totalRevenue').textContent = '0.00';
                document.getElementById('totalAcquisitions').textContent = '0';
                document.getElementById('pendingItems').textContent = '0';
                return;
            }
            
            const totalSeats = acquisitions.reduce((sum, item) => sum + (item.no_of_seats || 0), 0);
            const totalRevenue = acquisitions.reduce((sum, item) => sum + (item.payable_amount || 0), 0);
            const pendingCount = acquisitions.filter(item => item.status === 'draft' || item.status === 'submitted').length;
            
            document.getElementById('totalSeats').textContent = totalSeats;
            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2);
            document.getElementById('totalAcquisitions').textContent = acquisitions.length;
            document.getElementById('pendingItems').textContent = pendingCount;
        }
        
        function resetForm() {
            editingId = null;
            
            // Generate new SR number
            generateSRNumber();
            
            // Clear form fields
            const fieldsToClear = [
                'airlinePnr', 'gdsPnr', 'noOfSeats', 'outboundDate', 'inboundDate',
                'sector', 'fare', 'taxes', 'issuanceDate', 'emdRefundDate',
                'emd1Number', 'emd1Amount', 'emd1TimeLimit', 'emd1IssuanceDate', 'emd1PaymentPercent',
                'emd2Number', 'emd2Amount', 'emd2TimeLimit', 'emd3Number', 'emd3Amount', 'emd3TimeLimit',
                'ticketsIssued', 'lastTicketDate', 'notes'
            ];
            
            fieldsToClear.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            // Reset select fields to defaults
            document.getElementById('investmentType').value = 'Company Investment';
            document.getElementById('license').value = 'QFC';
            document.getElementById('branch').value = 'HO';
            document.getElementById('segment').value = 'Umrah';
            document.getElementById('airline').value = '';
            document.getElementById('emd1Status').value = '';
            document.getElementById('ticketingStatus').value = 'pending';
            document.getElementById('overallStatus').value = 'draft';
            document.getElementById('paymentPercentage').value = '100';
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('requestDate').value = today;
            
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('timeLimit').value = nextWeek.toISOString().split('T')[0];
            
            // Recalculate
            calculateAmounts();
            calculateBalanceTickets();
            
            // Update UI buttons
            document.getElementById('saveButton').innerHTML = '<i class="bi bi-save me-2"></i>Save Acquisition';
            document.getElementById('saveButton').className = 'btn btn-primary btn-lg';
            document.getElementById('cancelEditBtn').style.display = 'none';
            
            // Update table
            updateTable();
            
            showSuccess('Form reset successfully');
        }
        
        function cancelEdit() {
            resetForm();
        }
        
        async function editItem(id) {
            try {
                // Find item in local array first
                const item = acquisitions.find(item => item.id == id);
                if (!item) {
                    showError('Item not found');
                    return;
                }
                
                editingId = id;
                
                // Fill form with item data
                const fields = [
                    { id: 'srNumber', value: item.sr_number },
                    { id: 'requestDate', value: item.request_date },
                    { id: 'investmentType', value: item.investment_type },
                    { id: 'license', value: item.license_number },
                    { id: 'branch', value: item.branch },
                    { id: 'airlinePnr', value: item.airline_pnr },
                    { id: 'gdsPnr', value: item.gds_pnr },
                    { id: 'segment', value: item.segment },
                    { id: 'airline', value: item.airline },
                    { id: 'noOfSeats', value: item.no_of_seats },
                    { id: 'outboundDate', value: item.outbound_date },
                    { id: 'inboundDate', value: item.inbound_date },
                    { id: 'sector', value: item.sector },
                    { id: 'fare', value: item.fare },
                    { id: 'taxes', value: item.taxes },
                    { id: 'paymentPercentage', value: item.payment_percentage },
                    { id: 'issuanceDate', value: item.issuance_date },
                    { id: 'timeLimit', value: item.time_limit },
                    { id: 'emdRefundDate', value: item.emd_refund_date },
                    { id: 'emd1Number', value: item.first_emd_number },
                    { id: 'emd1Amount', value: item.first_emd_amount },
                    { id: 'emd1Status', value: item.first_emd_status },
                    { id: 'emd1TimeLimit', value: item.first_emd_time_limit },
                    { id: 'emd1IssuanceDate', value: item.first_emd_issuance_date },
                    { id: 'emd1PaymentPercent', value: item.first_emd_payment_percentage },
                    { id: 'emd2Number', value: item.second_emd_number },
                    { id: 'emd2Amount', value: item.second_emd_amount },
                    { id: 'emd2TimeLimit', value: item.second_emd_time_limit },
                    { id: 'emd3Number', value: item.third_emd_number },
                    { id: 'emd3Amount', value: item.third_emd_amount },
                    { id: 'emd3TimeLimit', value: item.third_emd_time_limit },
                    { id: 'ticketingStatus', value: item.ticketing_status },
                    { id: 'ticketsIssued', value: item.no_of_tickets_issued },
                    { id: 'lastTicketDate', value: item.last_ticket_date },
                    { id: 'overallStatus', value: item.status },
                    { id: 'notes', value: item.notes }
                ];
                
                fields.forEach(field => {
                    const element = document.getElementById(field.id);
                    if (element && field.value !== null && field.value !== undefined) {
                        element.value = field.value;
                    }
                });
                
                // Recalculate
                calculateAmounts();
                calculateBalanceTickets();
                
                // Update UI
                document.getElementById('saveButton').innerHTML = '<i class="bi bi-pencil-square me-2"></i>Update';
                document.getElementById('saveButton').className = 'btn btn-warning btn-lg';
                document.getElementById('cancelEditBtn').style.display = 'inline-block';
                
                // Scroll to form
                document.getElementById('acquireForm').scrollIntoView({ behavior: 'smooth' });
                
                showSuccess('Editing: ' + item.sr_number);
                
            } catch (error) {
                console.error('Edit error:', error);
                showError('Failed to load for editing');
            }
        }
        
        async function deleteItem(id, srNumber) {
            if (!confirm(`Are you sure you want to delete ${srNumber}? This action cannot be undone.`)) return;
            
            try {
                if (supabaseClient) {
                    const { error } = await supabaseClient
                        .from('seat_acquisitions')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                }
                
                // Remove from local array
                acquisitions = acquisitions.filter(item => item.id != id);
                
                // Update localStorage
                localStorage.setItem('qfc_acquisitions', JSON.stringify(acquisitions));
                
                // If we were editing this item, cancel edit
                if (editingId == id) {
                    resetForm();
                }
                
                // Update UI
                updateTable();
                updateDashboard();
                
                showSuccess('Deleted: ' + srNumber);
                
            } catch (error) {
                console.error('Delete error:', error);
                showError('Failed to delete');
            }
        }
        
        // ========== NOTIFICATION FUNCTIONS ==========
        function showSuccess(message) {
            const successToast = document.getElementById('successToast');
            const successMessage = document.getElementById('successMessage');
            
            if (successMessage) successMessage.textContent = message;
            if (successToast) {
                const toast = new bootstrap.Toast(successToast);
                toast.show();
            }
        }
        
        function showError(message) {
            const errorToast = document.getElementById('errorToast');
            const errorMessage = document.getElementById('errorMessage');
            
            if (errorMessage) errorMessage.textContent = message;
            if (errorToast) {
                const toast = new bootstrap.Toast(errorToast);
                toast.show();
            }
        }
        
        // Make functions globally available
        window.saveAcquisition = saveAcquisition;
        window.resetForm = resetForm;
        window.cancelEdit = cancelEdit;
        window.editItem = editItem;
        window.deleteItem = deleteItem;
        
        console.log('All JavaScript functions loaded and available');
    </script>
</body>
</html>
