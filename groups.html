<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QFC Group - Flight Groups</title>
    <link rel="icon" type="image/png" href="QFClogo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar-brand { font-weight: bold; color: #1a365d !important; }
        .card { border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 24px; border: none; }
        .card-header { background-color: #1a365d; color: white; border-radius: 12px 12px 0 0 !important; }
        .airline-logo { width: 80px; height: 80px; object-fit: contain; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .group-card { transition: transform 0.3s, box-shadow 0.3s; border-left: 5px solid #1a365d; }
        .group-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .progress { height: 10px; }
        .alert-fixed {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        .stats-card h2 { font-size: 2rem; font-weight: bold; margin: 0; }
        .stats-card h5 { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; }
        
        .flight-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 1rem;
        }
        
        .flight-box {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #1a365d;
        }
        
        .flight-box.outbound {
            border-left-color: #0d6efd;
        }
        
        .flight-box.inbound {
            border-left-color: #198754;
        }
        
        .flight-header {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #495057;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .flight-segment {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            padding: 3px 0;
        }
        
        .flight-icon {
            width: 24px;
            display: flex;
            justify-content: center;
            margin-right: 8px;
        }
        
        .outbound .flight-icon {
            order: 2; /* Icon on right for outbound */
            margin-right: 0;
            margin-left: 8px;
        }
        
        .inbound .flight-icon {
            order: 1; /* Icon on left for inbound */
        }
        
        .flight-info {
            flex: 1;
            font-size: 0.85rem;
        }
        
        .flight-number {
            font-weight: 600;
            color: #1a365d;
        }
        
        .flight-times {
            color: #6c757d;
            font-size: 0.8rem;
        }
        
        .date-badge {
            background-color: #e9ecef;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #495057;
        }
        
        /* PNR and Branch parallel display */
        .pnr-branch-container {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        .pnr-branch-item {
            flex: 1;
            background: #f8f9fa;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .pnr-branch-label {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 2px;
        }
        .pnr-branch-value {
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-draft { background-color: #fff3cd; color: #856404; }
        .badge-submitted { background-color: #cff4fc; color: #055160; }
        .badge-approved { background-color: #d1e7dd; color: #0f5132; }
        .badge-rejected { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <img src="QFClogo.png" alt="QFC Logo" height="30" class="me-2">
            <div class="d-inline-block">
                <div class="qfc-brand">QFC Group Pvt Ltd</div>
                <div class="qfc-subtitle">Flight Groups Dashboard</div>
            </div>
        </a>
        
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="bi bi-house-door me-1"></i>Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="groups.html">
                        <i class="bi bi-people me-1"></i>Groups
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="index.html#acquireForm">
                        <i class="bi bi-plus-circle me-1"></i>New Group
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2 class="fw-bold text-dark"><i class="bi bi-people-fill me-2"></i>Flight Groups</h2>
                <p class="text-muted">Manage all flight groups and seat allocations</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" id="refreshButton">
                    <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                </button>
                <button class="btn btn-outline-success ms-2" onclick="exportGroupsToCSV()">
                    <i class="bi bi-download me-2"></i>Export
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white stats-card">
                    <div class="card-body">
                        <h5><i class="bi bi-airplane me-1"></i>Active Groups</h5>
                        <h2 id="activeGroups">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white stats-card">
                    <div class="card-body">
                        <h5><i class="bi bi-person-check me-1"></i>Total Seats</h5>
                        <h2 id="totalGroupSeats">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white stats-card">
                    <div class="card-body">
                        <h5><i class="bi bi-cart-check me-1"></i>Sold Seats</h5>
                        <h2 id="soldSeats">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white stats-card">
                    <div class="card-body">
                        <h5><i class="bi bi-clock me-1"></i>Available</h5>
                        <h2 id="availableSeats">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="searchGroups" placeholder="Search by PNR, Airline, SR Number...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterAirline">
                            <option value="">All Airlines</option>
                            <option value="SV">Saudi Airlines (SV)</option>
                            <option value="PK">Pakistan Airlines (PK)</option>
                            <option value="EK">Emirates (EK)</option>
                            <option value="F3">Flyadeal (F3)</option>
                            <option value="PA">Airblue (PA)</option>
                            <option value="J9">Jazeera Airways (J9)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterStatus">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="draft">Draft</option>
                            <option value="approved">Approved</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterSegment">
                            <option value="">All Segments</option>
                            <option value="Umrah">Umrah</option>
                            <option value="Employment">Employment</option>
                            <option value="Hajj">Hajj</option>
                            <option value="Tours">Tours</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Groups Grid -->
        <div class="row" id="groupsGrid">
            <!-- Groups will be loaded here -->
            <div class="col-12 text-center py-5">
                <div class="text-muted">
                    <i class="bi bi-inbox display-6"></i>
                    <p class="mt-3">Loading groups...</p>
                    <small>Please wait while we load the data</small>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Configuration
        const supabaseClient = window.supabase.createClient(
            'https://ojlxkzkialguthdeiley.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qbHhremtpYWxndXRoZGVpbGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTE0MjQsImV4cCI6MjA4NTMyNzQyNH0.CYH4hRn4w87vvvskkHOQMyKONyDWnvF7_m5IOfgPR94'
        );
        
        let groups = [];
        let agentSales = [];

        // Airline logos mapping
        const airlineLogos = {
            'SV': 'SVlogo.png',
            'PA': 'PAlogo.png',
            'PK': 'PKlogo.png',
            'EK': 'EKlogo.png',
            'F3': 'F3logo.png',
            'PF': 'PFlogo.png',
            '9P': '9Plogo.png',
            'J9': 'J9logo.png'
        };

        const defaultLogo = 'https://cdn-icons-png.flaticon.com/512/824/824239.png';

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            loadAllData();
            
            // Setup event listeners
            document.getElementById('searchGroups').addEventListener('input', filterGroups);
            document.getElementById('filterAirline').addEventListener('change', filterGroups);
            document.getElementById('filterStatus').addEventListener('change', filterGroups);
            document.getElementById('filterSegment').addEventListener('change', filterGroups);
            document.getElementById('refreshButton').addEventListener('click', refreshGroups);
        });

        async function loadAllData() {
            try {
                console.log('Loading all data...');
                
                // Show loading state
                document.getElementById('groupsGrid').innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="text-muted">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Loading groups data...</p>
                            <small>Please wait while we fetch the latest information</small>
                        </div>
                    </div>
                `;
                
                // Reset stats while loading
                resetStats();
                
                // Load data in parallel
                await Promise.all([
                    loadGroups(),
                    loadAgentSales()
                ]);
                
                console.log('Data loaded. Groups:', groups.length, 'Agent Sales:', agentSales.length);
                
                // Display data
                displayGroups();
                updateDashboardStats();
                
                showAlert('Data loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Error loading data. Please try again.', 'danger');
                displayEmptyState();
            }
        }

        function resetStats() {
            document.getElementById('activeGroups').textContent = '0';
            document.getElementById('totalGroupSeats').textContent = '0';
            document.getElementById('soldSeats').textContent = '0';
            document.getElementById('availableSeats').textContent = '0';
        }

        async function loadGroups() {
            try {
                console.log('Loading groups from Supabase...');
                
                const { data, error } = await supabaseClient
                    .from('seat_acquisitions')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Supabase error loading groups:', error);
                    throw error;
                }
                
                groups = data || [];
                console.log('Groups loaded successfully:', groups.length);
                
            } catch (error) {
                console.error('Error loading groups:', error);
                groups = [];
                throw error;
            }
        }

        async function loadAgentSales() {
            try {
                console.log('Loading agent sales from Supabase...');
                
                const { data, error } = await supabaseClient
                    .from('agent_sales')
                    .select('*');
                
                if (error) {
                    if (error.code === 'PGRST204' || error.message.includes('does not exist')) {
                        console.log('agent_sales table not found or has issues');
                        agentSales = [];
                        return;
                    }
                    console.error('Supabase error loading agent sales:', error);
                    throw error;
                }
                
                agentSales = data || [];
                console.log('Agent sales loaded successfully:', agentSales.length);
                
            } catch (error) {
                console.error('Error loading agent sales:', error);
                agentSales = [];
            }
        }

        function displayGroups(filteredGroups = groups) {
            const grid = document.getElementById('groupsGrid');
            
            if (!filteredGroups || filteredGroups.length === 0) {
                grid.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="text-muted">
                            <i class="bi bi-inbox display-6"></i>
                            <p class="mt-3">No flight groups found</p>
                            <small>Create your first group from the Home page</small>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredGroups.forEach(group => {
                const airlineCode = group.airline || '';
                const logoUrl = airlineLogos[airlineCode] || defaultLogo;
                
                // Calculate sold seats for this group
                const groupSales = agentSales.filter(sale => sale.group_id === group.id);
                const soldSeats = groupSales.reduce((sum, sale) => sum + (parseInt(sale.seats_sold) || 0), 0);
                const availableSeats = Math.max(0, (group.no_of_seats || 0) - soldSeats);
                const progressPercent = group.no_of_seats ? (soldSeats / group.no_of_seats) * 100 : 0;
                
                // Format dates
                const formattedOutboundDate = formatDateForDisplay(group.outbound_date);
                const formattedInboundDate = formatDateForDisplay(group.inbound_date);
                
                // Determine status
                let status = group.status || 'draft';
                let statusClass = 'badge-draft';
                let statusText = 'Draft';
                
                if (status === 'approved') {
                    statusClass = 'badge-approved';
                    statusText = 'Approved';
                } else if (status === 'submitted') {
                    statusClass = 'badge-submitted';
                    statusText = 'Submitted';
                } else if (status === 'rejected') {
                    statusClass = 'badge-rejected';
                    statusText = 'Rejected';
                } else if (availableSeats === 0) {
                    status = 'completed';
                    statusClass = 'bg-secondary';
                    statusText = 'Completed';
                } else if (availableSeats > 0) {
                    status = 'active';
                    statusClass = 'bg-success';
                    statusText = 'Active';
                }

                // Determine flight type
                const flightSegments = group.flight_segments || '2';
                const isConnectingFlight = flightSegments === '4';
                const flightType = isConnectingFlight ? 'Connecting Flight' : 'Direct Flight';
                
                // Build flight display
                let flightDisplay = '';
                
                if (isConnectingFlight) {
                    // Connecting flight - parallel display
                    flightDisplay = `
                        <div class="flight-container">
                            <!-- Outbound Flights -->
                            <div class="flight-box outbound">
                                <div class="flight-header">
                                    <span>Outbound</span>
                                    <span class="date-badge">${formattedOutboundDate}</span>
                                </div>
                                <!-- First segment - plane on right -->
                                <div class="flight-segment">
                                    <div class="flight-info" style="text-align: right;">
                                        <div class="flight-number">${group.outbound1_flight || 'N/A'}</div>
                                        ${group.outbound1_times ? `<div class="flight-times">${group.outbound1_times}</div>` : ''}
                                    </div>
                                    <div class="flight-icon">
                                        <i class="bi bi-airplane-fill text-primary"></i>
                                    </div>
                                </div>
                                <!-- Second segment - plane on right -->
                                <div class="flight-segment">
                                    <div class="flight-info" style="text-align: right;">
                                        <div class="flight-number">${group.outbound2_flight || 'N/A'}</div>
                                        ${group.outbound2_times ? `<div class="flight-times">${group.outbound2_times}</div>` : ''}
                                    </div>
                                    <div class="flight-icon">
                                        <i class="bi bi-airplane-fill text-primary"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Inbound Flights -->
                            <div class="flight-box inbound">
                                <div class="flight-header">
                                    <span>Inbound</span>
                                    <span class="date-badge">${formattedInboundDate}</span>
                                </div>
                                <!-- First segment - plane on left -->
                                <div class="flight-segment">
                                    <div class="flight-icon">
                                        <i class="bi bi-airplane-fill text-success"></i>
                                    </div>
                                    <div class="flight-info">
                                        <div class="flight-number">${group.inbound1_flight || 'N/A'}</div>
                                        ${group.inbound1_times ? `<div class="flight-times">${group.inbound1_times}</div>` : ''}
                                    </div>
                                </div>
                                <!-- Second segment - plane on left -->
                                <div class="flight-segment">
                                    <div class="flight-icon">
                                        <i class="bi bi-airplane-fill text-success"></i>
                                    </div>
                                    <div class="flight-info">
                                        <div class="flight-number">${group.inbound2_flight || 'N/A'}</div>
                                        ${group.inbound2_times ? `<div class="flight-times">${group.inbound2_times}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Direct flight - parallel display
                    flightDisplay = `
                        <div class="flight-container">
                            <!-- Outbound Flight -->
                            <div class="flight-box outbound">
                                <div class="flight-header">
                                    <span>Outbound</span>
                                    <span class="date-badge">${formattedOutboundDate}</span>
                                </div>
                                <div class="flight-segment">
                                    <div class="flight-info" style="text-align: right;">
                                        <div class="flight-number">${group.outbound_flight || 'N/A'}</div>
                                        ${group.outbound_times ? `<div class="flight-times">${group.outbound_times}</div>` : ''}
                                    </div>
                                    <div class="flight-icon">
                                        <i class="bi bi-airplane-fill text-primary"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Inbound Flight -->
                            <div class="flight-box inbound">
                                <div class="flight-header">
                                    <span>Inbound</span>
                                    <span class="date-badge">${formattedInboundDate}</span>
                                </div>
                                <div class="flight-segment">
                                    <div class="flight-icon">
                                        <i class="bi bi-airplane-fill text-success"></i>
                                    </div>
                                    <div class="flight-info">
                                        <div class="flight-number">${group.inbound_flight || 'N/A'}</div>
                                        ${group.inbound_times ? `<div class="flight-times">${group.inbound_times}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card group-card h-100">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">${airlineCode} - ${group.sector || 'N/A'}</h5>
                                    <small>${group.segment || 'General'} â€¢ ${flightType}</small>
                                </div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center mb-3">
                                    <div class="col-4 text-center">
                                        <img src="${logoUrl}" alt="${airlineCode}" class="airline-logo" 
                                             onclick="viewGroupDetails('${group.id}')" style="cursor:pointer;">
                                    </div>
                                    <div class="col-8">
                                        <!-- PNR and Branch displayed parallel -->
                                        <div class="pnr-branch-container">
                                            <div class="pnr-branch-item">
                                                <div class="pnr-branch-label">PNR</div>
                                                <div class="pnr-branch-value">${group.airline_pnr || 'N/A'}</div>
                                            </div>
                                            <div class="pnr-branch-item">
                                                <div class="pnr-branch-label">Branch</div>
                                                <div class="pnr-branch-value">${group.branch || 'HO'}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Flight Information - Parallel Display -->
                                ${flightDisplay}
                                
                                <!-- Seats Progress -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Seats Progress</span>
                                        <span>${soldSeats}/${group.no_of_seats || 0}</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" style="width: ${progressPercent}%"></div>
                                    </div>
                                </div>
                                
                                <!-- Quick Stats -->
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <small class="text-muted d-block">Total</small>
                                            <strong>${group.no_of_seats || 0}</strong>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <small class="text-muted d-block">Sold</small>
                                            <strong class="text-success">${soldSeats}</strong>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <small class="text-muted d-block">Available</small>
                                            <strong class="text-warning">${availableSeats}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent border-top">
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewGroupDetails('${group.id}')">
                                        <i class="bi bi-eye me-1"></i>Full Details
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="sellSeats('${group.id}')" ${availableSeats === 0 ? 'disabled' : ''}>
                                        <i class="bi bi-cart-plus me-1"></i>Sell Seats (${availableSeats})
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        function filterGroups() {
            const searchTerm = document.getElementById('searchGroups').value.toLowerCase();
            const airlineFilter = document.getElementById('filterAirline').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const segmentFilter = document.getElementById('filterSegment').value;
            
            let filtered = groups;
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(group => {
                    return (
                        (group.sr_number && group.sr_number.toLowerCase().includes(searchTerm)) ||
                        (group.airline_pnr && group.airline_pnr.toLowerCase().includes(searchTerm)) ||
                        (group.airline && group.airline.toLowerCase().includes(searchTerm)) ||
                        (group.sector && group.sector.toLowerCase().includes(searchTerm)) ||
                        (group.segment && group.segment.toLowerCase().includes(searchTerm)) ||
                        (group.branch && group.branch.toLowerCase().includes(searchTerm))
                    );
                });
            }
            
            // Apply airline filter
            if (airlineFilter) {
                filtered = filtered.filter(group => group.airline === airlineFilter);
            }
            
            // Apply segment filter
            if (segmentFilter) {
                filtered = filtered.filter(group => group.segment === segmentFilter);
            }
            
            // Apply status filter
            if (statusFilter) {
                if (statusFilter === 'completed') {
                    // Calculate completion based on sold seats
                    filtered = filtered.filter(group => {
                        const groupSales = agentSales.filter(sale => sale.group_id === group.id);
                        const soldSeats = groupSales.reduce((sum, sale) => sum + (parseInt(sale.seats_sold) || 0), 0);
                        return soldSeats >= (group.no_of_seats || 0);
                    });
                } else if (statusFilter === 'active') {
                    // Groups with available seats
                    filtered = filtered.filter(group => {
                        const groupSales = agentSales.filter(sale => sale.group_id === group.id);
                        const soldSeats = groupSales.reduce((sum, sale) => sum + (parseInt(sale.seats_sold) || 0), 0);
                        return soldSeats < (group.no_of_seats || 0);
                    });
                } else if (statusFilter === 'pending') {
                    // Groups with no sales yet
                    filtered = filtered.filter(group => {
                        const groupSales = agentSales.filter(sale => sale.group_id === group.id);
                        return groupSales.length === 0;
                    });
                } else {
                    // Filter by status field
                    filtered = filtered.filter(group => group.status === statusFilter);
                }
            }
            
            displayGroups(filtered);
        }

        function updateDashboardStats() {
            if (!groups || groups.length === 0) {
                resetStats();
                return;
            }
            
            // Calculate stats
            const activeGroups = groups.length;
            const totalSeats = groups.reduce((sum, group) => sum + (parseInt(group.no_of_seats) || 0), 0);
            
            // Calculate sold seats across all groups
            let totalSoldSeats = 0;
            groups.forEach(group => {
                const groupSales = agentSales.filter(sale => sale.group_id === group.id);
                const soldSeats = groupSales.reduce((sum, sale) => sum + (parseInt(sale.seats_sold) || 0), 0);
                totalSoldSeats += soldSeats;
            });
            
            const availableSeats = Math.max(0, totalSeats - totalSoldSeats);
            
            // Update DOM
            document.getElementById('activeGroups').textContent = activeGroups;
            document.getElementById('totalGroupSeats').textContent = totalSeats;
            document.getElementById('soldSeats').textContent = totalSoldSeats;
            document.getElementById('availableSeats').textContent = availableSeats;
        }

        function refreshGroups() {
            console.log('Refreshing data...');
            
            const refreshBtn = document.getElementById('refreshButton');
            const originalHtml = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Refreshing...';
            refreshBtn.disabled = true;
            
            loadAllData().finally(() => {
                refreshBtn.innerHTML = originalHtml;
                refreshBtn.disabled = false;
            });
        }

        function viewGroupDetails(groupId) {
            if (!groupId) {
                showAlert('No group selected', 'warning');
                return;
            }
            localStorage.setItem('currentGroupId', groupId);
            window.location.href = 'group-details.html';
        }

        function sellSeats(groupId) {
            if (!groupId) {
                showAlert('No group selected', 'warning');
                return;
            }
            localStorage.setItem('sellGroupId', groupId);
            window.location.href = 'sell-seats.html';
        }

        function formatDateForDisplay(dateStr) {
            if (!dateStr) return 'N/A';
            
            // If already in correct format (01-MAR-26), return as is
            if (/^\d{2}-[A-Z]{3}-\d{2}$/.test(dateStr.toUpperCase())) {
                return dateStr.toUpperCase();
            }
            
            // Try to parse date string
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                
                const day = String(date.getDate()).padStart(2, '0');
                const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                                   'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                const month = monthNames[date.getMonth()];
                const year = String(date.getFullYear()).slice(-2);
                
                return `${day}-${month}-${year}`;
            } catch (error) {
                return dateStr;
            }
        }

        function exportGroupsToCSV() {
            if (groups.length === 0) {
                showAlert('No data to export', 'warning');
                return;
            }
            
            const headers = [
                'PNR', 'Airline', 'Sector', 'Segment', 'Flight Type', 'Branch',
                'Outbound Date', 'Inbound Date', 'Total Seats', 'Outbound Flight', 
                'Inbound Flight', 'Status', 'Sold Seats', 'Available Seats'
            ];
            
            const csvRows = [
                headers.join(','),
                ...groups.map(group => {
                    const flightType = (group.flight_segments === '4') ? 'Connecting' : 'Direct';
                    
                    // Calculate sold seats for this group
                    const groupSales = agentSales.filter(sale => sale.group_id === group.id);
                    const soldSeats = groupSales.reduce((sum, sale) => sum + (parseInt(sale.seats_sold) || 0), 0);
                    const availableSeats = Math.max(0, (group.no_of_seats || 0) - soldSeats);
                    
                    return [
                        `"${group.airline_pnr || ''}"`,
                        `"${group.airline || ''}"`,
                        `"${group.sector || ''}"`,
                        `"${group.segment || ''}"`,
                        `"${flightType}"`,
                        `"${group.branch || ''}"`,
                        `"${formatDateForDisplay(group.outbound_date)}"`,
                        `"${formatDateForDisplay(group.inbound_date)}"`,
                        group.no_of_seats || 0,
                        `"${group.outbound_flight || ''}"`,
                        `"${group.inbound_flight || ''}"`,
                        `"${group.status || ''}"`,
                        soldSeats,
                        availableSeats
                    ].join(',');
                })
            ];
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flight-groups-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showAlert(`Exported ${groups.length} groups to CSV`, 'success');
        }

        function showAlert(message, type = 'info') {
            const existingAlerts = document.querySelectorAll('.alert-fixed');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-fixed alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function displayEmptyState() {
            document.getElementById('groupsGrid').innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="text-muted">
                        <i class="bi bi-exclamation-triangle display-6"></i>
                        <p class="mt-3">Unable to load data</p>
                        <small>Please check your connection and try again</small>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="refreshGroups()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Try Again
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Make functions available globally
        window.viewGroupDetails = viewGroupDetails;
        window.sellSeats = sellSeats;
        window.refreshGroups = refreshGroups;
        window.exportGroupsToCSV = exportGroupsToCSV;
    </script>
</body>
</html>
