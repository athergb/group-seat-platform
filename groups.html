<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QFC Group - Flight Groups</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar-brand { font-weight: bold; color: #1a365d !important; }
        .card { border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 24px; border: none; }
        .card-header { background-color: #1a365d; color: white; border-radius: 12px 12px 0 0 !important; }
        .airline-logo { width: 80px; height: 80px; object-fit: contain; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .group-card { transition: transform 0.3s, box-shadow 0.3s; border-left: 5px solid #1a365d; }
        .group-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .badge-seats { font-size: 0.9rem; padding: 5px 10px; }
        .progress { height: 10px; }
        .btn-view { background-color: #1a365d; color: white; }
        .btn-view:hover { background-color: #2d4a8c; }
        .alert-fixed {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        .stats-card h2 { font-size: 2rem; font-weight: bold; margin: 0; }
        .stats-card h5 { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; }
	
.flight-times {
    background-color: #f8f9fa;
    padding: 8px 12px;
    border-radius: 8px;
    border-left: 3px solid #1a365d;
    margin-bottom: 1rem;
}
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <img src="QFClogo.png" alt="QFC Logo" height="30" class="me-2">
            <div class="d-inline-block">
                <div class="qfc-brand">QFC Group Pvt Ltd</div>
                <div class="qfc-subtitle">Flight Groups Dashboard</div>
            </div>
        </a>
        
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="bi bi-house-door me-1"></i>Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="groups.html">
                        <i class="bi bi-people me-1"></i>Groups
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="index.html#acquireForm">
                        <i class="bi bi-plus-circle me-1"></i>New Group
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2 class="fw-bold text-dark"><i class="bi bi-people-fill me-2"></i>Flight Groups</h2>
                <p class="text-muted">Manage all flight groups and seat allocations</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" id="refreshButton">
                    <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white stats-card">
                    <div class="card-body">
                        <h5><i class="bi bi-airplane me-1"></i>Active Groups</h5>
                        <h2 id="activeGroups">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white stats-card">
                    <div class="card-body">
                        <h5><i class="bi bi-person-check me-1"></i>Total Seats</h5>
                        <h2 id="totalGroupSeats">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white stats-card">
                    <div class="card-body">
                        <h5><i class="bi bi-cart-check me-1"></i>Sold Seats</h5>
                        <h2 id="soldSeats">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white stats-card">
                    <div class="card-body">
                        <h5><i class="bi bi-clock me-1"></i>Available</h5>
                        <h2 id="availableSeats">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="searchGroups" placeholder="Search by PNR, Airline, SR Number...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="filterAirline">
                            <option value="">All Airlines</option>
                            <option value="SV">Saudi Airlines (SV)</option>
                            <option value="PK">Pakistan Airlines (PK)</option>
                            <option value="EK">Emirates (EK)</option>
                            <option value="F3">Flyadeal (F3)</option>
                            <option value="PA">Airblue (PA)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="filterStatus">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Groups Grid -->
        <div class="row" id="groupsGrid">
            <!-- Groups will be loaded here -->
            <div class="col-12 text-center py-5">
                <div class="text-muted">
                    <i class="bi bi-inbox display-6"></i>
                    <p class="mt-3">Loading groups...</p>
                    <small>Please wait while we load the data</small>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase Configuration - REMOVED DUPLICATE DECLARATION
        // const supabaseUrl and supabaseKey are already defined in the included script
        // Just create the client once
        
        // Create Supabase client
        const supabaseClient = window.supabase.createClient(
            'https://ojlxkzkialguthdeiley.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qbHhremtpYWxndXRoZGVpbGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTE0MjQsImV4cCI6MjA4NTMyNzQyNH0.CYH4hRn4w87vvvskkHOQMyKONyDWnvF7_m5IOfgPR94'
        );
        
        let groups = [];
        let agentSales = [];

        // Airline logos mapping
        const airlineLogos = {
        	'SV': 'SVlogo.png',      // Saudi Airlines - using local file
    		'PA': 'PAlogo.png',      // Airblue/Philippine Airlines - using local file
    		'PK': 'PKlogo.png',      // Pakistan Airlines (you may need to add this file)
    		'EK': 'EKlogo.png',      // Emirates (you may need to add this file)
    		'F3': 'F3logo.png',      // Flyadeal (you may need to add this file)
    		'PF': 'PFlogo.png',      // Palestine Airlines (you may need to add this file)
    		'9P': '9Plogo.png',      // PIA (you may need to add this file)
    		'J9': 'J9logo.png'       // Jazeera Airways (you may need to add this file)
        };

        // Default airline logo
        const defaultLogo = 'https://cdn-icons-png.flaticon.com/512/824/824239.png';

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            loadAllData();
            
            // Setup event listeners
            document.getElementById('searchGroups').addEventListener('input', filterGroups);
            document.getElementById('filterAirline').addEventListener('change', filterGroups);
            document.getElementById('filterStatus').addEventListener('change', filterGroups);
            document.getElementById('refreshButton').addEventListener('click', refreshGroups);
        });

        async function loadAllData() {
            try {
                console.log('Loading all data...');
                
                // Show loading state
                document.getElementById('groupsGrid').innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="text-muted">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Loading groups data...</p>
                            <small>Please wait while we fetch the latest information</small>
                        </div>
                    </div>
                `;
                
                // Reset stats while loading
                resetStats();
                
                // Load data in parallel
                await Promise.all([
                    loadGroups(),
                    loadAgentSales()
                ]);
                
                console.log('Data loaded. Groups:', groups.length, 'Agent Sales:', agentSales.length);
                
                // Display data
                displayGroups();
                updateDashboardStats();
                
                showAlert('Data loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Error loading data. Please try again.', 'danger');
                displayEmptyState();
            }
        }

        function resetStats() {
            document.getElementById('activeGroups').textContent = '0';
            document.getElementById('totalGroupSeats').textContent = '0';
            document.getElementById('soldSeats').textContent = '0';
            document.getElementById('availableSeats').textContent = '0';
        }

        async function loadGroups() {
            try {
                console.log('Loading groups from Supabase...');
                
                const { data, error } = await supabaseClient
                    .from('seat_acquisitions')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Supabase error loading groups:', error);
                    throw error;
                }
                
                groups = data || [];
                console.log('Groups loaded successfully:', groups.length);
                
            } catch (error) {
                console.error('Error loading groups:', error);
                groups = [];
                throw error;
            }
        }

        async function loadAgentSales() {
            try {
                console.log('Loading agent sales from Supabase...');
                
                const { data, error } = await supabaseClient
                    .from('agent_sales')
                    .select('*');
                
                if (error) {
                    if (error.code === 'PGRST204' || error.message.includes('does not exist')) {
                        console.log('agent_sales table not found or has issues');
                        agentSales = [];
                        return; // Don't throw error for missing table
                    }
                    console.error('Supabase error loading agent sales:', error);
                    throw error;
                }
                
                agentSales = data || [];
                console.log('Agent sales loaded successfully:', agentSales.length);
                
            } catch (error) {
                console.error('Error loading agent sales:', error);
                agentSales = [];
                // Don't throw error, continue with empty agent sales
            }
        }

        function displayGroups(filteredGroups = groups) {
            const grid = document.getElementById('groupsGrid');
            
            if (!filteredGroups || filteredGroups.length === 0) {
                grid.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="text-muted">
                            <i class="bi bi-inbox display-6"></i>
                            <p class="mt-3">No flight groups found</p>
                            <small>Create your first group from the Home page</small>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredGroups.forEach(group => {
                const airlineCode = group.airline || '';
                const logoUrl = airlineLogos[airlineCode] || defaultLogo;
                
                // Calculate sold seats for this group
                const groupSales = agentSales.filter(sale => sale.group_id === group.id);
                const soldSeats = groupSales.reduce((sum, sale) => sum + (parseInt(sale.seats_sold) || 0), 0);
                const availableSeats = Math.max(0, (group.no_of_seats || 0) - soldSeats);
                const progressPercent = group.no_of_seats ? (soldSeats / group.no_of_seats) * 100 : 0;
                
                // Determine status
                let status = 'active';
                let statusClass = 'bg-success';
                let statusText = 'Active';
                
                if (availableSeats === 0) {
                    status = 'completed';
                    statusClass = 'bg-secondary';
                    statusText = 'Completed';
                } else if (availableSeats < (group.no_of_seats || 0) * 0.5) {
                    status = 'filling';
                    statusClass = 'bg-warning';
                    statusText = 'Filling';
                }

                html += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card group-card h-100">
                            <div class="card-header ${statusClass} text-white d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">${airlineCode} - ${group.sector || 'N/A'}</h5>
                                    <small>${group.segment || 'General'}</small>
                                </div>
                                <span class="badge bg-light text-dark">${statusText}</span>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center mb-3">
                                    <div class="col-4 text-center">
                                        <img src="${logoUrl}" alt="${airlineCode}" class="airline-logo" 
                                             onclick="viewGroupDetails('${group.id}')" style="cursor:pointer;">
                                    </div>
                                    <div class="col-8">
                                        <h6 class="mb-1"><strong>SR:</strong> ${group.sr_number || 'N/A'}</h6>
                                        <h6 class="mb-1"><strong>PNR:</strong> ${group.airline_pnr || 'N/A'}</h6>
                                        <h6 class="mb-1"><strong>Date:</strong> ${group.outbound_date || 'N/A'}</h6>
					<h6 class="mb-1"><strong>Inbound:</strong> ${group.inbound_flight || 'N/A'}</h6>
                                    </div>
                                </div>
                                <!-- Flight Times -->
                <div class="flight-times mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-airplane-fill text-primary me-2"></i>
                        <small class="text-muted">${group.outbound_times || 'N/A'}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-airplane text-success me-2"></i>
                        <small class="text-muted">${group.inbound_times || 'N/A'}</small>
                    </div>
                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Seats Progress</span>
                                        <span>${soldSeats}/${group.no_of_seats || 0}</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" style="width: ${progressPercent}%"></div>
                                    </div>
                                </div>
                                
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <small class="text-muted d-block">Total</small>
                                            <strong>${group.no_of_seats || 0}</strong>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <small class="text-muted d-block">Sold</small>
                                            <strong class="text-success">${soldSeats}</strong>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <small class="text-muted d-block">Available</small>
                                            <strong class="text-warning">${availableSeats}</strong>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <small class="text-muted d-block mb-1">
                                        <i class="bi bi-calendar me-1"></i>Outbound: ${group.outbound_date || 'N/A'}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="bi bi-calendar-check me-1"></i>Inbound: ${group.inbound_date || 'N/A'}
                                    </small>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent border-top">
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewGroupDetails('${group.id}')">
                                        <i class="bi bi-eye me-1"></i>View Details
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="sellSeats('${group.id}')" ${availableSeats === 0 ? 'disabled' : ''}>
                                        <i class="bi bi-cart-plus me-1"></i>Sell Seats
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        function filterGroups() {
            const searchTerm = document.getElementById('searchGroups').value.toLowerCase();
            const airlineFilter = document.getElementById('filterAirline').value;
            const statusFilter = document.getElementById('filterStatus').value;
            
            console.log('Filtering groups:', { searchTerm, airlineFilter, statusFilter });
            
            let filtered = groups;
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(group => {
                    return (
                        (group.sr_number && group.sr_number.toLowerCase().includes(searchTerm)) ||
                        (group.airline_pnr && group.airline_pnr.toLowerCase().includes(searchTerm)) ||
                        (group.airline && group.airline.toLowerCase().includes(searchTerm)) ||
                        (group.sector && group.sector.toLowerCase().includes(searchTerm)) ||
                        (group.segment && group.segment.toLowerCase().includes(searchTerm))
                    );
                });
            }
            
            // Apply airline filter
            if (airlineFilter) {
                filtered = filtered.filter(group => group.airline === airlineFilter);
            }
            
            // Apply status filter
            if (statusFilter) {
                filtered = filtered.filter(group => {
                    const groupSales = agentSales.filter(sale => sale.group_id === group.id);
                    const soldSeats = groupSales.reduce((sum, sale) => sum + (parseInt(sale.seats_sold) || 0), 0);
                    const availableSeats = Math.max(0, (group.no_of_seats || 0) - soldSeats);
                    
                    if (statusFilter === 'completed') {
                        return availableSeats === 0;
                    } else if (statusFilter === 'active') {
                        return availableSeats > 0;
                    } else if (statusFilter === 'pending') {
                        return soldSeats === 0;
                    }
                    return true;
                });
            }
            
            console.log('Filtered results:', filtered.length);
            displayGroups(filtered);
        }

        function updateDashboardStats() {
            console.log('Updating dashboard stats...');
            
            if (!groups || groups.length === 0) {
                resetStats();
                return;
            }
            
            // Calculate stats
            const activeGroups = groups.length;
            const totalSeats = groups.reduce((sum, group) => sum + (parseInt(group.no_of_seats) || 0), 0);
            
            // Calculate sold seats across all groups
            let totalSoldSeats = 0;
            groups.forEach(group => {
                const groupSales = agentSales.filter(sale => sale.group_id === group.id);
                const soldSeats = groupSales.reduce((sum, sale) => sum + (parseInt(sale.seats_sold) || 0), 0);
                totalSoldSeats += soldSeats;
            });
            
            const availableSeats = Math.max(0, totalSeats - totalSoldSeats);
            
            console.log('Stats calculated:', {
                activeGroups,
                totalSeats,
                totalSoldSeats,
                availableSeats
            });
            
            // Update DOM
            document.getElementById('activeGroups').textContent = activeGroups;
            document.getElementById('totalGroupSeats').textContent = totalSeats;
            document.getElementById('soldSeats').textContent = totalSoldSeats;
            document.getElementById('availableSeats').textContent = availableSeats;
        }

        function refreshGroups() {
            console.log('Refreshing data...');
            
            // Show loading on refresh button
            const refreshBtn = document.getElementById('refreshButton');
            const originalHtml = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Refreshing...';
            refreshBtn.disabled = true;
            
            // Load data
            loadAllData().finally(() => {
                // Restore button
                refreshBtn.innerHTML = originalHtml;
                refreshBtn.disabled = false;
            });
        }

        function viewGroupDetails(groupId) {
            if (!groupId) {
                showAlert('No group selected', 'warning');
                return;
            }
            localStorage.setItem('currentGroupId', groupId);
            window.location.href = 'group-details.html';
        }

        function sellSeats(groupId) {
            if (!groupId) {
                showAlert('No group selected', 'warning');
                return;
            }
            localStorage.setItem('sellGroupId', groupId);
            window.location.href = 'sell-seats.html';
        }

        function showAlert(message, type = 'info') {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert-fixed');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-fixed alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function displayEmptyState() {
            document.getElementById('groupsGrid').innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="text-muted">
                        <i class="bi bi-exclamation-triangle display-6"></i>
                        <p class="mt-3">Unable to load data</p>
                        <small>Please check your connection and try again</small>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="refreshGroups()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Try Again
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Make functions available globally
        window.viewGroupDetails = viewGroupDetails;
        window.sellSeats = sellSeats;
        window.refreshGroups = refreshGroups;

	// Add to your groups.html JavaScript
function formatDateForDisplay(dateStr) {
    if (!dateStr) return 'N/A';
    
    // If already in correct format (01-MAR-26), return as is
    if (/^\d{2}-[A-Z]{3}-\d{2}$/.test(dateStr.toUpperCase())) {
        return dateStr.toUpperCase();
    }
    
    // Try to parse date string
    try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        
        const day = String(date.getDate()).padStart(2, '0');
        const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                           'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        const month = monthNames[date.getMonth()];
        const year = String(date.getFullYear()).slice(-2);
        
        return `${day}-${month}-${year}`;
    } catch (error) {
        return dateStr;
    }
}

// Then in displayGroups, use:
const formattedOutboundDate = formatDateForDisplay(group.outbound_date);
const formattedInboundDate = formatDateForDisplay(group.inbound_date);
    </script>
</body>
</html>
