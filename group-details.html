<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QFC Group - Group Details</title>
    <link rel="icon" type="image/png" href="QFClogo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar-brand { font-weight: bold; color: #1a365d !important; }
        .card { border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 24px; border: none; }
        .airline-logo-large { width: 120px; height: 120px; object-fit: contain; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .info-badge { font-size: 0.9rem; padding: 5px 12px; border-radius: 20px; }
        .seat-card { border-left: 4px solid #1a365d; transition: transform 0.2s; }
        .seat-card:hover { transform: translateY(-3px); }
        .table th { background-color: #f8f9fa; }
        .progress { height: 15px; }
        .btn-sell { background: linear-gradient(135deg, #1a365d, #2d4a8c); color: white; }
        .alert-fixed {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        /* Flight Details Styles */
        .flight-card {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        .flight-card:hover {
            transform: translateY(-2px);
        }
        .airport-code {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 12px;
            font-family: monospace;
            font-weight: 600;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <img src="QFClogo.png" alt="QFC Logo" height="30" class="me-2">
            <div class="d-inline-block">
                <div class="qfc-brand">QFC Group Pvt Ltd</div>
                <div class="qfc-subtitle">Group Seat Platform</div>
            </div>
        </a>
        
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="bi bi-house-door me-1"></i>Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="groups.html">
                        <i class="bi bi-people me-1"></i>All Groups
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">
                        <i class="bi bi-info-circle me-1"></i>Group Details
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="sell-seats.html">
                        <i class="bi bi-cart-plus me-1"></i>Sell Seats
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-8">
                <a href="groups.html" class="btn btn-outline-secondary mb-3">
                    <i class="bi bi-arrow-left me-2"></i>Back to Groups
                </a>
                <h2 class="fw-bold text-dark" id="groupTitle">Loading Group Details...</h2>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-sell btn-lg" onclick="openSellForm()">
                    <i class="bi bi-cart-plus me-2"></i>Sell Seats
                </button>
            </div>
        </div>

        <!-- Flight Details Card -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-airplane me-2"></i>Flight Details</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Outbound Flight -->
                    <div class="col-md-6">
                        <div class="card border-primary flight-card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-airplane-fill text-primary me-2"></i>Outbound Flight</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Date:</strong></div>
                                    <div class="col-8" id="detailOutboundDate">Loading...</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Flight:</strong></div>
                                    <div class="col-8" id="detailOutboundFlight">Loading...</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Departure:</strong></div>
                                    <div class="col-8">
                                        <span class="airport-code" id="detailOutboundDept">-</span>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Arrival:</strong></div>
                                    <div class="col-8">
                                        <span class="airport-code" id="detailOutboundArr">-</span>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-4"><strong>Times:</strong></div>
                                    <div class="col-8">
                                        <span id="detailOutboundDeptTime">-</span> → 
                                        <span id="detailOutboundArrTime">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Inbound Flight -->
                    <div class="col-md-6">
                        <div class="card border-success flight-card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-airplane text-success me-2"></i>Inbound Flight</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Date:</strong></div>
                                    <div class="col-8" id="detailInboundDate">Loading...</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Flight:</strong></div>
                                    <div class="col-8" id="detailInboundFlight">Loading...</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Departure:</strong></div>
                                    <div class="col-8">
                                        <span class="airport-code" id="detailInboundDept">-</span>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Arrival:</strong></div>
                                    <div class="col-8">
                                        <span class="airport-code" id="detailInboundArr">-</span>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-4"><strong>Times:</strong></div>
                                    <div class="col-8">
                                        <span id="detailInboundDeptTime">-</span> → 
                                        <span id="detailInboundArrTime">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Time Summary -->
                <div class="alert alert-info mt-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-clock-history me-3 fs-4"></i>
                        <div>
                            <h6 class="mb-1">Flight Schedule Summary</h6>
                            <div id="flightSummary" class="small">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Group Information Card -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-airplane me-2"></i>Flight Information</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <img src="" alt="Airline Logo" class="airline-logo-large mb-3" id="airlineLogo">
                        <h5 id="airlineName"></h5>
                    </div>
                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <th width="40%">SR Number:</th>
                                        <td id="srNumber">-</td>
                                    </tr>
                                    <tr>
                                        <th>Airline PNR:</th>
                                        <td id="airlinePnr">-</td>
                                    </tr>
                                    <tr>
                                        <th>GDS PNR:</th>
                                        <td id="gdsPnr">-</td>
                                    </tr>
                                    <tr>
                                        <th>Segment:</th>
                                        <td><span class="info-badge bg-info" id="segment">-</span></td>
                                    </tr>
                                    <tr>
                                        <th>Sector:</th>
                                        <td id="sector">-</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <th width="40%">Outbound Date:</th>
                                        <td id="outboundDate">-</td>
                                    </tr>
                                    <tr>
                                        <th>Inbound Date:</th>
                                        <td id="inboundDate">-</td>
                                    </tr>
                                    <tr>
                                        <th>Time Limit:</th>
                                        <td id="timeLimit">-</td>
                                    </tr>
                                    <tr>
                                        <th>Status:</th>
                                        <td><span class="info-badge bg-success" id="status">-</span></td>
                                    </tr>
                                    <tr>
                                        <th>Created Date:</th>
                                        <td id="createdDate">-</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Information Card -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="bi bi-cash-stack me-2"></i>Financial Information</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">Total Seats</h6>
                            <h2 id="totalSeats">0</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">Fare per Seat</h6>
                            <h2 id="farePerSeat">0.00</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">Taxes per Seat</h6>
                            <h2 id="taxesPerSeat">0.00</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">PNR Amount</h6>
                            <h2 id="pnrAmount">0.00</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seat Allocation Progress -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Seat Allocation Progress</h4>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Seats Sold: <strong id="soldSeatsCount">0</strong></span>
                            <span>Available: <strong id="availableSeatsCount">0</strong></span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <h5>Remaining Seats: <span class="text-danger" id="remainingSeats">0</span></h5>
                        <p class="text-muted" id="progressText">0% of seats sold</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Sales Table -->
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>Agent Sales</h4>
                <span class="badge bg-light text-dark" id="agentCount">0 Agents</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Agent Name</th>
                                <th>License No.</th>
                                <th>Contact</th>
                                <th>Seats Sold</th>
                                <th>Sale Amount</th>
                                <th>Commission %</th>
                                <th>Status</th>
                                <th>Sale Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentSalesTable">
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="bi bi-people display-6"></i>
                                        <p class="mt-2">No seats sold to agents yet</p>
                                        <button class="btn btn-sm btn-primary mt-2" onclick="openSellForm()">
                                            <i class="bi bi-cart-plus me-1"></i>Sell First Seat
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://ojlxkzkialguthdeiley.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qbHhremtpYWxndXRoZGVpbGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTE0MjQsImV4cCI6MjA4NTMyNzQyNH0.CYH4hRn4w87vvvskkHOQMyKONyDWnvF7_m5IOfgPR94';
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        let currentGroup = null;
        let agentSales = [];
        const groupId = localStorage.getItem('currentGroupId');

        // Airline logos mapping
        const airlineLogos = {
            'SV': 'SVlogo.png',
            'PA': 'PAlogo.png',
            'PK': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9f/PIA_logo_%282020%29.svg/2560px-PIA_logo_%282020%29.svg.png',
            'EK': 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/Emirates_logo.svg/2560px-Emirates_logo.svg.png',
            'F3': 'https://upload.wikimedia.org/wikipedia/en/thumb/6/6c/Flyadeal_logo.svg/2560px-Flyadeal_logo.svg.png',
            'PF': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Palestine_Airlines_Logo.svg/2560px-Palestine_Airlines_Logo.svg.png',
            '9P': 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/PIA_logo_%282020%29.svg/2560px-PIA_logo_%282020%29.svg.png',
            'J9': 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/Jazeera_Airways_logo.svg/2560px-Jazeera_Airways_logo.svg.png'
        };

        // Airline names mapping
        const airlineNames = {
            'SV': 'Saudi Airlines',
            'PK': 'Pakistan International Airlines',
            'EK': 'Emirates',
            'F3': 'Flyadeal',
            'PA': 'Airblue',
            'PF': 'Palestine Airlines',
            '9P': 'Pakistan Airlines',
            'J9': 'Jazeera Airways'
        };

        document.addEventListener('DOMContentLoaded', async function() {
            if (!groupId) {
                showAlert('No group selected. Redirecting to groups page.', 'warning');
                setTimeout(() => window.location.href = 'groups.html', 2000);
                return;
            }
            
            try {
                await loadGroupDetails();
                await loadAgentSales();
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Error loading group details', 'danger');
            }
        });

        async function loadGroupDetails() {
            try {
                const { data, error } = await supabaseClient
                    .from('seat_acquisitions')
                    .select('*')
                    .eq('id', groupId)
                    .single();
                
                if (error) throw error;
                
                currentGroup = data;
                displayGroupDetails();
                displayFlightDetails(currentGroup);
                
            } catch (error) {
                console.error('Error loading group details:', error);
                showAlert('Failed to load group details', 'danger');
                setTimeout(() => window.location.href = 'groups.html', 2000);
            }
        }

        async function loadAgentSales() {
            try {
                const { data, error } = await supabaseClient
                    .from('agent_sales')
                    .select('*')
                    .eq('group_id', groupId)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    if (error.code === 'PGRST204' || error.message.includes('does not exist')) {
                        console.log('agent_sales table not found or has issues');
                        agentSales = [];
                        showAlert('Agent sales table not configured properly', 'warning');
                        return;
                    }
                    throw error;
                }
                
                agentSales = data || [];
                displayAgentSales();
                updateSeatProgress();
                
            } catch (error) {
                console.error('Error loading agent sales:', error);
                agentSales = [];
                showAlert('Error loading agent sales', 'warning');
            }
        }

        function displayGroupDetails() {
            if (!currentGroup) return;
            
            const airlineCode = currentGroup.airline || '';
            const logoUrl = airlineLogos[airlineCode] || 'https://cdn-icons-png.flaticon.com/512/824/824239.png';
            const airlineName = airlineNames[airlineCode] || airlineCode;
            
            // Update page title
            document.getElementById('groupTitle').textContent = `${airlineName} - ${currentGroup.sector || 'Flight Group'}`;
            
            // Update airline logo and name
            document.getElementById('airlineLogo').src = logoUrl;
            document.getElementById('airlineName').textContent = airlineName;
            
            // Update basic information
            document.getElementById('srNumber').textContent = currentGroup.sr_number || '-';
            document.getElementById('airlinePnr').textContent = currentGroup.airline_pnr || '-';
            document.getElementById('gdsPnr').textContent = currentGroup.gds_pnr || '-';
            document.getElementById('segment').textContent = currentGroup.segment || '-';
            document.getElementById('sector').textContent = currentGroup.sector || '-';
            document.getElementById('outboundDate').textContent = formatDateForDisplay(currentGroup.outbound_date) || '-';
            document.getElementById('inboundDate').textContent = formatDateForDisplay(currentGroup.inbound_date) || '-';
            document.getElementById('timeLimit').textContent = currentGroup.time_limit || '-';
            document.getElementById('status').textContent = currentGroup.status || 'draft';
            document.getElementById('createdDate').textContent = currentGroup.created_at ? new Date(currentGroup.created_at).toLocaleDateString() : '-';
            
            // Update financial information
            document.getElementById('totalSeats').textContent = currentGroup.no_of_seats || 0;
            document.getElementById('farePerSeat').textContent = (currentGroup.fare || 0).toFixed(2);
            document.getElementById('taxesPerSeat').textContent = (currentGroup.taxes || 0).toFixed(2);
            document.getElementById('pnrAmount').textContent = (currentGroup.pnr_amount || 0).toFixed(2);
        }

        // Function to parse time string like "ISB 0700 JED 1100"
        function parseFlightTime(timeString) {
            if (!timeString) return { departure: {}, arrival: {} };
            
            const parts = timeString.trim().split(/\s+/);
            if (parts.length !== 4) return { departure: {}, arrival: {} };
            
            return {
                departure: {
                    airport: parts[0],
                    time: parts[1]
                },
                arrival: {
                    airport: parts[2],
                    time: parts[3]
                }
            };
        }

        // Function to format time from "0700" to "07:00"
        function formatTime(timeStr) {
            if (!timeStr || timeStr.length !== 4) return timeStr;
            return timeStr.substring(0, 2) + ':' + timeStr.substring(2);
        }

        // Function to display flight details
        function displayFlightDetails(group) {
            if (!group) return;
            
            // Format dates
            document.getElementById('detailOutboundDate').textContent = 
                formatDateForDisplay(group.outbound_date) || 'N/A';
            document.getElementById('detailInboundDate').textContent = 
                formatDateForDisplay(group.inbound_date) || 'N/A';
            
            // Display flight numbers
            document.getElementById('detailOutboundFlight').textContent = 
                group.outbound_flight || 'N/A';
            document.getElementById('detailInboundFlight').textContent = 
                group.inbound_flight || 'N/A';
            
            // Parse and display outbound times
            const outboundTimes = parseFlightTime(group.outbound_times);
            if (outboundTimes.departure.airport) {
                document.getElementById('detailOutboundDept').textContent = 
                    outboundTimes.departure.airport;
                document.getElementById('detailOutboundArr').textContent = 
                    outboundTimes.arrival.airport;
                document.getElementById('detailOutboundDeptTime').textContent = 
                    formatTime(outboundTimes.departure.time);
                document.getElementById('detailOutboundArrTime').textContent = 
                    formatTime(outboundTimes.arrival.time);
            }
            
            // Parse and display inbound times
            const inboundTimes = parseFlightTime(group.inbound_times);
            if (inboundTimes.departure.airport) {
                document.getElementById('detailInboundDept').textContent = 
                    inboundTimes.departure.airport;
                document.getElementById('detailInboundArr').textContent = 
                    inboundTimes.arrival.airport;
                document.getElementById('detailInboundDeptTime').textContent = 
                    formatTime(inboundTimes.departure.time);
                document.getElementById('detailInboundArrTime').textContent = 
                    formatTime(inboundTimes.arrival.time);
            }
            
            // Create flight summary
            updateFlightSummary(group);
        }

        // Function to create flight summary
        function updateFlightSummary(group) {
            const summaryDiv = document.getElementById('flightSummary');
            if (!summaryDiv) return;
            
            let summaryHTML = '';
            
            if (group.outbound_flight || group.outbound_times) {
                summaryHTML += `
                    <div class="mb-2">
                        <i class="bi bi-arrow-right-circle text-primary me-2"></i>
                        <strong>Outbound:</strong> ${group.outbound_flight || ''} 
                        on ${formatDateForDisplay(group.outbound_date) || ''}
                    </div>
                `;
            }
            
            if (group.inbound_flight || group.inbound_times) {
                summaryHTML += `
                    <div>
                        <i class="bi bi-arrow-left-circle text-success me-2"></i>
                        <strong>Inbound:</strong> ${group.inbound_flight || ''} 
                        on ${formatDateForDisplay(group.inbound_date) || ''}
                    </div>
                `;
            }
            
            if (!summaryHTML) {
                summaryHTML = '<span class="text-muted">No flight details available</span>';
            }
            
            summaryDiv.innerHTML = summaryHTML;
        }

        // Date formatting function
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '';
            
            // If already in correct format (01-MAR-26), return as is
            if (/^\d{2}-[A-Z]{3}-\d{2}$/.test(dateStr.toUpperCase())) {
                return dateStr.toUpperCase();
            }
            
            // Try to parse date string
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                
                const day = String(date.getDate()).padStart(2, '0');
                const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                                   'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                const month = monthNames[date.getMonth()];
                const year = String(date.getFullYear()).slice(-2);
                
                return `${day}-${month}-${year}`;
            } catch (error) {
                return dateStr;
            }
        }

        function displayAgentSales() {
            const tableBody = document.getElementById('agentSalesTable');
            const agentCount = document.getElementById('agentCount');
            
            if (!agentSales || agentSales.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <div class="text-muted">
                                <i class="bi bi-people display-6"></i>
                                <p class="mt-2">No seats sold to agents yet</p>
                                <button class="btn btn-sm btn-primary mt-2" onclick="openSellForm()">
                                    <i class="bi bi-cart-plus me-1"></i>Sell First Seat
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                agentCount.textContent = '0 Agents';
                return;
            }
            
            let html = '';
            let totalSold = 0;
            
            agentSales.forEach(sale => {
                totalSold += parseInt(sale.seats_sold) || 0;
                
                // Calculate sale amount
                const saleAmount = (sale.sale_price || 0) * (sale.seats_sold || 0);
                const commissionAmount = saleAmount * ((sale.commission_percentage || 0) / 100);
                const netAmount = saleAmount - commissionAmount;
                
                html += `
                    <tr class="seat-card">
                        <td>
                            <strong>${sale.agent_name || 'Unknown Agent'}</strong>
                            <br><small class="text-muted">${sale.agent_company || ''}</small>
                        </td>
                        <td>${sale.license_number || '-'}</td>
                        <td>
                            <small class="d-block">${sale.agent_phone || '-'}</small>
                            <small class="text-muted">${sale.agent_email || ''}</small>
                        </td>
                        <td>
                            <span class="badge bg-primary">${sale.seats_sold || 0}</span>
                        </td>
                        <td>
                            <strong>${saleAmount.toFixed(2)}</strong>
                            <br><small class="text-muted">Net: ${netAmount.toFixed(2)}</small>
                        </td>
                        <td>
                            <span class="badge bg-info">${sale.commission_percentage || 0}%</span>
                            <br><small class="text-muted">${commissionAmount.toFixed(2)}</small>
                        </td>
                        <td>
                            <span class="badge ${sale.payment_status === 'paid' ? 'bg-success' : 'bg-warning'}">
                                ${sale.payment_status || 'pending'}
                            </span>
                        </td>
                        <td>${sale.sale_date ? new Date(sale.sale_date).toLocaleDateString() : '-'}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editSale('${sale.id}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteSale('${sale.id}', '${sale.agent_name}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            agentCount.textContent = `${agentSales.length} Agent${agentSales.length !== 1 ? 's' : ''}`;
        }

        function updateSeatProgress() {
            if (!currentGroup) return;
            
            const totalSeats = currentGroup.no_of_seats || 0;
            const soldSeats = agentSales.reduce((sum, sale) => sum + (parseInt(sale.seats_sold) || 0), 0);
            const availableSeats = Math.max(0, totalSeats - soldSeats);
            const progressPercent = totalSeats > 0 ? (soldSeats / totalSeats) * 100 : 0;
            
            document.getElementById('soldSeatsCount').textContent = soldSeats;
            document.getElementById('availableSeatsCount').textContent = availableSeats;
            document.getElementById('remainingSeats').textContent = availableSeats;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${progressPercent.toFixed(1)}% of seats sold (${soldSeats}/${totalSeats})`;
            
            // Update button state if no seats available
            const sellButton = document.querySelector('.btn-sell');
            if (sellButton && availableSeats === 0) {
                sellButton.disabled = true;
                sellButton.innerHTML = '<i class="bi bi-cart-x me-2"></i>Sold Out';
                sellButton.className = 'btn btn-secondary btn-lg';
            }
        }

        function openSellForm() {
            if (!currentGroup) return;
            
            const availableSeats = Math.max(0, (currentGroup.no_of_seats || 0) - 
                agentSales.reduce((sum, sale) => sum + (parseInt(sale.seats_sold) || 0), 0));
            
            if (availableSeats === 0) {
                showAlert('No seats available for sale.', 'warning');
                return;
            }
            
            localStorage.setItem('sellGroupId', currentGroup.id);
            localStorage.setItem('availableSeats', availableSeats);
            window.location.href = 'sell-seats.html';
        }

        function editSale(saleId) {
            const sale = agentSales.find(s => s.id === saleId);
            if (sale) {
                localStorage.setItem('editSaleId', saleId);
                openSellForm();
            }
        }

        async function deleteSale(saleId, agentName) {
            if (!confirm(`Delete sale to ${agentName}? This action cannot be undone.`)) return;
            
            try {
                const { error } = await supabaseClient
                    .from('agent_sales')
                    .delete()
                    .eq('id', saleId);
                
                if (error) throw error;
                
                // Remove from local array
                agentSales = agentSales.filter(sale => sale.id !== saleId);
                
                // Update display
                displayAgentSales();
                updateSeatProgress();
                
                showAlert('Sale deleted successfully.', 'success');
                
            } catch (error) {
                console.error('Error deleting sale:', error);
                showAlert('Failed to delete sale.', 'danger');
            }
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-fixed alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Make functions available globally
        window.openSellForm = openSellForm;
        window.editSale = editSale;
        window.deleteSale = deleteSale;
    </script>
</body>
</html>

